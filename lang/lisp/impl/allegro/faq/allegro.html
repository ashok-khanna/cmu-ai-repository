	Allegro CL (Unix) Frequently Asked Questions (FAQ) with Answers

Last-modified: $Date: 1995/10/03 17:12:16 $
Version: $Revision: 1.71 $
Location: ftp.uu.net:~ftp/vendor/franz/faq

  This is a list of frequently asked questions on Allegro Common Lisp
  (ACL) for Unix machines (ACL\Windows issues are currently dealt with
  in the file aclwin-faq (found in this directory) and through the
  Franz Forum, details of which are available with the ACL\Windows
  package).  Please read this document before sending mail to
  bugs@franz.com or allegro-cl@cs.berkeley.edu.  We (Franz Inc.) will
  mail the list (with periodic updates) approximately monthly to
  allegro-cl@cs.berkeley.edu.  Periodically, also, items from this
  list will be incorporated into our documentation (and dropped from
  here).

  Your comments, additions and fixes to this list are welcome: please
  send them to bugs@franz.com.


Subject: Table of Contents
From: Preface

Legend: + new, - deleted, ! changed

1. Administrative Issues:
------------------------
  1.1.  ACL current version info
	* What is the current version of ACL?
  1.2.  ACL-related communication
	* How should I report bugs?
	* In ACL 4.2beta, dribble-bug runs into the following error:
	  Error: Can't coerce :*PATCHES* to type SIMPLE-STRING.
	* dribble-bug output seems to lags behind Lisp I/O.
	* Sometimes CL output is not logged in the dribble-bug file.
	  What do I do about this?
	* Is there a mailing list for Allegro CL?  How do I sign up?
  1.3.  Patches
	* Is there a public patch directory you maintain for incremental
	  patches to the ACL image? If so, how do I get to it?
	* What is the ftp.uu.net, or what is the internet number so I
	  can get to all of your patches?
  1.4.  ACL Documentation
	* What is the relationship between this FAQ and ACL
	  documentation?
	* Is the ACL documentation available on-line?
  1.5.  Installation
	* What do I do about installing ACL 4.x over a network, when rcp
	  fails with permission problems?
	* Allegro CL seems to fail with our automounter.  What do we do?
	* How do I get around Lisp startup problems to do with NIH?
	* What do I do about the following error installing ACL4.2/CLIM2.0:
		ld: /x11/R4/sun4-lib/libX11.a: No such file or directory
	* What to do about "Error: The operating system will not
	  permit common lisp to read its own image"?
	* How do I select values for pre-malloc-ation?
	* How do I specify premallocs arguments to build/install_lisp?
	* When I execute a standalone image, I get the message:
		Warning! Can't find lisp library /vol/allegro/lib/.
	* I also run Netscape on my machine, but when I do CLIM (or Composer or
	  Emacs) can't run properly because the colormap is completely used.

2. Architecture-specific problems:
---------------------------------
  2.1. SPARC
	* We're having problems getting CL up on a SS10 running SunOS
	  4.1.3.
	* What do I do for the sparc2/sparc10 incompatibility for Allegro
	  Runtime?
	* Even with the patch for the SS10, things don't work.  I'm
	  using CLIM.  Is this the culprit?
	* Are there other circumstances under which I would get the
	  too-much-stack error?
	* When I use Allegro CL on a SPARCstation2 the machine crashes
	  sometimes and I get the following message:
		   Watchdog reset
		   Window Underflow
		   Type help for more information
	* What do I do about using hardware multiply/divide
	  instructions on advanced Sparc chip architectures?  How do I
	  know if I have an architecture that qualifies as "advanced"?
	* Does ACL 4.1 run on a Sparc-5?
	* How do I build ACL4.2 under Solaris2.4?
  2.2. SGI
	* Does ACL 4.1.mbeta work with MIPS R4000 chips?
	* When I try to execute the tar command, I get a premature EOF error.
	* During installation I get the following error message.  What do I
	  do?
		| ;   Fast loading from bundle code/foreign.fasl.
		| ;     Foreign loading /tmp/Las14174.o.
		| Error (from debug): Foreign load failed
	* What is the sgi-ld-patch?
	* I ran into the following error message.  What do I do?
		| ;   Fast loading from bundle code/foreign.fasl.
		| ;     Foreign loading /tmp/Las3416.o.
		| /usr/bin/ld:
		| Can't locate file for: -lc_G0
	* My IRIX4.0.5F system doesn't have a G0 version of libsun.a.
	  What do I do about foreign function calls to this library?
	* I get an error claiming a library has no table of contents.
	  What should I do?
	* What do I do about the following SGI installation message?
	| libmld--as0: Error: /tmp/Las2817.s, line 5795: cannot write pfield
	| Error (from ERROR): Could not assemble the trampoline symbols file
	* On the SGI, while loading foreign code, I get the following message:

	Warning: jump relocation out-of-range, bad object file produced, can't
	jump from 0x100f62e0 to 0x40f840 (symbol name: abort) (call to"abort"
	resolved to a name in a different 256 megabyte memory area: the -y
	option to ld (example: -yabort ) will show the reference and
	definition locations)
	* What do I do about the following error obtained while
	building 4.2.malpha on Irix 5.2?
	>>     Unresolved:
	>>     sqrt
	>>     copysign
	>>     *** Error code 1 (bu21)
  2.3. NeXT
	* Does ACL on the NeXT work with the ObjectiveC interface?
	* We have just installed NeXTStep 3.0, and I tried out our old
	   version of Allegro CL 3.1 with the following results:
	   > cl
	   Minor versions don't match in "/usr/shlib/libNeXT_s.C.shlib".
	   This image cannot be executed.

	   Can we just rebuild CL 3.1 or will that software not work with
	   NeXTStep 3.0?
  2.4. IBM RS6000
	* With automount, what do I do about the following error?

	  Allegro CL 4.1 [IBM RS/6000; R1] (4/7/93 11:35)
	  Copyright (C) 1985-1992, Franz Inc., Berkeley, CA, USA.  All Rights Reserved.
	  Error: There is no file named "/auto50NhfKcS/general/xx/"
	    [condition type: FILE-ERROR]
	  [1] USER(1):
  2.5. HP
	* On the HP, why does it take so long to link each foreign library?
	* I tried to install Allegro CL 4.2 on the HP station, it died with
		"/bin/ld: Can't find library for -lPW".
	* Build error on HPUX 9.05/8xx series: unsatisfied symbols (copysign,
	  logb, drem, finite) -- what do I do?
	* What do I need to do to build on HP-9000/8xx series machines?


3. Using Allegro CL:
-------------------
  3.1. Base Lisp
	* Does ACL 4.1 accept optional args to LAST and BUTLAST?
	* The doc string in DEFMACRO forms does not seem to be available via
	   the emacs-lisp interface.  It would sure be nice if that was
	   available, like fi:lisp-function-documentation or
	   fi:describe-symbol.
	* I get "NIL is not an arg-info." whenever I try to write structures
	   to a file using excl:fasl-write; or the file compiler
	   signalled an error about a method on MAKE-LOAD-FORM that I don't
	   understand.
	* The file compiler (or excl:fasl-write) signalled an error about a
	   method on MAKE-LOAD-FORM that I don't understand.
	* I need a function that will tell me the name of a function object
	   that I have been given.
	* While using logical pathnames, I ran into a reference to
	  sys:hosts.cl.  What does this mean?
	* It appears that if a logical pathname contains an underscore, it
	  is not translated correctly.
	* How do I determine the directory where the lisp image that is
	  curently running is located?
	* I'm left with running Lisp processes after I exit my
	  Emacs/xterm. What do I do?
	* ":i ?" doesn't work.  What are the inspector commands?
  3.2. Garbage collector
	* When I run my application, some problems on heap space result.  The
	   error I get is:

	   Error: An explicit gc call caused tenuring and a need for 22544384
	          more bytes of heap.
	   This would exceed the image size limit set at initial build.
	     [condition type: storage-condition]
	* I'd like to give my users an indication that gc is in progress, so
	  that they will be patient. I have a function that will produce the
	  desired indication with minimal consing.  Any ideas on how
	  to do this?
	* How do I get rid of malloc gaps in my Lisp heap space?
  3.3. Foreign functions
	* Does all multiprocessing activity halt when (and while) waiting for
	  foreign functions to complete?
	* How do I pass a C string back to Lisp?
	* Does ACL support Lisp-C interaction through RPC?
	* In ACL 4.2 can we call C++ functions as well as C functions?
	* How do I build a shared C/C++object file for loading in Solaris 2.x
	* What do I do about multiply-defined problems with /lib/libc.a?
  3.4. Converting code from Franz Lisp to Allegro CL
	* What changes must I make to move from Franz Lisp to ACL?


4. Add-on products/features:
---------------------------
  4.1. Emacs-Lisp interface
	* I can't seem to type lines with more than 256 characters at Lisp
	  running within the Emacs interface.  Why not?
	* Why do I get the "A background eval/compile request is
	    pending, please wait..." message when doing an eval/compile in
	    a Lisp buffer?
	* How can I get the ACL 4.1 emacs-lisp interface to work with
	  epoch 4.0 and 4.1?
	* Is there a version of the Emacs-Lisp interface that works
	  with Emacs version 19?
	* From where can I get FSF Emacs and Xemacs?
	* How do I get the Emacs-Lisp Interface working with Xemacs 19.12?
  4.2. Lisp-Editor Protocol (LEP)
	* How can I edit an s-expression, possibly having lisp
	    wait for the editor to finish the edit session?
	* How can I open a stream to an emacs buffer?
	* How can another stream be used for background output
	    instead of creating the *background-interaction* buffer?
	* How can arbitrary elisp code be run from lisp?
	* Is the presentation system (mouse sensitive Allegro CL
	    objects in emacs buffers) extensible?
	* Is there a way to programmatically determine if the emacs-lisp
	    interface connect has been established?
	* How can I tell if lep had a problem?
	* Lemacs 19.10 and (setq fi::initialization-forms)
	* Lemacs (or ACL, or Composer, or my xterm) freezes when
          running some command that asks for a name in the minibuffer.
  4.3. CLIM
	* The CLIM 2.0 demos don't seem to work.  What should I do?
	* My ACL4.2.beta2.0 build on the HP fails if CLIM2.0beta is to be
	    included in the image.  If CLIM2.0beta is not included,
	    the build succeeds.  What do I do to build with CLIM?
	* Why do I get strange behavior when I try to run accepting-values
	  in a separate process?
	* How do I provide scrollable popup menus in Allegro CLIM 2.x?
	* Why do I need an XNLSPATH environment variable?
	* What should I do to avoid getting palette-full error messages?
	* Why can't get the :scroll-bar option to the list-pane gadget to work?
  4.4. Runtime
	* When I run ACL 4.2 without the development and without the compiler,
	  and with EXCL::*COMPILER-NOT-AVAILABLE-WARNING* = T,
	  I get warnings in two unexpected kinds of places, detailed below.
	  What is going to run slower, and how much slower?
	* I'm running into errors during CLOS training.  What do I do?
  4.5. SQL DB Interface
	* Is there an Allegro SQL interface for relational databases?
	  Where can I get it?
  4.6. Common Windows
	* When I call cw::initialize-common-windows with DISPLAY =
	  192.5.238.11:0, I get the error: Unknown host "192.5.238.11".



Section 1: ADMINISTRATIVE ISSUES
================================

1.1:  Version info for ACL
--------------------------

----------------------------------------------------------------------
Q) What is the current version of ACL?

A) The current version is ACL 4.2 for the Sparc (SunOS4.1.x/Solaris1.x
and SunOS5.x/Solaris2.x), the HP Prism, the SGI (Irix 5.x) and
IBM/RS6000, and 4.1 for the SGI (Irix 4.x).
----------------------------------------------------------------------


1.2: ACL-related communication
------------------------------

----------------------------------------------------------------------
Q) How should I report bugs?

A) Use dribble-bug, documented in Chapter 1 of the ACL User Guide.
----------------------------------------------------------------------

----------------------------------------------------------------------
Q) In ACL 4.2beta, dribble-bug runs into the following error:
	Error: Can't coerce :*PATCHES* to type SIMPLE-STRING.

A) A known bug.  To circumvent this, use patch0133, from ftp.uu.net.
This bug has been fixed in ACL4.2.  If ACL4.2 is available on the
machine you are using, please update to ACL4.2.
----------------------------------------------------------------------

----------------------------------------------------------------------
Q) dribble-bug output seems to lags behind Lisp I/O.

A) dribble-bug always catches up with the Lisp I/O (which is stored in
a buffer before it goes into the dribble file).  If you would like to
see output in the dribble file faster, you can try using the following
hack before calling dribble:

	(excl:advise dribble :around nil nil
		(let ((excl::stream-buffer-size 1)) :do-it))
----------------------------------------------------------------------

----------------------------------------------------------------------
Q) Sometimes CL output is not logged in the dribble-bug file.  What do
I do about this?

A) This should only occur when using the foreign-function interface.
Some messages from foreign code may be written directly to Unix stdout
or stderr, bypassing Lisp entirely.  To circumvent this problem, you
can either use an Emacs buffer or the Unix utility "script" to save
the entire transaction record.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Is there a mailing list for Allegro CL?  How do I sign up?

A) Yes, there is a mailing list for Allegro CL users.  It is accessed
through the address allegro-cl@cs.berkeley.edu.  To be added to or
deleted from this list, send mail to
allegro-cl-request@cs.berkeley.edu.  Franz periodically makes
announcements on this mailing list, but its main purpose is to allow
users of Allegro CL (both Unix and Windows) to communicate with each
other, sharing ideas, complaints and code.
----------------------------------------------------------------------


1.3: Patches
------------

----------------------------------------------------------------------
Q) Is there a public patch directory you maintain for incremental
patches to the ACL image? If so, how do I get to it?

A)
Franz Inc. Patches on UUNET

  The patches are all available on uunet:~ftp/vendor/franz/patches (==
uunet!~/vendor/franz/patches).  There is a README in the toplevel
directory which explains how to find and load the patches for your
version of Allegro CL.  As patches become available, the files in this
directory will be updated, so it is a good idea to periodically check
the particular subdirectories you may be interested in for changes.

  The following is an example of how to access the README file in the
patch directory:

% ftp ftp.uu.net
Name: ftp
Password: <your login name>
ftp> cd ~ftp/vendor/franz/patches
ftp> get README

Here is the internet address for the machine where the Allegro CL
patches are kept:

192.48.96.9	ftp.uu.net
----------------------------------------------------------------------

----------------------------------------------------------------------
Q) What is the ftp.uu.net, or what is the internet number so I can get
to all of your patches?

A) Here is the internet address for the machine where the Allegro CL
patches are kept:

192.48.96.9	ftp.uu.net

  If you do not have access to the internet, you may still be able to
get access to the directory via other methods.  If you are on the
BITNET/NetNorth/EARN system, the bitftp service may be helpful in
accessing ftp files.  Your system administrators may know of other ftp
servers as well.

  If you can't get access to uunet via ftp, and you do not have a
direct connection to uunet (ie, a uunet subscription), you can use
uunet's 900 service which will show up as a charge on your telephone
bill.  Here is some information about how to use the 900 service from
uunet:

How to reach UUNET's 900 number via uucp
========================================
Here are some sample a L.sys or Systems file lines suitable for UUNET's
900 number:

#
# Simple line.
uunet Any ACU 19200 1-900-468-7727 in:--in:--in: uucp
#
# Set up for a Telebit.
uunet Any cua0 19200 cua0 "" ATX0S50=255S111=30DT19004687727\r CONNECT "" login: uucp

Modify as appropriate for your site, of course, to deal with your local
telephone system and uucp version.

Note that these modems first answer with V.32, then at 2400, 1200, and
last with PEP tones.

This "900" number charges $.40US per minute to the caller.

All modems on the 900 lines are Telebit T2500s.
----------------------------------------------------------------------


1.4: ACL Documentation
----------------------

----------------------------------------------------------------------
Q) What is the relationship between this FAQ and ACL documentation?

A) The ACL documentation, comprising ACL User Guide, Installation and
Release notes, and this FAQ list are designed to be mutually
exclusive.  It is our intention to maintain this FAQ list as a
repository of current frequently-asked questions, which have arisen
since the last release of the ACL documentation (and are sometimes
pertinent only to a certain release of ACL).  Those questions which
endure across releases will be incorporated into the ACL documentation
in due course, and simultaneously removed from the FAQ list.
----------------------------------------------------------------------

----------------------------------------------------------------------
Q) Is the ACL documentation available on-line?

A) Currently, no.
----------------------------------------------------------------------


1.5: Installation
-----------------

---------------------------------------------------------------------
Q) What do I do about installing ACL 4.x over a network, when rcp
fails with permission problems?

A) As you determined, the problem installing Allegro CL 4.x on your
machine arises from our call to `rcp' since rcp does not seem to work
between the nodes of your network.  (This can presumably be hacked by
changing the rhosts table appropriately on the target machine but we
give the following fix instead.)

The call to rcp is for efficiency.  `mv' will work just as well but
it can significantly raise the load average on the machines involved
while the move is taking place.  It is our intention to fix this problem
in a later release.

The offending file is build/bin/mv-nfs.  Please move the original
mv-nfs to mv-nfs-orig and copy the indicated contents below a new
mv-nfs.

Try to rerun build/install_lisp with the changed bin/mv-nfs.  I
believe that things should work okay.  Call us if you have any
problems.

here is the new mv-nfs:

---------begin (don't put this line in the file)----------
#! /bin/sh -eu
# $aclHeader: mv-nfs,v 1.7 91/12/04 01:56:43 cox acl4_1 (modified in spr7675)$

copy=nil
pflag=

while test $# -gt 0; do
	case $1 in
	-c)	copy=t
		;;
	-p)	pflag=-p
		;;
	*)	break
		;;
	esac
	shift
done

nargs=$#

files=
while test $# -gt 1; do
	files="$files $1"
	shift
done

if test $# -gt ${nargs} -a ! -d $1; then
	echo "$0: last argument must be a directory for multi-file move: $1"
	exit 1
fi

if test ! -d $1; then
	destdir=`dirname $1`
	base=/`basename $1`
else
	destdir=$1
	base=
fi

if test -f bin/nfspwd; then
	nfspwd=`pwd`/bin/nfspwd
else
	nfspwd=nfspwd
fi

for file in $files; do
	if test "$copy" = "t"; then
		cmd="cp ${file} ${destdir}${base}"
	else
		cmd="mv ${file} ${destdir}${base}"
	fi
	echo $cmd
	$cmd
done


---------end (don't put this line in the file)----------
---------------------------------------------------------------------


---------------------------------------------------------------------
Q) Allegro CL seems to fail with our automounter.  What do we do?

A) Thanks for your report.  In some cases, Allegro strips the initial
"/tmp_mnt/" from pathnames.  The reason we translate pathnames at all
is that routines such as getwd() return pathnames on automounted
filesystems as beginning with "/tmp_mnt/".  Accessing files that have
such "/tmp_mnt/" pathnames can frequently fail since using "/tmp_mnt/"
bypasses the automounter and the remote filesystems may have timed out
in the meantime and become unmounted.

  It appears that Allegro's algorithm does not work at your site.  If
possible, we would like to see examples of how you start your
automounter (probably in your /etc/rc.local) and any mapping files it
uses.  This should help us figure out a way to improve our automounter
translation scheme.

  In the meantime, you can either disable the translation mechanism
completely, or figure out a "method" that translates pathnames in your
automounter environment.  These are described below:

Option 1 -- Disable the translation mechanism completely:

Put the following into your Allegro CL distribution build/custom.cl
file and rebuild lisp:

(setq sys::*source-file-frobbers* nil)


Option 2 -- Write a "method" that translates pathnames to your
automounter environment.  This can then be put into (or loaded by)
your Allegro CL distribution's build/custom.cl.  Following is the code
we use to do the "/tmp_mnt" strip.  You may be able to modify it to
handle your environment.  Note that all of these functions are
internal and may change in a future release.  We will be looking into
a better solution for this problem.

(in-package :system)

(defvar *source-file-frobbers* nil
  ;; A list of functions that are repeatable invoked to modify the source
  ;; file when we attempt to use it.  Frobbers are called repeatable until
  ;; they all return NIL or the pathname unaltered
  )

(defun tmp-mnt-frobber (pathname)
  ;; This code removes the /tmp_mnt/ stuff from the beginning of the
  ;; pathname
  (translate-pathname-prefix pathname '(:absolute "tmp_mnt") '(:absolute)))

(defun translate-pathname-prefix (pathname old new)
  (and (pathname-directory-prefix-p pathname old)
       (modify-directory-pathname-prefix pathname old new)))

(defun modify-directory-pathname-prefix (pathname old new)
  (let ((dir (pathname-directory pathname)))
    (make-pathname :directory (append new (nthcdr (length old) dir))
		   :defaults pathname)))

(defun pathname-directory-prefix-p (pathname x)
  (let ((dir (pathname-directory pathname)))
    (loop
      (when (null x) (return t))
      (unless (and (consp dir)
		   (equal (pop dir) (pop x)))
	(return nil)))))

(pushnew 'tmp-mnt-frobber *source-file-frobbers*)
---------------------------------------------------------------------


---------------------------------------------------------------------
Q) How do I get around Lisp startup problems to do with NIH?

Allegro CL 4.1 [SPARC; R1] (10/11/93 12:21)
Copyright (C) 1985-1992, Franz Inc., Berkeley, CA, USA.  All Rights Reserved.
Failed to open NIH command's output file: /tmp/NIH724
Error: Can't determine the current user's name
Warning: Skipping attempt to load any .clinit files.

A) This error has to do with the Network Information System (previously
known as Yellow Pages).  In order for your Lisp to work under this
system, the following conditions must apply:

(1) you need to have specified "yes" in reply to the NIS question
when the Lisp was built (refer to pg19-25 of the ACL User Guide for
further details),

(2) the binary cl_nih should exist in your Lisp library, and

(3) the binary cl_nih should be world executable (this is the most
common problem we run into, where the permissions of the person who
built the Lisp exclude others from executing cl_nih).

If all of these conditions are met, please let us know and we will
investigate further.
---------------------------------------------------------------------


---------------------------------------------------------------------
Q) What do I do about the following error installing ACL4.2/CLIM2.0:
	ld: /x11/R4/sun4-lib/libX11.a: No such file or directory

A) The CLIM installation script is incorrectly trying to locate Motif
X libraries (which it doesn't need).  You can circumvent this problem
by changing the following lines in build/instclimxm.lisp, to point to
either the X11 and Xt libraries on your system, or to any valid
library (such as the C library, as shown below):

FROM: #-svr4
FROM: (progn
FROM:   (defvar sys::*libx11-pathname* "/x11/R4/sun4-lib/libX11.a")
FROM:   (defvar sys::*libxt-pathname* "/x11/R4/sun4-lib/libXt.a"))

TO: #-svr4
TO: (progn
TO:   (defvar sys::*libx11-pathname* "c")
TO:   (defvar sys::*libxt-pathname* "c"))
---------------------------------------------------------------------


---------------------------------------------------------------------
Q) What do to about "Error: The operating system will not permit
common lisp to read its own image"?

A) The immediate cause of the message is that lisp tried to open the
file that contains the current symbol table for the executable and
couldn't.  This could happen if the running image had been opening
files and failing to close them, or if the symbol table file itself
had been deleted.

When lisp does a foreign load, a new symbol table file is written, named
/tmp/Li*.  If that file were deleted while the lisp was running, you would
see the error you describe.

Otherwise, this is not a known problem.  Please let us know all the
information we might want to hear - the output of (dribble-bug) is a
good start.  Also any additional details about the syndrome would be
helpful: networking aspects, foreign code loading into the image, load
on the system.  Does a second attempt to do the dumplisp also fail?
---------------------------------------------------------------------


---------------------------------------------------------------------
Q) How do I select values for pre-malloc-ation?

A) In ACL 4.2, you will first need the following patches:

	* build/c/gcutil.o
	* build/c/pdmalloc.o
	* lib/update/patch0195.fasl (latest version)

Then you should see a "malloc arena" report.  This is a tool for
getting rid of gaps.

Gaps are caused by C calling malloc() calling sbrk().  This space is
allocated at the top of the heap, of course.  The next time lisp needs
space, it goes on top of the heap, leaving a "hole" between two lisp
areas that the garbage collector must leave alone.  Once a gap exists,
the GC has a hard time dealing efficiently with the older lisp space
"underneath" the gap.  This leads to huge heaps that eventually
overflow the limits of the application, if you don't page to death
first.

"Premalloc" is something done at build time that preallocates some
malloc space at the bottom of the heap before lisp space begins.  It
is different from the "ffhole".  Premallocs come in different sizes
(all a power of 2).  See the premallocs-argument FAQ example on how
to specify premallocs.

To eliminate gaps at build time:
  1) do a (room t) before loading the application
  2) do a (room t) after loading the application

The "malloc arena" should not grow.  If the arena grows, then use the
suggestions from display #2 and rebuild.  This should eliminate gaps
created at build time.

To eliminate gaps created at run time:
  3) do a (room t) after starting your application
  4) do a (room t) after running your application for a long time

The "malloc arena" should look the same in #1, 2, 3, and 4.  If not,
use the suggestions from display #3 and #4 and rebuild.
---------------------------------------------------------------------


---------------------------------------------------------------------
Q) How do I specify premallocs arguments to config and
build/install_lisp?

A) Premalloc arguments must be specified in the form of the following
example:

  'premallocs="-m 4*2048 -m 8*4096"'

This works when passed as an argument to config, but does
not work when passed as an argument to install_lisp.

To get build/install_lisp to accept the above specification,
changes must be made to the build/install_lisp file.  It is
a good idea to save a copy of the file first, in case there is
a problem.  Then edit the file:

On line 265, add information to the line so it looks like this:

	composer=$composer xcw=$xcw "premallocs=\"$premallocs\"" \

On line 148, add information to the line so that it looks like this:

	clim2=*|clim=*|composer=*|xcw=*|temp=*|root=*|binary=*|premallocs=*)

Add a new line (premallocs=) after line 80, so that lines 78-81 look
like this:

binary=
library=
temp=
premallocs=

Then save build/install_lisp and use it with the proper premallocs
spec above.
---------------------------------------------------------------------


---------------------------------------------------------------------
Q) When I execute a standalone image, I get the message:
	Warning! Can't find lisp library /vol/allegro/lib/
   What do I do?

A) We have agonized over this situation for quite a while; we agree
that it is not good to print this warning when it is not appropriate,
but the lisp in general does not know whether it needs pieces of the
library - some of this is under user control, such as whether to use
Presto (which needs files.bu) or whether to use pure=shared-library
(which requires a .lso file) or whether or not the final product will
include/need any autoloadable files (also requiring files.bu).

You can eliminate this message at the runtime site by doing the
following:

 1. cd to the directory that has the binary image.

 2. type "mkdir lib lib/code"

 3. type "echo >lib/files.bu"

If you do not use a .lso file, this will eliminate the warning.
If this arrangement is inconvenient, you can also place this
"pseudo-library" in the same directory as the binary image, or
in a lib directory at the same level as the image (see "Pseudo-
libraries ..." on p 2-13 of the Allegro CL user guide).
---------------------------------------------------------------------


---------------------------------------------------------------------
Q) I also run Netscape on my machine, but when I do CLIM (or Composer or
   Emacs) can't run properly because the colormap is completely used.

A) Netscape has a reputation for consuming the entire colormap and
leaving none for other applications.  The following message from the
comp.lang.xemacs mailing list tells how to correct this misbehavior.

Summary: netscape ate all my colors

Recently I complained that Netscape hogs all the color cells and
leaves emacs with zilch.  A few people replied to simply start
netscape with -install.  I've also discovered that when I typed
'netscape -help'.

You can also specify this in your .Xdefaults file.  Add:

	Netscape*installColormap:	true

to your .Xdefaults file, then type:

	xrdb -merge .Xdefaults

---------------------------------------------------------------------


Section 2. ARCHITECTURE-SPECIFIC PROBLEMS
=========================================

2.1: SPARC
----------

----------------------------------------------------------------------
Q) We're having problems getting CL up on a SS10 running SunOS 4.1.3.
It dies with the following message:

	The environment this lisp is running in has used
	up too much stack.  It cannot be restarted

It works fine on other SS2's in the department running SunOS 4.1.2.

A) This is a problem that has been circumvented with ACL4.2 and later
versions of ACL.  We advise that you obtain the latest version of ACL.
If you cannot do this, the solution to this problem for ACL4.1 is
detailed below.

The problem arises because Sparc 10s start their stack in a totally
different place than the Sparc 1 or 2.  In ACL4.1 and earlier
versions, we had allowed for some amount of difference in stack start
location, which can occur because the starting location of the stack
depends on how many environment variables and data are defined for the
process, but the Sparc 10's stack start was too far away to adjust for.

Previously the only way around this problem was to maintain
separate images for Sparc 10 and Sparc1/2.

However, there is now a way to build a dumplisp/binary Allegro CL
image which will work on all SPARC machines (restricted only by your
Allegro CL license).  The restrictions on the patch are that you must
1) not have started multiprocessing before doing the dumplisp, and 2)
specifed the :checkpoint dumplisp keyword as `nil'.

Any image built with build/install_lisp (as opposed to dumplisp) will
allow you to use this patch.

There are two parts to this patch, a regular Allegro CL patch in fasl
file form (patch0138) and an object file used to build binary images
(a new ucl.o). Both parts are available in the compressed tar file on
ftp.uu.net in the file:

	/vendor/franz/patches/misc/sparc-acl-4.1-stack-fix-patch.tar.Z

[login name is anonymous, password is your username]

Don't forget to transfer the file in binary mode (use the `bin'
command to get ftp into binary mode).  Instructions for installing
both patches are in the file README-stack-patch in the compressed tar
file.

One last caveat about the patch: if you are an Allegro Runtime user,
the patch does not yet handle building Allegro Runtime images.
(Because Allegro Runtime uses yet another version of ucl.o.)   Please
contact bugs@franz.com for this Allegro Runtime version of ucl.o.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What do I do for the sparc2/sparc10 incompatibility for Allegro
Runtime?

A) Please be reminded that this problem does not occur with ACL4.2
(and any later versions).  We advise that you upgrade to the latest
version of ACL on your Sparc.

Before installing the Allegro CL Runtime fixes described here, you
should install the Allegro CL fixes for the stack movement problem
into Allegro CL--the procedure below depends on patch0138.fasl and
build/ucl.o having been installed into the proper location.

To install the fixed version of Allegro CL Runtime, you need the file
rucl.o and the original Allegro CL Runtime distribution.  The new
rucl.o can be obtained from ftp.uu.net:/vendor/franz/misc/ss.o.Z
(compressed, used binary mode to transfer the file) -- you will need
to specially request that ss.o.Z is placed in /vendor/franz/misc, as
we do this on a demand-driven basis, and delete the file after it has
been obtained by each user.  If you read your Allegro CL tape into
/usr/cl and your Allegro CL Runtime tape into /usr/cl/runtime, then
you will have the following files in /usr/cl/runtime:

	-r--r--r--  1 maketape    3332 Dec  4  1991 README
	drwxr-xr-x  2 maketape    1024 Mar  4  1992 bin/
	-r--r--r--  1 maketape     940 Dec  4  1991 install_rt.sh
	-rwxr-xr-x  1 maketape  453106 Mar  2  1992 rucl.o*

Save the original version of rucl.o and copy the new one into the
`runtime' directory.  After this is done, you will need to install
Allegro CL Runtime again, using install_rt.sh (please refer to the
Allegro CL Runtime installation guide for more information on the
installation of this product).

After running install_rt.sh, you can build runtime images that will
run on all SPARC machines, if you adhere to the following
restrictions: 1) not have started multiprocessing before doing the
dumplisp, and 2) specifed the :checkpoint dumplisp keyword as `nil'.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Even with the patch for the SS10, things don't work.  I'm using
CLIM.  Is this the culprit?

A) Clim is it.  Again, however, note that you would not be continually
running into this problem if you upgraded your system to run ACL4.2.

However, it turns out that clim starts the scheduler, which breaks
the patch.  The easy thing to do would be to build your images without
clim and then (require :clim) at the beginning of each Lisp session.
This, of course, has a nasty startup penalty.  So here is a hacky
workaround.  clim is loaded into the image by loading in the file
build/instclim.cl in the distribution.  The idea is to edit this file
so as to make calls to mp:start-scheduler (which is what clim does to
start multiprocessing) irrelevant.

About the clim images:  what you need to do is to replace
build/instclim.cl with the following:


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
(in-package :system)

(excl:defadvice mp:start-scheduler :around (lisp:return))

(load-application (progn (require :clim)
			 (load-patches
			  "patch"
			  (namestring
			   (merge-pathnames "update-clim"
					    excl::*library-pathname*))))
		  :devel system::*devel*)

(excl:unadvise mp:start-scheduler)

(excl:defadvice clim:open-root-window :before
  (unless mp::*scheduler-stack-group*
    (mp::start-scheduler)))

(format t "~&; Finished loading CLIM~%")
(force-output)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Are there other circumstances under which I would get the
too-much-stack error?  The message is:

	The environment this lisp is running in has used
	up too much stack.  It cannot be restarted

A) It could be that the problem you are seeing is due to the
difference in size of the shell environments between when the lisp was
created and when it was restarted.  The lisp depends on being able to
put its stack close to the same place where it was when the image was
first built.  If the restart environment is much bigger than what was
created in the build/install_lisp script, lisp is not able to use that
same stack location.

A workaround for your situation is to rebuild the lisp, after editing
the build/install_lisp script to add garbage to the environment to
make it nearly the same size as the environment created by the Makefile.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I use Allegro CL on a SPARCstation2 the machine crashes
   sometimes and I get the following message:

   Watchdog reset
   Window Underflow
   Type help for more information

A) There is a known problem on SparcStation2 workstations running Sun
OS 4.1.1 which exhibits the symptoms you describe.  There is a
SparcStation2 Sun OS 4.1.1 patch for the problem and we understand
that the fix is incorporated in Sun OS 4.1.2.

Our Allegro 4.1 distribution includes the patch for the
SparcStation2 and instructions for installation of the patch (later
versions of ACL do not include this patch).  Please see page 3 of the
Allegro CL Installation Guide.  It directs you to the patch, which is
found in the directory SUNOS-patches/sparc2-blank-screen of our
Allegro 4.1 distribution.

The text below is taken from the README file which accompanies
the patch.

    Patch-ID# 100232-01
    Keywords: crash, cpu, screen, black, sparcstation 2, sunos, 4.1.1
    Synopsis: SunOS 4.1.1: Sparcstation 2 crashes or whatchdog resets
    Date: 28/Feb/91

    SunOS release: 4.1.1

    Unbundled Product:

    Unbundled Release:

    Topic: Sparcstation 2, SS2, crash, blank, screen, powercycle

    BugId's fixed with this patch: 1050558

    Architectures for which this patch is available: sun4c

    Patches which may conflict with this patch:

    Obsoleted by:

    Problem Description:
    Large applications that run fine under SunOS 4.1.1 on the
    SS-1/SS-1+ and other SUN4 machines, crash the SS-2 machine
    running SunOS 4.1.1.

    The symptoms are:

	    screen goes black
	    cpu light goes out
	    L1-A does not work
	    user typically has to power the machine off and restart
	    machine again
	    watchdog reset


The README file from which the above was taken also contains
information on installing the patch.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What do I do about using hardware multiply/divide instructions on
advanced Sparc chip architectures?  How do I know if I have an
architecture that qualifies as "advanced"?

A) To utilize certain hardware multiply and divide instructions, compile
and load the following into ACL 4.2:

;;;;;;;;
(defun set-multiply-type (type)
   (ecase type
     (:hardware (comp::.primcall 'sys::set-multiply-type 1))
     (:software (comp::.primcall 'sys::set-multiply-type 0))))
;;;;;;;;

Then, run (set-multiply-type :hardware), and your code will automatically
use the hardware instructions.  Currently, the library routines replaced
by hardware instructions are signed multiply, unsigned multiply, and
unsigned divide.

Unfortunately, SunOS does not provide a mechanism to determine
hardware type.  To determine whether the hardware multiply/divide
instructions exist in your machine, therefore, you should install and
run set-multiply-type as described above.  If your code speeds up, you
have the accelerator.  If it slows down (due to emulation, which uses
a trap), you do not have the hardware instructions.

A sample test program:
;;;;
(defun test (x y n)
	    (declare (optimize (speed 3) (safety 0))
		     (fixnum x y))
	    (dotimes (i n)
	      (the fixnum (* x y))))
;;;;

Compile and run (test 1 2 500000) for comparison.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Does ACL 4.1 run on a Sparc-5?

A) We have determined that the ACL 4.1 compiler was generating an
illegal sequence of instructions (consecutive branches) that worked on
earlier Sparc chips but does not work on this generation.  As a
result, ACL 4.1 will not run on the Sparc5, and there is no patch or
workaround for this problem.

ACL 4.2 does not use the same sequence of instructions, and will thus
run on Sparc5's without any problems.  You should therefore continue
to use ACL 4.1 only on non-Sparc5's, or move to ACL 4.2 at your
earliest convenience if you wish to avail yourself of the benefit of
Sparc5's.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How do I build ACL4.2 under Solaris 2.4?

A) You need to make the following change to one line in build/config:

Change the line:

    5.2|5.3)

to

    5.2|5.3|5.4)

You should be able to build using build/install_lisp, install_runtime
or install_runtime+ without incident from this point on.
----------------------------------------------------------------------


2.2: Silicon Graphics (SGI)
---------------------------

----------------------------------------------------------------------
Q) Does ACL 4.1.mbeta work with MIPS R4000 chips?

A) No.  You need to upgrade to ACL 4.1.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I try to execute the tar command, I get a premature EOF error.
   I get this on both tapes, the one for the R3000 and R4000.  Am I doing
   something wrong?

A) It seems unlikely that you're doing anything wrong.  Can you send us
the output of "tar tvf ..." (or does the EOF error happen before
you've read anything?)?

We did have one other customer who mentioned a premature EOF error on
an SGI tape, but it went away when they moved to another machine.  You
should try reading it on different machines, if possible.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) During installation I get the following error message.  What do I
do?

| Allegro CL 4.1 [Silicon Graphics Iris 4D (R4000); R2] (3/29/93 18:24)
| Copyright (C) 1985-1992, Franz Inc., Berkeley, CA, USA.  All Rights Reserved.
| user(1): ; setting case mode...
| ; Loading /art/cl-r4000/build/load_devel.cl.
| ;   Fast loading from bundle code/defsys.fasl.
| ;   Fast loading from bundle code/foreign.fasl.
| ;     Foreign loading /tmp/Las14174.o.
| Error (from debug): Foreign load failed
| ; Auto-exit
| ; Exiting Lisp
| *** Error code 1
..

A)
(1) If you have never successfully built Lisp on this particular
machine, you probably need the sgi-ld-patch.  The above report is
symptomatic of the problem that this patch fixes. (See below for
further details about this patch.)

(2) If you have previously built Lisp on this machine, please build
Lisp without the development environment, start up Lisp and do a
(require :foreign).  If you get an error, do a ":zo :all t".  Send
this message to cl-bugs@franz.com.

(3) We have learnt that the cdrom with 3.10 compiliers breaks lisp
(and emacs). Reloading the older stuff off the 4.01f disk fixed
things.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What is the sgi-ld-patch?

A) It's a patch to allow ACL foreign functions to work with IRIX
4.0.5f -- essentially the patch provides the linker for IRIX 4.0.5c,
which is what Lisp's internals expect.

The necessary files are available by ftp.  The fix comes in two parts:
a replacement for build/Mf and an additional file, lib/ld-2.40, that
is to be put into the Allegro CL library directory.  Both the above
pathnames are relative to the place you read your Allegro CL
distribution, which you will need to install these patches.

The files Mf and ld-2.40 are located in the file

	sgi-acl-4.1-ld-patch.tar.Z

on ftp.uu.net:/vendor/franz/patches/misc/.

After obtaining the files, make a backup of your current version of
build/Mf.  After installing the new build/Mf and lib/ld-2.40, rebuild
your Allegro CL binary images and foreign functions will work again.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I ran into the following error message.  What do I do?

| USER(1): ; setting case mode...
| ; Loading /usr/cl/build/load_devel.cl.
| ;   Fast loading from bundle code/defsys.fasl.
| ;   Fast loading from bundle code/foreign.fasl.
| ;     Foreign loading /tmp/Las3416.o.
| /usr/bin/ld:
| Can't locate file for: -lc_G0
| Error (from DEBUG): Foreign load failed
| ; Auto-exit
| ; Exiting Lisp
| *** Error code 1

A) The most likely cause for the symptom you're seeing now is that
your System Administrator did not install the maintenance CD (for irix
4.0.5F).  This CD includes the "G0" libraries that are used by ACL for
foreign functions.  You'll need to install this CD to use ACL foreign
functions.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) My IRIX4.0.5F system doesn't have a G0 version of libsun.a.  What
do I do about foreign function calls to this library?

A) The suggested workaround is to link in the contents of libsun.a at
build time.  Here's how you achieve this end:

In the build directory:

% mkdir sunlib
% cd sunlib
% ar x /usr/lib/libsun.a
% cd ..
% sh config sunlib/*.o

This way, all the libsun.a *.o files will be linked in to your image
at config time, and you won't have to reference them when you do the
dynamic load (which uses -A and therefore requires -GO files).  This
has the disadvantage of including more symbols than your code uses,
but is the only possible solution in the absence of libsun_G0.a.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I get an error claiming a library has no table of contents.  What
should I do?

A) SGI has a new archive format and Lisp with the 2.40 loader looks
for the TOC to be in the old format.  Circumvent the problem by
rehashing all of the necessary libraries with `ar tsC` where the C
option is provided for backwards compatibilty.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What do I do about the following SGI installation message?
| libmld--as0: Error: /tmp/Las2817.s, line 5795: cannot write pfield
| Error (from ERROR): Could not assemble the trampoline symbols file

A) This error usually has to do with running out of space in /tmp.
This could either be because a failed Lisp build earlier was unable to
clean up after itself (look for Li*.o files), or something else is
using up the space in /tmp, or that there simply isn't enough space in
/tmp (we recommend that you have about 3.3M in /tmp for a successful
build).  If you can't provide 3.3M in /tmp, you might consider asking
your system adminstrator to link /tmp to /usr/tmp (where, probably,
you have more space available).
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) On the SGI, while loading foreign code, I get the following message:

Warning: jump relocation out-of-range, bad object file produced, can't
jump from 0x100f62e0 to 0x40f840 (symbol name: abort) (call to"abort"
resolved to a name in a different 256 megabyte memory area: the -y
option to ld (example: -yabort ) will show the reference and
definition locations)

A) One way around this it is to use FF:REMOVE-ENTRY-POINT on abort
prior to loading in the foreign code.  This is caused by confusion
between the system abort() and an internal Lisp call.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What do I do about the following error obtained while building
4.2.malpha on Irix 5.2?

	>>     Unresolved:
	>>     sqrt
	>>     copysign
	>>     *** Error code 1 (bu21)

A) Apparently SGI forgot a few entry points in libm.so (what you get
when you specify -lm in the ld line) but not in libm.a.  In the Mf
file in your distribution, substitute -lm with /usr/lib/libm.a and
rebuild (remove ucl first).
----------------------------------------------------------------------


2.3: NeXT
---------

----------------------------------------------------------------------
Q) Does ACL on the NeXT work with the ObjectiveC interface?

A)
 Some time after 3.1 was released we determined that there were some
 subtle bugs in the interface, apparently having to do with object
 headers getting either clobbered, or else cached somewhere unknown
 inside the Objective C runtime.  (Allegro's ObjC class interface
 requires that it be able to find and update all class objects.)  By
 this time NeXT had essentially unbundled Lisp and we no longer had
 the extremely close working relationship with NeXT which had allowed
 the interface to be developed in the first place.  Despite some
 significant effort, the original author of the interface was unable
 to nail down the problem.  In some applications, and for some
 purposes, the ObjectiveC interface seemed to work, but it was known
 to misbehave for others.

 When Allegro 4.1 was ported to NeXTStep 3.0 the problems became
 somewhat worse because additional runtime conventions and internal
 mechanisms were added to NeXT's ObjectiveC implementation.  We looked
 further into the state of the system (and in fairness, we did receive
 technical help from NeXT) but in the end, we faced dependence on a
 large amount of runtime code for which we did not have source access.
 We concluded the total software package would be something we could
 not adequately debug or maintain.  With regrets (because we felt
 technically that the ObjectC interface was in concept very
 sophisticated and powerful) we were forced to remove the ObjectiveC
 interface from the product.

 Rather than drop the code entirely, with 4.1 we do distribute the
 sources for the ObjectiveC interface with Allegro, but it is
 completely unsupported software.  The notion is that perhaps some
 very dedicated and NeXT-sophisticated user can make progress with it,
 but I would not recommend anyone with serious product plans from
 doing so.

 That's all the bad news.  On the other side, here's a thought about
 an alternate architecture that _might_ adequately serve a limited
 class of end applications.

 The big advantage of the Lisp/ObjectiveC interface was that classes
 etc. could be defined and redefined dynamically and interactively.
 Although this is occasionally useful as a execution-time part of an
 application, dynamic definitions are more typically used during
 development than execution.

 If your specific demands on the ObjectC system and (for instance) the
 supplied class libraries of interface widgets, sound hardware, etc.,
 are relative straightforward, static, and not tightly coupled to lisp
 (in the sense that numerous lisp objects need to be portrayed in
 particular ways inside NextStep windows and buttons, etc.) then it
 might be possible to package up your interface inside a
 ``standalone'' interface ObjC program that you would write for your
 specific application.  Lisp would exeute this using

    (excl:run-shell-command "...command and args..."
			    :wait nil
			    :input :stream
			    :output :stream)

 and would then communicate with it over the bidirectional stream
 returned by this function.  In some ways talking some homegrown
 bidirectional protocol with this quasi-server would be a little more
 work than calling ObjectiveC library rutines directly, in
 compensation it eliminates a lot of the awkwardness of dealing with
 foreign functions and the complexities that always arise in tight
 interface between two different language paradigms.

 I know this alternative would be completely inadequate for many
 purposes, but I offer it a something for you to consider, as there
 are a great many other purposes which it is a clean architecture.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) We have just installed NeXTStep 3.0, and I tried out our old
   version of Allegro CL 3.1 with the following results:

   > cl
   Minor versions don't match in "/usr/shlib/libNeXT_s.C.shlib".
   This image cannot be executed.

   Can we just rebuild CL 3.1 or will that software not work with
   NeXTStep 3.0?

A) You do need to rebuild.  _Officially_ we don't support ACL 3.1 on
NeXTStep 3.0, but here's our stock answer on what you can do to
rebuild:

Franz Inc released and supports Allegro CL 3.1 only on NextStep 2.1.
However, some users derived a binary patch that allows ACL to be built
on NextSTep 3.0.  I'm appending that information to the end of this
file -- it consists entirely of postings to comp.sys.next.programmer
on Usenet.  We haven't heard of any problems with this procedure, but
neither have we tested it.  Franz can make no guarantees about the
resulting system, and officially you're on your own.

ACL 4.1 has indeed been released on NextStep 3.0.  (It is not
supported on any earlier NextStep releases.)  This release is the
equivalent of ACL 4.1 on other platforms, containing a native CLOS
implementation and also tracks most of the CLtL2/ANSI language
changes.  You should get in touch with your Franz sales representative
for information about obtaining it.

   [The name of the original poster has interntionally been suppressed
   here so that poster will not be bothered will followups.]

   Newsgroups: comp.sys.next.programmer
   Subject: Fixing Allegro CL 3.1.20 to work under NS 3.0
   Date: 9 Oct 92 04:27:38 GMT

   I thought it was going to take me longer to get a method out for
   doing this but the ucl.o file that I had was not the Franz patched
   file, so it is actually pretty simple as long as you update to the
   Franz patched ucl.o.

   The following is a procedure for fixing Allegro CL 3.1.20 so that
   it works under NeXTstep 3.0. I don't have 3.0 so I need someone to
   try this out and report back to this news group.

     Warning!!! (from Franz) This procedure results in creating a new
     ucl.o binary file. You may distribute this method but not the
     resulting ucl.o file.

     You should find all of the files mentioned here on your ACL
     distribution floppies. If you do not have the Franz patch
     mentioned below you will have to ask Franz for it.

	   1. You need to patch your existing ucl.o file, if it is not
	      already patched, with an existing patch from Franz. This
              is done with an existing shell script called

		   install_patch.sh

	      and an existing patch file called

		   patch.uu

	      To verify that you have done the right thing, after this
              patch is installed the ucl.o file should be 612364
              bytes.

	   2. Then you edit the binary file in emacs and save the
              results.  You are going to edit your existing ucl.o file
              so that you might want to save the existing ucl.o to
              ucl.orig.o. Then run emacs and do:

		   find-file ucl.o
		   replace-string _rld _jld
		   replace-string __bcopy _bcopy^@
		   save-buffer

	      The ^@ above is the null character (000 byte) and can be
	      entered in emacs using

		   C-q C-<space>

	      and will look in an emacs buffer as a single character
              ^@ and NOT two characters.


	   3. You then reinstall ACL as usual.

   Newsgroups: comp.sys.next.programmer
   Subject: Re: Fixing Allegro CL 3.1.20 to work under NS 3.0
   Date: 9 Oct 92 11:15:47 GMT

   I am reposting some of this for clarification:

   > I though it was going to take me longer to get a method out for
   > doing this but the ucl.o file that I had was not the Franz
   > patched file, so it is actually pretty simple as long as you
   > update to the Franz patched ucl.o.
   >
   > The following is a procedure for fixing Allegro CL 3.1.20 so
   > that it works under NeXTstep 3.0. I don't have 3.0 so I need
   > someone to try this out and report back to this news group.
   >
   > Warning!!! (from Franz) This procedure results in creating a new
   > ucl.o binary file. You may distribute this method but not the
   > resulting ucl.o file.
   >
   > You should find all of the files mentioned here on your ACL
   > distribution floppies. If you do not have the Franz patch
   > mentioned below you will have to ask Franz for it.
   >
   > 1. You need to patch your existing ucl.o file, if it is not
   > already patched, with an existing patch from Franz. This is
   > done with an existing shell script called
   >
   > install_patch.sh
   >
   > and an existing patch file called
   >
   > patch.uu
   >
   > To verify that you have done the right thing, after this patch
   > is installed the ucl.o file should be 612364 bytes.

   For step (1.), I believe for most of you if you go to your
   distribution directory called ACL there is a file called

		   dumplispPatch

   this is a shell archive file and if you follow the instructions
   there you should get the same results, ie. a new ucl.o file
   resulting in 612364 bytes.
   If your existing ucl.o file is already 612364 bytes it probably
   already had been patched with the "dump lisp" patch.
----------------------------------------------------------------------


2.4. IBM RS6000
---------------

----------------------------------------------------------------------
Q) With automount, what do I do about the following error?

Allegro CL 4.1 [IBM RS/6000; R1] (4/7/93 11:35)
Copyright (C) 1985-1992, Franz Inc., Berkeley, CA, USA.  All Rights Reserved.
Error: There is no file named "/auto50NhfKcS/general/jd/"
  [condition type: FILE-ERROR]
[1] USER(1):

A) One workaround is to install AMD - a publicly available
automounter.  This automounter allows you to specify the directory to
be used for a temporary mounting point.  This solves all problems -
lisp and emacs reinstall successfully and run ok.  Also, AMD seems to
be much faster than the ibm automounter and is more robust in the case
of system (mount) failures.  AMD is not public domain software but is
freely available via anonymous ftp from cs.columbia.edu (the latest
version) in /pub/amd.  Here's what was in the README file:

	This program is NOT in the Public Domain - it is covered by
	the usual Berkeley software distribution license - but feel
	free to take it and change it.

AMD allows you to specify the temporary mounting point - the default
is /a.  Using the following arguments when starting up AMD causes it
to mount on /tmp_mnt:

/etc/amd -a /tmp_mnt -p -r -d xx.yy.com -w 240 -l syslog /net amd_ai
----------------------------------------------------------------------


2.5. HP
-------

----------------------------------------------------------------------
Q) On the HP, why does it take so long to link each foreign library?
e.g., the first library (183,948 bytes) takes 10 minutes to link.
There is no disk thrashing and the system reponse to other programs is
fine.  I am following progress of the load by watching the files
created in /tmp.

A) This is because ff:*update-entry-points* is T, and searching for
all the entry points on the HP is exceptionally slow.  To circumvent
this, you can either:

(1) link the necessary libraries at build time into the ucl (by
including them in the command line to build/install_lisp, along with
the .o files that use routines defined in the libraries) -- this will
only work if your usage of the libraries is completely defined at
build time.

(2) set ff:*update-entry-points* to nil.  This will allow the load to
proceed quickly, but you will have to resolve any duplicate entry
points (using remove-entry-points) explicitly yourself.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I tried to install Allegro CL 4.2 on the HP station, it died with
	"/bin/ld: Can't find library for -lPW".

A) This is due to an oversight on our part -- you do not need the
library referred to.  To build, edit the file build/Mf and change the
following line:

LIBRARIES = /lib/dyncall.o -lBSD libm/libm.a -lm -lc -lPW

to

LIBRARIES = /lib/dyncall.o -lBSD libm/libm.a -lm -lc

The build should proceed without incident.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Build error on HPUX 9.05/8xx series: unsatisfied symbols (copysign,
logb, drem, finite) -- what do I do?

A) We have noticed that HPUX 9.05 and the 8xx series versions of HPUX
have re-arranged the math libraries so that the ACL 4.2 ordering of
libraries fails.  Please replace the following line in build/Mf:

LIBRARIES = /lib/dyncall.o -lBSD libm/libm.a -lm -lc -lPW

with

LIBRARIES = /lib/dyncall.o /lib/pa1.1/libm.a -lBSD libm/libm.a -lm -lc -lPW

The re-build of Lisp should now work.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What do I need to do to build on HP-9000/8xx series machines?  The
error I get is:

./ucl: syntax error at line 1: `(' unexpected

A) HP-UX 9.00 for the HP-9000/8xx series does not recognize the
EXEC_MAGIC and is thus trying to execute ucl as a shell script.  The
solution is to modify the build/Mf file, and to replace the part in
line 19 that was "-Wl,-N" to "-Wl,-n".

HP-UX on the 800 series also does not do mmap().  As a result, you
cannot use a Lisp shared object (lso) file, which is the default.
This can be worked around by using the pure=text option while
installing lisp, as in "build/install_lisp pure=text".
----------------------------------------------------------------------


Section 3. Using Allegro CL
===========================

3.1: Base Lisp
--------------

----------------------------------------------------------------------
Q) Does ACL 4.1 accept optional args to LAST and BUTLAST?

A) No, but a customer has provided us with a workaround that you can
use until we fix this.  (Our comments on using the code follow it.)

This has been fixed in ACL4.2, i.e., ACL 4.2 does accept optional args
to these functions.

> In case you're interested, here's the code which implements last
> and butlast correctly.  (You're free to use it in any way)
>
> #-(version>= 4 2) ; i.e. I assume 4.2 will get it right
> (progn
>   #+(version>= 4 1)(setf excl:*enable-package-locked-errors* nil)
>   (defun lisp:last (list &optional (n 1))
>     (let ((last list))
>       (dotimes (i n)
> 	(unless (consp list)
>           (return-from last last))
> 	(pop list))
>       (while (consp list)
> 	(pop list)
> 	(pop last))
>       last))
>   (defun lisp:butlast (list &optional (n 1))
>     (let ((but nil))
>       (dotimes (i n)
> 	(unless (consp list)
> 	  (return-from butlast nil))
> 	(push (pop list) but))
>       (while (consp list)
> 	(push (pop list) but))
>       (nreverse (nthcdr n but))))
>   (compile 'lisp:last)
>   (compile 'lisp:butlast)
>   #+(version>= 4 1)(setf excl:*enable-package-locked-errors* t))

Thanks.  These definitions look OK, but in practice it's important for
compilers to optimize things like &optional arg processing, so things
get a little more complicated.  This is typically done by writing
compiler macros (or things like them) or sometimes by optimizers
inside the compiler itself.  Fixing the implementation is actually
somewhat more complex.

> NB: I don't have a manual for version 4.0 so I don't know if the
> it needs the package-lock workaround or not.

No.  Package locking was implemented for 4.1.

> NB: I can't use excl:without-package-locks because it creates a
> non-null lexical environment.

That doesn't matter except that you can't call compile on these
functions.  I presume this "patch" is in your .clinit file?  If so, it
seems a shame to have to call compile on every startup.  It might be
more efficient anyway to put these definitions in a separate file,
compile it, and just have your .clinit or whatever load the fasl at
startup.

> Also, the manual twice misprints the variable as
> 	excl:*enable-package-lock-errors*
> instead of
> 	excl:*enable-package-locked-errors*

This is a know 4.1 documentation bug, already long since fixed for the
next version.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) The doc string in DEFMACRO forms does not seem to be available via
   the emacs-lisp interface.  It would sure be nice if that was
   available, like fi:lisp-function-documentation or
   fi:describe-symbol.

A) Note that this bug exists only in ACL4.1 and earlier versions of
Allegro CL, not in ACL4.2.

The problem is not with the Emacs/Lisp interface but with Lisp itself.
Defmacro simply discards the documentation string (this is a known bug
scheduled for fixing in the next release).

It might be possible to make a patch if it is important.

Note that doc strings are stored on the property list of the naming
symbol with property name (for function-like objects)
excl::%fun-documentation.  So, you can put a doc string on with:

   (setf (get 'symbol 'excl::%fun-documentation) "the doc string")

After you do that, both the lisp function documentation and the emacs
function fi:lisp-function-documentation will work as desired.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) The file compiler (or excl:fasl-write) signalled an error about a
   method on MAKE-LOAD-FORM that I don't understand.

   Reproduce with e.g.:

      USER(134): (defstruct anything-silly)
      ANYTHING-SILLY
      USER(135): (fasl-write (make-anything-silly) "/tmp/silly.fasl")
      Error: NIL is not an arg-info.

A) Regardless whether the fasl writer is called from the compiler
itself or the fasl-write interface, an instance of a structure-class
or a standard-class can only be written if there is a method on
MAKE-LOAD-FORM defined for the class.  The draft ANSI spec _requires_
the implementation to signal error if the user code has not made such
a definition.  See CLtL2 pp.659-663.  What you need to write might be
as simple as this:

	(defmethod make-load-form ((x anything-silly) &optional env)
	  (declare (ignore env))
	  (make-load-form-saving-slots x))

The actual error that is signalled in 4.1 is rather misleading and has
been fixed in 4.2, but you can see MAKE-LOAD-FORM being called in the
backtrace.

To anticipate a frequent mistake people make with make-load-form, you
_shouldn't_ write a method on a public class like structure-object

	(defmethod make-load-form ((x structure-object) &optional env)
	  (declare (ignore env))
 	  (make-load-form-saving-slots x))

in a misguided attempt to have make-load-form automatically to handle
all structures.  There are two reasons:

  First, your method on class T makes the compiler silently write out
any standard-object and structure-object instance it encounters as a
constant in a function, but the language designers felt it was a
useful error check to have the compiler complain when it encounters an
object for which the user hasn't defined a make-load-form method
because quite often such constants are captured accidently (missing
quotes in macros, etc.) and it's nice to detect errors at compile time
rather than run time.

  Second, you may think that you "know what you're doing" by writing
this innocent method on a public class, but what if someone else who
"doesn't know what he is doing" does the exact same thing?  (Think
about that :-).  Only one method can exist, but what if the methods
differ in behavior?  The restriction against making defuns on
non-fboundp symbols in the common-lisp package has the same
motivation.

The moral is to write the make-load-form method on the class you have
implemented, or some appropriate superclass that you have implemented,
but not on some more distant superclass that you don't own.  A more
general statement of this rule resembles the "Restrictions on Portable
Programs" rule in the AMOP, (approximately) that users shouldn't write
methods where the gf _and_ _all_ of the specializer classes are named
by symbols exported from public packages, i.e., packages of which you
are not the implementor.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I need a function that will tell me the name of a function object
   that I have been given. e.g.

  (function-name #'eq) => EQ

  Presumably such information exists, but is undocumented?

A) As long as you are dealing with "nice" functions (not function-
specs or interpreted functions), you can define the following
function:

(defun function-name (obj)
   (if (compiled-function-p obj)
       (excl::fn_symdef obj)
     :unknown))

Note that since there is a call to an unexported (and therefore
unsupported) function, the interface may change in the future.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) While using logical pathnames, I ran into a reference to
sys:hosts.cl.  What does this mean?

A)  As you are probably aware, from the ANSI specification of logical
pathnames, load-logical-pathname-translations has an
implementation-dependent component.  The current documentation for the
Allegro-specific part of this, which tells you (at the end of the
document) about sys:hosts.cl, should explain the error you ran into.

Notes about Allegro CL's logical pathname implementation:
--------------------------------------------------------

0.  The following X3J13-specific items have been implemented:

    71. [# 175, PATHNAME-UNSPECIFIC-COMPONENT:NEW-TOKEN, X3J13 action ..
    72. [# 176, PATHNAME-COMPONENT-VALUE:SPECIFY, X3J13 action # 129  ..
    73. [# 177, PATHNAME-COMPONENT-CASE:KEYWORD-ARGUMENT, X3J13 action..
    74. [# 178, PATHNAME-SUBDIRECTORY-LIST:NEW-REPRESENTATION, X3J13  ..
    75. [# 179, PATHNAME-WILD:NEW-FUNCTIONS, X3J13 action # 137, Jun  ..
    76. [# 180, PATHNAME-LOGICAL:ADD, X3J13 action # 130, June 1989]

    The rest of the items below either clarify or make obvious some
    change from the above proposals.

1.  :device and :version now default to :unspecific

2.  symbols can no longer be coerced to pathnames

3.  pathname-host, pathname-device, pathname-directory, pathname-name,
    pathname-type, pathname-version and make-pathname accept and ignore
    the :case keyword

4.  make-pathname: device and version default to :unspecific and if not
    nil and not :unspecific (or :newest, for version) an error is signaled.

5.  make-pathname: returns a logical pathname if host is given and it is
    `logical'.

6.  The spec says of parse-namestring:

     thing is recognized as a logical pathname namestring when host is
     logical or defaults is a logical pathname.  In this case the host
     portion of the logical pathname namestring and its following colon are
     optional.  host is logical if it is supplied and came from
     pathname-host of a logical pathname.  Whether a host argument is
     logical if it is a string that is string equal to a logical pathname
     host name is implementation-defined.  If the host portion of the
     namestring and host are both present and do not match, an error is
     signaled.

  and we've made one extension to this:

     Allegro recognizes logical pathname namestrings in one additional
     circumstance: the namestring has logical namestring syntax, and host
     is given, and that host is logical (ie, someone setf'd
     logical-pathname-translations on it).  It may be that this is how the
     spec was meant to be written, but it is a little vague on this
     point.

7.  merge-pathnames: with pathname is a logical pathname and defaults is
    not, then we translate pathname before the merge.  I don't know if
    this is legal, but without this hack,

	(merge-pathnames logical-namestring namestring)

    can easily return an invalid logical pathname.  For example,

	(merge-pathnames "sys:;comp;nl.cl" *default-pathname-defaults*)

    would yield a bogus pathname because the resulting pathname would
    have a logical host component of "sys", would be a logical pathname,
    but there may be no valid translation for the resulting pathname
    (if, for example, the translation for "sys" only handled relative
    pathnames).

8.  merge-pathnames returns a logical pathname when: 1) its pathname
    argument is logical (see the previous merge-pathnames note,
    however), or 2) defaults is a logical pathname and pathname has no
    host component.

9.  file-namestring returns a string which contains "*" for :wild name
    and type components.

10. directory now accepts true wildcards.  If given a string, then
    directory will merge the resulting pathname with a default pathname
    containing a :wild name and type.

11. the variable excl::*pathname-remove-..* has been removed (it having
    a value of `t' violates the spec)

12. parse-namestring: a directory sub-component of "**" is parsed as
    :wild-inferiors and "*" as :wild.

13. previous directory canonicalization has been changed: :up is no
    longer removed.

14. implementation notes on bug1505 (PATHNAME-LOGICAL:ADD X3J13 action #
    130):

  a.  logical pathnames print with #l reader syntax, regular pathnames
      with #p.  Not all namestrings obtained from logical pathnames,
      when parsed, will yield a logical pathname, which is why there
      needs to be different reader syntax for pathnames and logical
      pathnames.  For example,

	(type-of (pathname "**;*.*")) => pathname
      and
	(type-of (logical-pathname "**;*.*")) => logical-pathname

  b.  *default-pathname-defaults* can't be made a logical pathname.
      I'm not sure this is a bug, or not.

  c.  There is a translation for the logical host "sys" which is
      defined as:

	(setf (logical-pathname-translations "sys")
	  (list
	   (list ";**;*.*" (namestring excl::*library-pathname*))))

      This is within the spec, as it reserves the logical host "sys"
      for the implementation.

  d.  Implementation notes for load-logical-pathname-translations:
      the file "sys:hosts.cl" is the name of the database, which means
      the file hosts.cl in the library is used to load logical
      pathname translations.  The format of this file is:

	host {translation}+

      where `host' is a string naming a logical host (ie, "src") and
      `translation' is a list which is the translation (ie, a list of
      the source and target, such as (list ";**;*.*" "sys:;**;*.*")).
      `translation' is evaluated.

      For example, this could be a local (Franz Inc. only) hosts.cl:

	"src"
	(list ";**;*.*" "sys:;**;*.*")

	"acl-master"
	'(";**;*.*" "/net/akbar/cl/master/**/*.*")

	"acl-4-1-master"
	'(";**;*.*" "/net/jeff/scm/4.1/master/**/*.*")

      Which allows the following translations:

	user(2): (translate-logical-pathname #l"sys:foo.cl")
	#p"/net/ice/usr/tech/layer/4.1/src/foo.cl"

	user(3): (translate-logical-pathname #l"src:foo.cl")
	#p"/net/ice/usr/tech/layer/4.1/src/foo.cl"

	user(4): (translate-logical-pathname #l"acl-master:foo.cl")
	#p"/net/akbar/cl/master/foo.cl"

	user(5): (translate-logical-pathname #l"acl-4-1-master:foo.cl")
	#p"/net/jeff/scm/4.1/master/foo.cl"

      When the hosts.cl file is read, the values read from it are
      cached so that further calls to
      load-logical-pathname-translations do not cause the file to be
      read.  excl:dumplisp or modifying the sys:hosts.cl cause the
      cache to be invalidated.

15. The exported and setfable function
excl:logical-pathname-translations-database-pathname maintains the
name of the logical-pathname translations file consulted by
load-logical-pathname-translations.  It has an initial value of
"sys:hosts.cl".

Here is the sample lib/hosts.cl on the distribution tape:

-------------------------------------------------------------------------------
;;; This is an example logical host translations database.  It is used by
;;; load-logical-pathname-translations to lookup the translations for a
;;; given logical host.

;; the format of items in this file is
;;   - host
;;   - translation
;; the host form is not evaluated, the translation form is evaluated.

#|
"foo"
(list "**;*.*" "/foo/**/*.*")

"bar"
(list "**;*.*" "foo:**;*.*")
|#
-------------------------------------------------------------------------------

This means that when a user does

	(load-logical-pathname-translations "foo")

The file pointed to by excl:*logical-pathname-translations-database*
will be consulted for a translation for "foo".  The contents of the
file pointed to by excl:*logical-pathname-translations-database* are
cached and when the file changes, it is read again.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) It appears that if a logical pathname contains an underscore, it
   is not translated correctly:

   USER(15): (translate-logical-pathname "mathserver:lib;foo.bar")
   #p"/design/acl/sun4m-svr4-idl/mathserver/lib/foo.bar"

   USER(16): (translate-logical-pathname "mathserver:lib;foo_.bar")
   #p"mathserver:lib;foo_.bar"

A) If you look carefully at CLtL2 p.628 you'll find that underscore is
not a legal character in a word in a logical pathname >>namestring<<.
The implied type coercions when t-l-p is given a string argument make

 (translate-logical-pathname "mathserver:math_server")

equivalent to

 (translate-logical-pathname (pathname "mathserver:math_server"))

and further equivalent to

 (translate-logical-pathname (parse-namestring "mathserver:math_server"))

Parse-namestring is defined to return a logical-pathname iff the
string argument has the syntax of a logical-pathname namestring.  If
it doesn't, it returns a physical pathname.  Since a physical filename
in Unix can contain almost any characters whatever -- only slash has a
particular restricted meaning -- you get a plausible if unlikely Unix
filename described thus:

<6> (describe (parse-namestring "mathserver:math_server"))
#p"mathserver:math_server" is a structure of type pathname.
 It has these slots:
 host               nil
 device             :unspecific
 directory          nil
 name               "mathserver:math_server"
 type               nil
 version            :unspecific

Logical pathnames don't exist so that you can describe any arbitrary
filename.  They exist so you can define you application files in a
restricted syntax guaranteed to be supported by all implementations.
So, the right thing is not to use underscores in your pathnames.  You
might someday port to a bizzarre platform whose filesystem doesn't
support them.

However, it happens that the strict restrictions are placed only on
logical pathname >>namestrings<<, i.e., on the processing done by
parse-namestring.  Therefore, you can create logical pathnames with
any words whatever if you create the pathname explicitly, e.g. using
make-pathname, rather than implicitly using parse-namestring:

<9> (describe (make-pathname :host "sys"
			     :directory '(:relative "Source" "Lib")
			     :name "Foo_Bar_+=#$%^&!"
			     :type "fortran"))
#p"sys:;Source;Lib;Foo_Bar_+=#$%^&!.fortran" is a structure of type
logical-pathname.  It has these slots:
 host               "sys"
 device             :unspecific
 directory          (:relative "Source" "Lib")
 name               "Foo_Bar_+=#$%^&!"
 type               "fortran"
 version            :unspecific

This might be reasonable for addressing some system file needed by
your application that happens to have a nonconformant name, but we
don't recommend exploiting it for files whose names are under your
control.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How do I determine the directory where the lisp image that is
curently running is located?

A) We suggest using the following function:

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
(in-package :user)

(ff:defforeign 'curpgmname)

#+(version>= 4 2) (declaim (:fbound 'curpgmname))

(defun get-image-name ()
  (let ((nameptr (curpgmname)))
     (if (zerop nameptr)
         nil
       (ff:char*-to-string nameptr))))
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I'm left with running Lisp processes after I exit my
Emacs/xterm. What do I do to avoid this?

A) This issue is very complicated: whether and how lisp should terminate
when its input/output streams are broken.  We have a patch (patch0200
for ACL4.2) that _should_ give the behavior most people want, that a
lisp image quietly and immediately ceases execution when its remote
initial terminal io stream is closed.

If the patch above doesn't work, here is some code you can load into
an image or otherwise cause to execute (e.g. in ~.clinit.cl) that
might have useful effect in making lisp images go away when you want
them to.

====================
#-(version>= 4 3)
(progn
  (unless (fboundp 'unix-signal)
    (ff:defforeign 'unix-signal :entry-point (ff:convert-to-lang "signal")))

  (unix-signal 1 0)				;SIGINT
  (unix-signal 15 0)				;SIGTERM
)
====================
----------------------------------------------------------------------

----------------------------------------------------------------------
Q) ":i ?" doesn't work.  What are the inspector commands?

A) This bug is fixed for the next release.  The current 4.2 Doc string
for the inspector is:

  "Inspector commands are entered as :i, :i <x>, :i <x> <y>, or
:i <x> <y> <z>.  The options are:
  :i             redisplay the current object
  :i *           initialize inspector to display the value of *
  :i print <y>   set limit on number of components displayed to <y>
  :i skip <y>    redisplay the current object, skipping <y> elements
  :i <name>      descend to the named component of the current object
  :i <integer>   descend to the indexed component of the current object
  :i >           select the next indexed element of the parent object
  :i <           select the previous indexed element of the parent object
  :i -           ascend to the parent of the current object
  :i tree        show the inspection stack
  :i set <y> <z> put <z> (evaluated) in the component designated by <y>
  :i q           clear inspector stack - exit (inspect ...)
  :i ?           display this message
  :i form        when form is not a symbol or integer:
                   eval form and initialize inspector to display the value
  :i form x      when form is not a symbol or integer:
                   do (inspect (eval x))
"
----------------------------------------------------------------------




3.2: Garbage collector
----------------------

----------------------------------------------------------------------
Q) When I run my application, some problems on heap space result.  The
   error I get is:

   Error: An explicit gc call caused tenuring and a need for 22544384
          more bytes of heap.
   This would exceed the image size limit set at initial build.
     [condition type: storage-condition]

A) It is hard to draw any conclusions about your problem without more
information about the application.  A log of gc activity would help
direct the search.  Please do the following,  capturing the printed
information in an emacs shell buffer or by using the unix tee command:

After loading but before running your application:
   (room)

   (setf (sys:gsgc-parameter :print) t
	 (sys:gsgc-parameter :stats) t)

then run your application to the point of failure.

Then:
   (room)

Please send the log of this run to us and we'll study it to see what it
suggests.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I'd like to give my users an indication that gc is in progress, so
   that they will be patient. I have a function that will produce the
   desired indication with minimal consing.  Any ideas on how to do this?

   The problem is how to get the function called. I see the the
   *gc-after-hook*, but there doesn't seem to be a *before* hook. I'm not
   sure if advising excl:gc will to the right thing for system-initiated
   GC's.

A) There is currently no way to do this in ACL, although both Composer
and CLIM provide this capability.  In addition, we now have a way of
doing this for Emacs users.  See the release information with version
2.0.16 of the emacs-lisp interface for details.

In addition, we have a provision for calling C code before the gc, but
that C code must not call back into lisp, and there is no way to
execute lisp code until the gc finishes.

If you can contrive to turn your gc indicator on and off in C
routines, then this is how to proceed:

The garbage collector looks at a couple of C global variables, defined
as:

int (*gc_before)(),(*gc_after)();

You could foreign-load a C function that plugs your functions into
these slots.  Be sure and chain-in politely, calling any non-zero
function pointers you find in those slots before-or-after you do your
work.

In release 4.3 we expect to replace these C hooks with a real lisp
list of integer addresses of foreign function hooks.  The gc will
traverse the before and after lists and call each foreign function.
This will allow multiple hooks to operate without interference.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How do I get rid of malloc gaps in my Lisp heap space?

A) Gaps are caused by C calling malloc() calling sbrk().  This space
is allocated at the top of the heap, of course.  The next time lisp
needs space, it goes on top of the heap, leaving a "hole" in between
two lisp areas that the garbage collector must leave alone.  Once a
gap exists, the GC has a hard time dealing efficiently with the older
lisp space "underneath" the gap.  This leads to huge heaps that
eventually overflow the limits of the application, if you don't page
to death first.  This can result in errors of the following form,
where a small additional requirement for space translates into a
requirement for two new (potentially large) hemispaces:

;;;;;;;;;
Error: An allocation request for 24 bytes caused a need for 42778624
more bytes of heap.  This would exceed the image size limit set at the
initial build.
;;;;;;;;;

A mechanism to avoid malloc gaps in the Lisp heap layout is described
below.

* You should use the ffhole argument to build/install_lisp.  The
number you set it to indicates what foreign (C) code allocates at run
time.  To choose the right value, start with an arbitrarily large
number so that bytes allocated > bytes used.  Then reduce the value
such that ffhole = bytes-used + 10%. 

* For ACL 4.2, there is a patch that extends the function ROOM to
provide information that can be used to determine the right setting
for the premallocs argument to build/install_lisp.  Get and install
the latest versions of the files:

	(1) build/c/gcutil.o
	(2) build/c/pdmalloc.o
	(3) lib/update/patch0195.fasl

When you re-build and re-start your Lisp, (room t) will give you a
"malloc arena" report.  This is a tool for getting rid of gaps -- it
indicates the premalloc specifications you should specify when running
build/install_lisp.

"Premalloc" is something done at build time that preallocates some malloc
space at the bottom of the heap before lisp space begins.  It is
different from the "ffhole".  Premallocs come in different sizes (all
a power of 2).

To eliminate gaps at build time:
===============================
  (1) do a (room t) before loading the application;
  (2) do a (room t) after loading the application.
The "malloc arena" should not grow.  If the arena grows, then use the
suggestions from step (2) above and rebuild.  This should eliminate
gaps created at build time.

To eliminate gaps created at run time:
=====================================
  (3) do a (room t) after starting your application;
  (4) do a (room t) after running your application for a long time.
The "malloc arena" should look the same in steps (1), (2), (3), and
(4).  If not, use the premalloc suggestions from step (4) and rebuild.
----------------------------------------------------------------------


3.3: Foreign function interface
-------------------------------

----------------------------------------------------------------------
Q) Does all multiprocessing activity halt when (and while) waiting for
foreign functions to complete?

A) Yes.  We have this (ability to use multiprocessing and foreign
functions together) logged as a RFE for the future, but even so there
would be a number of restrictions on what the foreign code could
legally do, including such nonobvious things as how signal handling
would be arbitrated.  RPC uses signals and maybe also setitimer, if my
memory is correct, and there is only a single signal state per Unix
process which is common to Lisp and all foreign functions.

In the short term there is at least one technique that might work
around the whole problem.  If it is logically possible, your RPC code
could be moved to a separate Unix process that Lisp executes using
excl:run-shell-command with :wait nil and :input and/or :output being
:stream.  Your lisp code would then communicate with your RPC code
using streams, and so lisp multiprocessing would be completely happy.

This approach presumes that your RPC usage doesn't actually need to
run in the same address space as lisp, i.e., that the representation
of data communicated to the RPC code via a stream.  This is only
sometimes true of foreign code in general (for instance, you wouldn't
want to have to pass a large 2-d numeric array to a foreign fft
routine this way) but since data sent or received by RPC is going to
have to be translated to some external format and sent through a
stream anyway, separation of the RPC code to a separate process and
address space wouldn't seem to be a limitation.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How do I pass a C string back to Lisp?

A) It is not completely straightforward to do so because of
fundamental differences between the datatypes.  To C a string is not a
real datatype; rather, it is a convention whereby the string is
identified by the address of its zeroth character.  A Lisp string
object is an array which has a header that contains the string length,
possibly along with other things.  When a Lisp string is passed to C,
the foreign function interface simply passes the address of the zeroth
character.  (C can therefore side effect characters in the string,
although it cannot change the string's length, fill-pointer, or any
other properties.)  However, a C string cannot be passed back to Lisp
as a meaningful object.  Instead, a Lisp string must be built and the
characters copied from the C string into the new Lisp string.

The function below does this.  It first determines the length of the
string, then allocates a Lisp string, and finally copies the
characters one-by-one.  It is quite efficient in execution.

   (defcstruct (c-string :malloc) (char 1 :char))

   (defun char*-to-string (address)
     "Create a Lisp string copy of a C string"
     (declare (optimize (speed 3))
	      (integer address))
     (if (eq 0 address)
	 (error "0 is not a valid character pointer"))
     (let* ((length
	     (do* ((i 0 (1+ i))
		   (intchar (c-string-char address i)
		    	    (c-string-char address i)))
		  ((eq 0 intchar) i)))
	    (string (make-string length)))
       (declare (simple-string string)
		(fixnum length i))
       (do* ((i 0 (1+ i))
	     char)
	    ((= i length))
	    (declare (optimize (safety 0))
		     (fixnum i)
		     (string-char char)
		     (simple-string str))
	    (setq char (code-char (c-string-char address i)))
	    (setf (schar string i) char))
       string))

If you don't need to create a real Lisp array object and only need to
access the individual characters of the C string in place (the way C
itself does) the C-STRING-CHAR function defined by the DEFCSTRUCT is
all you need.  It is setfable and very fast, since the compiler
opencodes it.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Does ACL support Lisp-C interaction through RPC?

A) We do not use RPC in our code and we have no documentation for it
(we use interprocess communication using sockets, for example between
Allegro CL and GNU Emacs, using the code in ipc.cl included with the
Emacs interface code).  We have had reports of others using RPC via
the foreign function interface and those customers report things went
okay.

It may be the the foreign function interface is simply what you need.
However, here is a grabbag of information on RPC taken from questions
similar to your.  Note at the end, we have some RPC code given to us
by a customer but we have never tested it or used it.  However, if you
decide to try to develop an rpc interface yourself, the code might be
useful to you as a starting place.  See near the end of this message
for more information.

Other customers have asked about RPC.  Here, for example, is what
another customer asked:

  So what I am really trying to do is get objects in different
  Lisp environments (running on different machines) to send
  messages back and forth.  I figured that I would have to write
  the sender/receiver code in C and load it as foreign functions.
  I was just hoping I didn't have to start from scratch.  So, any
  help you can give me would be greatly appreciated.

And we responded:

  Here is information on RPC code which we have heard about.  Some of
  these reports are a year or more old, so they may describe things no
  longer available.

  1.  Here are some comments we made to a customer in a situation like
  yours.  (The customers question is indented, then our response:

     We are converting a Symbolics Common Lisp program that uses RPC
     to ACL.  Is there anything in ACL comparable to Symbolics
     approach to RPC or a recommended way of invoking it?

  I'm sorry, but there is no ready-made Allegro interface to RPC.
  This question has come up from time to time, but not often enough
  for an implementation to have become a priority.

  The question how you should best approach porting your RPC code
  depends greatly, I would think, on how much of RPC your system uses,
  and what kinds of use it makes.  I can think of three ``general
  approaches'':

   - Call RPC routines as lisp foreign functions.  We know that
  customers has successfully interfaced to parts of RPC by calling RPC
  routines as foreign functions.  This mostly works, although we heard
  of one Sun RPC routine that appropriates the SIGALRM signal which is
  also needed by Lisp multiprocessing.
   - Wrap your calls the RPC inside a separate C executable, and exec
  that program using EXCL:RUN-SHELL-COMMAND.  This is conceptually
  easy.  While it move the RPC functions one big step further away
  from the Lisp callers, the extra insulation it provides can be
  viewed as a feature rather than a limitation, depending on your
  detailed needs.
   - Instead of RPC use some other paradigm to achieve your ends.
  This might be using RUN-SHELL-COMMAND to invoke system commands
  directly (e.g. lpd, rexec) or else using socket connections to
  system services through IPC:OPEN-NETWORK-STREAM.  (See the simple
  telnet client example at the end of ipc.cl in the directory pointed
  at by excl::*library-code-pathname*.)


  2.  Sun has some implementation of RPC.  This user did not seem to
  like it, but here are some comments:

     I got stuck with using Sun's RPC implementation from within
     Allegro CL.  All works fine until I try to call the RPC
     function clnt_call().  This results in a segmentation fault.
     I would need some advice from people who have already
     used RPC in ACL.

     Are there any conflicts between ACL internals and RPC functions?

  We don't make use of RPC in our own tools -- we do interprocess
  communications differently, using sockets directly -- but I believe
  various of our customers have used RPC from time to time.  A full
  implementation of RPC should probably be considered a hard problem,
  but if you only need a few client functions, it might not be so
  difficult.

  We don't know of any definite conflicts between Sun's RPC
  implementation and Allegro foreign functions.  Our `spr' database
  shows only one _possible_ conflict -- one customer thought that
  Sun's RPC might be using the SIGALRM signal which is also used by
  Allegro if the multiprocessing scheduler is started.  This would be
  a problem using both in the same lisp image, but we never determined
  for sure whether RPC indeed uses the timer, and if so, under what
  conditions.  I'm mentioning it here only as a possibility of which
  you should be aware.

  In general, making non-trivial foreign functions work correctly
  usually requires clear understanding of the underlying datatype
  representations in both languages, and of the argument conversion
  conventions.  Our experience is that it's very easy to get these
  things wrong, and a segmentation violation or other exception is
  typically the result of a one-too-few or one-too-many levels of
  indirection in the argument passing.  If you haven't identified the
  problem, then we _might_ be able to recognize the problem if you
  could show us the definitions of the foreign functions, the foreign
  function calling forms, and a stack backtrace at the point of error.

  Check with your Sun salesperson to see if Sun RPC code is (still)
  available.

  3.  Xerox wrote a (almost-)pd versions described in this message (I
  do not know how easy it is to use in Allegro CL):


  ****************************************************************
  Newsgroups: comp.lang.lisp
  Subject: Common Lisp implementation of SUN RPC available
  Distribution: comp
  --text follows this line--
  Periodically there have been requests on this group for a Common
  Lisp implementation of SUN RPC. We have an implementation available
  in source form for anonymous ftp.

  The code was originally written by Jeff Finger while at Stanford,
  and has been subsequently revised at Xerox by Bill van Melle.
  Currently it only runs in Xerox Common Lisp, but was written with
  portability in mind.  It has been the basis of many robust clients
  (including NFS) but includes little support for the implementation
  of network services.

  We hope that someone will be enticed to: (1) port the code other
  Common Lisp implementations; and further (2) extend the system to
  support implementation of servers.  Both of these are significant
  programming efforts, requiring familiarity with both SUN RPC and the
  foreign function interface of the target Lisp.  The first task also
  requires some familiarity with Interlisp-D.

  The copyright permits almost anything to be done with the code, so
  long as changes are made available to Stanford and Xerox at no
  charge.

  The code is available for anonymous FTP from arisia.xerox.com
  (13.1.100.206) as /pub/lisp-rpc.tar.Z.  This contains:

  rpc.announce		- this message
  rpc.tedit		- original documentation
  rpc.ps			- postscript version of above
  rpc.txt			- plain text version of above
  rpc.lisp		- top level, loads the rest of the system
  rpcdecls.lisp		- macros, needed at compile time
  rpcstruct.lisp		- structure & condition definitions
  rpcrpc.lisp		- program definition & invocation
  rpcxdr.lisp		- external data representation
  rpcudp.lisp		- UDP transport for Xerox D-machine
  rpctcp.lisp		- TDP transport for Xerox D-machine
  rpcos.lisp		- UDP transport for Xerox Lisp on a Sun
  rpcportmapper.lisp	- definition of portmap client
  rpcsrv.lisp		- incomplete UDP RPC server, implements
			  portmap

  The Lisp files were originally in Interlisp file manager format and
  were converted to plain text for this distribution.


	  Doug <cutting@parc.xerox.com>


------------------

A company called Mystech implemented some sort of RPC with Allegro CL.
They provided us with the source code whihc is uncopyrighted and so
can be distributed.  We have recently provided this to another
customer who reported that all of the files sent compiled with little
or no change but some two files seemed to be missing and there was no
documentation or explanation on how the system worked.  Unfortunately,
we do not have the (apparently) missing files and we have no
documentation.

If you would like, we can send the code to you.

If you are interested, you are welcome to the code but please note the
following:

Please be aware that it is not a Franz product so we cannot support it
or answer questions about it and we are not even asserting that it
works or will be useful to you.  FURTHER, THE FILESWILL BE PROVIDED
WITH ABSOLUTELY NO WARRANTY WHATSOEVER, AND FRANZ INC. WILL NOT BE
LIABLE FOR EITHER DIRECT OR CONSEQUENTIAL DAMAGES ARISING FROM USE OF
THESE FILES.  (The lawyers require us to say that.)
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) In ACL 4.2 can we call C++ functions as well as C functions?

A) Yes.  Described below is the recommended way of doing this:

   * Calling C++ methods.  Currently, C++ methods cannot be called
   directly from Allegro CL, so you must call them from C functions.

   * The naming conventions of C++ compilers cause problems when trying
   to define Common Lisp functions that point to C functions.  If you
   define your C functions like this:

	extern "C" int foo (char *whatever)
	{
	    //the rest of the function may use C++
	}

   then Allegro CL can find the name of `foo'.

   * Runtime initialization forms in C++ object files can cause
   problems on non-SVR4 systems.  On non-SVR4 systems, initializers
   are not run.

   For the following declaration:

	foo x(3);

   Even though it is declared, the x.slot_value will not be set to
   the correct value (3 or whatever the foo initialization method
   does to 3).

   In order to circumvent this problem, you need to call the
   initializers explicitly from Lisp.  For example, with the Cfront
   C++ compiler, static initialization is handled by generating a
   function with a name like _sti_xxxxx for each file that is
   compiled.  Ordinarily, the C++ linker arranges for the static init
   functions that are in a particular executable to be called at
   startup.  Obviously, when dynamically foreign loading into Lisp,
   this doesn't happen.  You therefore need to determine the names of
   the static initialization functions and then call them from Lisp.

   * Runtime initialization forms in dynamically loaded C++ object
   files are correctly loaded on SVR4 (ie, Sun's Solaris 2.x) systems.
   For further details, check the FAQ entry for loading in Solaris2.x.


Hope this explanation helps.  Essentially, you need to use the C
interface to buffer the interaction between Lisp and C++, regardless
of which C++ compiler you are using.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How do I build a shared C/C++object file for loading in Solaris 2.x?

A) When running in Solaris 2.x, Allegro's foreign loader can only
load shared object files.  The unix loader builds a shared object file
instead of a normal object file when you pass it the -G switch.
Thus given a file foo.o that you want to load into lisp, the simplest way
to build a shared object file is this:

% ld -G -o foo.so foo.o

Now in Lisp you can run (load "foo.so") to load in the file.
If foo.o calls functions in libraries (other than libc) then you must
specify them on the ld command line, e.g.:

% ld -G -o foo.so foo.o -lX11 -lm

If foo.o is C++ code  (or if any of the libraries mentioned contain C+++
code) then you have to be concerned with initializers.  In C++ user code
(called constructors) can be called before a program starts in order to
initialize globally allocated data.  When you dynamically load C++ code
you want to ensure that all constructors are run during the dynamic loading.
Each .o file that is created by a C++ compiler contains a piece of a function
that initializes the data structures mentioned in that file.  When the
unix loader combines a set of .o files to create an .so or a big .o it
combines the initialization code.  In order to make the initializion
section into an initialization function that will be run when the file
is dynamically loaded you must include two specific files from your C compiler
vendor's library.  One of these files must be the first .o file mentioned
and one must be the last.  The purpose of these .o files is to put
the prolog and epilog on the initialization function.  It can't hurt
to include these files if you are just linking C code.
For the SunPro C compiler the names of these files are crti.o and crtn.o
and they are found in the compiler's library.

So for building a C++ shared object a sample command line is:

% ld -G -o foo.so /usr/opt/SUNWspro/SC2.0.1/crti.o foo.o -lC /usr/opt/SUNWspro/SC2.0.1/crtn.o

----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What do I do about multiply-defined problems with /lib/libc.a?

A) There is a known bug in the foreign-function interface that would
manifest itself as multiple definition errors.  This was caused by a
now-obsolete kludge that was used to link Fortran code with Allegro in
an old version of SunOS.  The symbols that showed up as multiply
defined in that problem were (some subset of):

/lib/libc.a(double_decim.o): __unpacked_to_decimal: multiply defined
/lib/libc.a(_unpack_dble.o): __unpack_quadruple: multiply defined
/lib/libc.a(_sprintf_sup.o): __prod_b10000: multiply defined
/lib/libc.a(_sprintf_sup.o): __carry_out_b10000: multiply defined
/lib/libc.a(_sprintf_sup.o): __prod_65536_b10000: multiply defined

If these are the symbols that are giving you trouble, then there is a
workaround:  if you can, then rebuild lisp after doing the following:

 % cd <allegro-dist-dir>/build
 % /bin/mv removesyms removesyms.orig
 % /bin/cp /dev/null removesyms

If you can't rebuild your lisp, then a short term solution is to do
the following before attempting a foreign load:

(dolist (s '("__prod_b10000" "__carry_out_b10000"
             "__prod_65536_b10000" "__unpack_quadruple"
             "__unpacked_to_decimal"))
  (ff:remove-entry-point s))
----------------------------------------------------------------------


3.4: Converting code from Franz Lisp to Allegro CL
--------------------------------------------------

----------------------------------------------------------------------
Q) What changes must I make to move from Franz Lisp to ACL?

A)  We have collected a number of changes that others and we have
encountered.  While this list is not complete, it should help you get
started.  If you see places where this list needs to be augmented,
please let us know.  Thanks!

Article 380 of 384, Thu 06:05.
Subject: Re: Implode, explode and Common Lisp
From: geb@cadre.dsl.PITTSBURGH.EDU (Gordon E. Banks)
Path: ucbcad!ames!rutgers!rochester!pt!cadre!geb
Organization: Decision Systems Lab., Univ. of Pittsburgh, PA.
Newsgroups: comp.lang.lisp
Date: 6 Aug 87 13:05:21 GMT
Reply-To: geb@cadre.dsl.pittsburgh.edu.UUCP (Gordon E. Banks)

In article <1840@chalmers.UUCP> sundin@chalmers.UUCP (Ulf Sundin)
writes:

>I intend to translate a rather large Franz Lisp program
>to Common Lisp. However, some parts of the progeram relies
>heavily on the use of 'implode' and 'explode' for which
>no equivalents are defined in Common Lisp.
>
This seems to work for me, but I'm no Lisp expert.


(defun explode (atom-name)
  "Explodes the atom name into a list of characters."
  (coerce (string atom-name) 'list))

(defun implode (charlist)
  "Given a list of characters, returns an imploded atom name."
  (intern (coerce charlist 'string)))

If you have a better solution, let me know, since I use these a lot.


Article 382 of 384, Thu 08:47.
Subject: Re: Implode, explode and Common Lisp
From: barmar@think.COM (Barry Margolin)
Path: bloom-beacon!think!barmar
Organization: Thinking Machines Corporation, Cambridge, MA
Newsgroups: comp.lang.lisp
Date: 6 Aug 87 15:47:50 GMT
Sender: news@think.UUCP
Reply-To: barmar@godot.think.com.UUCP (Barry Margolin)

In article <771@cadre.dsl.PITTSBURGH.EDU>
geb@cadre.dsl.pittsburgh.edu.UUCP (Gordon E. Banks) writes:
>(defun explode (atom-name)
>  "Explodes the atom name into a list of characters."
>  (coerce (string atom-name) 'list))
>
>(defun implode (charlist)
>  "Given a list of characters, returns an imploded atom name."
>  (intern (coerce charlist 'string)))

These don't fit the poster's specifications.  He said that CHARLIST is
a list of symbols and strings, but your IMPLODE expects a sequence of
characters.  Here are versions that I think are completely compatible
with Maclisp.

(defun implode (charlist)
  (intern (map 'string #'character charlist)))

;;; This is more complex because EXPLODE isn't restricted to symbols
(defun explode (object &aux (str (make-string 1)))
  (map 'list #'(lambda (char)
		  (setf (aref str 0) char)
		   (intern str))
       (with-output-to-string (s)
	 (prin1 object s))))

---
Barry Margolin
Thinking Machines Corp.

barmar@think.com
seismo!think!barmar

Article 383 of 384, Thu 07:46.
Subject: Re: Implode, explode and Common Lisp
From: spe@spice.cs.cmu.edu (Sean Engelson)
Path: ucbcad!zen!ucla-cs!rutgers!rochester!pt!spice.cs.cmu.edu!spe
Organization: Carnegie-Mellon University, CS/RI
Newsgroups: comp.lang.lisp
Date: 6 Aug 87 14:46:13 GMT
Reply-To: spe@spice.cs.cmu.edu (Sean Engelson)



; Implode:
; Turn a list of things into a symbol whose print-name is the
; concatenation of the printed representations of these things.

(defmacro implode (list)
  `(intern (format nil "~{~A~}" ,list)))


; Explode:
; Turn a symbol into a list of characters

(defmacro explode (sym)
  `(coerce (string ,sym) 'list))
--

Credo, ergo absurdum est.

LISP ::=
   ((())((Lots(())))(()(()(of(((Idiotic)())()()(Silly(()))()(Parentheses))))))
----------------------------------------------------------------------
Sean Philip Engelson			I have no opinions.
Carnegie-Mellon University		Therefore my employer is mine.
Computer Science Department
----------------------------------------------------------------------
ARPA: spe@spice.cs.cmu.edu
UUCP: {harvard | seismo | ucbvax}!spice.cs.cmu.edu!spe

Article 384 of 384, Thu 13:34.
Subject: Re: Implode, explode and Common Lisp
From: jeff@aiva.ed.ac.uk (Jeff Dalton)
Path: ucbcad!ames!rutgers!husc6!seismo!mcvax!ukc!its63b!aiva!jeff
Organization: Dept. of AI, Univ. of Edinburgh, UK
Newsgroups: comp.lang.lisp
Date: 6 Aug 87 20:34:54 GMT
Reply-To: jeff@uk.ac.ed.aiva (Jeff Dalton)

In article <1840@chalmers.UUCP> sundin@chalmers.UUCP (Ulf Sundin)
writes:
> I intend to translate a rather large Franz Lisp program
> to Common Lisp. However, some parts of the progeram relies
> heavily on the use of 'implode' and 'explode' for which
> no equivalents are defined in Common Lisp.

I wrote the following code a while ago and have used it with some
success.

;;; Implode, explode, and friends
;;;
;;; Jeff Dalton, AIAI, University of Edinburgh
;;;
;;; In Franz, a character can be represented by either (1) a symbol with
;;; that character as the first character of its print name, or (2) the
;;; (ascii) value of that character as a fixnum.  So we have to handle
;;; all of these.  Actually, we accept only symbols with one character
;;; in their print name.
;;;
;;; Coercion and conversion in Common Lisp can be a pain because it is
;;; not always clear which function will do the trick.  For example,
;;; (coerce #\a 'string) is an error; you have to use (string #\a).
;;;  For some reason, the powers of 'string' and 'coerce' are reversed
;;; for sequences: 'string' applied to a sequence of characters gives
;;; an error, but 'coerce' will in fact coerce it.
;;;
;;; Note: we use the '->' convention for naming conversion functions
;;; (a la T).


;;; conversions to Franz forms

(defun char->fixnum (ch) (char-code ch))	;ignore bits and font

(defun char->symbol (ch) (intern (string ch)))  ;assumes *package* is OK


;;; conversions from Franz forms

(defun franz-char->char (fch)
  ;; works for all the cases we need, and for single-char strings.
  (coerce fch 'character))


;;; the Franz functions

(defun explode (x)
  (map 'list #'char->symbol (prin1-to-string x)))

(defun aexplode (x) (explode x))

(defun explodec (x)
  (map 'list #'char->symbol (princ-to-string x)))

(defun aexplodec (x) (explodec x))

(defun exploden (x)
  (map 'list #'char->fixnum (princ-to-string x)))

(defun aexploden (x) (exploden x))

(defun implode (x)
  (intern
   (map 'string #'franz-char->char x)))

(defun maknam (x)
  (make-symbol
   (map 'string #'franz-char->char x)))

(defun printlist (x) (explode x))	;not actually in Franz?

(defun readlist (x)			;seldom used?
  (read-from-string
   (map 'string #'franz-char->char x)))


;;;; Other Character and String operations

(defun getchar (symbol-or-string n)
  (char->symbol (schar (string symbol-or-string) (1- n))))

(defun nthchar (x n) (getchar x n))

(defun getcharn (symbol-or-string n)
  (char->fixnum (schar (string symbol-or-string) (1- n))))

(defun concat (x y &rest more-args)
  (intern
   (apply #'concatenate 'string
	  (string x) (string y) (mapcar #'string more-args))))


Jeff Dalton,                          JANET: J.Dalton@uk.ac.ed
AI Applications Institute,            ARPA:  J.Dalton%uk.ac.ed@cs.ucl.ac.uk
Edinburgh University.                 UUCP:  ...!ukc!ed.ac.uk!J.Dalton

From franz!ucbvax.berkeley.edu!cox Tue Sep 15 08:32:15 1987
Return-Path: <franz!ucbvax.Berkeley.EDU!cox>
Date: Tue, 15 Sep 87 03:15:23 PDT
From: franz!ucbvax.berkeley.edu!cox (Charles A. Cox)
To: comp-lang-lisp
Subject: comp.lang.lisp


Article 455 of 456, Mon 14:03.
Subject: Reply to Franz --> Common
From: kumard@sunybcs (Deepak Kumar)
Path: decvax!sunybcs!kumard
Organization: SUNY/Buffalo Computer Science
Newsgroups: comp.lang.lisp
Date: 14 Sep 87 21:03:19 GMT
Sender: nobody@sunybcs.UUCP
Reply-To: kumard@sunybcs.UUCP (Deepak Kumar)



	We have been doing major conversion of our Franz software to
	Common. We have a list of some common functions that need to be
	changed. Also, be careful about the scoping (Franz has dynamic
	scoping where as Common has static. However, by using the SPECIAL
	declaration, one can  have dynamic scoping in Common.

	How fast you will be able to convert depends on how good your
	Franz code is. If your code uses subtle Franz bindings/ lexpers/
	dynamic variables/ closure, it will be a big task. Because of these
	difficulties it is very hard to write a conversion program to
	automate the translation. However, if the programs are large, it
	is a good idea to write small tools like one that prints a calling
	tree of the Franz program, to detect any dynamic variable refs.

	Good Luck. Here's some conversions that we have managed to track:

	probelm : setsyntax

	problem : errset

	problem : signal

	<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>

		Franz-lisp				Common-lisp
		----------				-----------

	(add1 a)			(+ a 1)

	(ascii u)			(int-char u)

	(assoc a b)			(assoc a b :test #'equal)

	(assq a b)			(assoc a b :test #'eq)

	(concat a b)			(intern (concatenate 'string
						  (prin1-to-string a)
						  (prin1-to-string b)))

	(drain)				(finish-output)

	(dtpr u)			(consp u)

	(error 'error text')		(error "error-text")

	(filepos u)			(file-position u)

	(getd u)			(symbol-function u)

	(lineread u)			(read-line u nil nil)

	(makereadtable nil)		(copy-readtable)

	(mapc '(lambda ...))		(mapc #'(lambda...))

	(member a b)			(member a b :test #'equal)

	(memq a b)			(member a b :test #'eq)

	(msg ...)			(princ (format nil ...))

	(nthelem n s)			(nth (- n 1) s)

	(openfile 'filename 'r)		(open 'filename :direction :input)

	(patom u)			(princ u)

	piport				*standard-input*

	poport				*standard-output*

	(plist a)			(symbol-plist a)

	(princ u)			(princ u) t

	(Princ u)			(princ u)(terpri) t   <=> (|myPrinc| u)

	(print u)			(prin1 u) nil

	(Print u)			(prin1 u)(terpri) nil <=> (|myPrint| u)

	(probef u)			(probe-file u)

	$prpr				pprint

	(ptime)				(list (get-internal-run-time)
					      (get-gc-run-time))

	(putd 'cubed '(lambda (x)	(setf (symbol-function 'cubed)
		      (times x x x)))        '(lambda (x) (* x x x)))

	(putprop a b c)			(setf (get a b) c)

	(read u)			(read u nil nil)

	(readc u)			(read-char u)

	(readlist <list> )		(read-from-string <string> )

	(setplist a b)			(setf (symbol-plist a) b)

	(tyipeek u)			(peek-char nil u nil -1)

	(uconcat a b)			(make-symbol (concatenate 'string
						       (prin1-to-string a)
						       (prin1-to-string b)))
	--
	kumard@gort.cs.buffalo.EDU
	kumard@sunybcs.BITNET
	kumard@sunybcs.UUCP
	Deepak Kumar, Dept. of CS, 226 Bell Hall, SUNY@Buffalo, NY 14260.


kumard@gort.cs.buffalo.EDU
kumard@sunybcs.BITNET
kumard@sunybcs.UUCP
Deepak Kumar, Dept. of CS, 226 Bell Hall, SUNY@Buffalo, NY 14260.

Article 458 of 458, Tue 03:13.
Subject: Franz to Common Lisp Translation (FTOC)
Keywords: macro expansion reduction rewrite
From: adams@crcge1.UUCP (Drew Adams)
Path: sdcsvax!ucsdhub!esosun!seismo!mcvax!unido!ecrcvax!crcge1!adams
Newsgroups: comp.lang.lisp
Date: 15 Sep 87 10:13:15 GMT

We have a Franz-TO-Common Lisp translation program (FTOC) written three
years ago.  It's written in Common Lisp and has run under Kyoto CL and
Sun CL.  It's basically a macro expander and consists of a (*large*)
collection of rewrite rules in the form of macros.  A rule specifies
the CL form that corresponds to a given input Franz Lisp form.  These
defining macros have not been tested out completely, and there may of
course be more than one "correct" or desirable translation for any given
form.  A few definitions are known to be incorrect.  It is in general a
simple matter to change such translation rules.  Aside from the correction
of particular definitions, the general functioning of the program
has been tested.  FTOC was written for an older Franz version (38, 39,
40?), before Franz included such things as packages and keywords.

Naturally, completely automatic translation Franz -> Common is
impossible.  FTOC tries to remain conservative and not second-guess
the programmer's original intent, which means that the resultant CL
code is often unduly wordy, (simulating Franz's type-checking of
numbers etc.)  The bottom line is that FTOC may be useful for a first
pass (i.e. an *aid* to translation).  It may also be useful interactively
as an aid to Franz programmers converting to Common habits: typing in
a Franz expression allows a quick view of a possible Common correspondant.

Example of wordiness: (+ 2 (+ 3 (+ 4 1))) in Franz is translated to:

(flet ((franz.+ (&optional (n 1 0) &rest n2etc)
	"equivalent to Franz Lisp '+'."
	(check-type n fixnum)
	(mapc #'(lambda (n) (check-type n fixnum)) n2etc)
	(if (endp n2etc) n1 (+ n1 (reduce #'+ n2etc)))))
      (franz.+  2
                (flet ((franz.+ (&optional (n 1 0
		         .... and so on ...

		      (franz.+  3
		                (flet ((  ... and so on ....

				      (franz.+  4 1))))))

Such a translation is of course generally absurd, or at least of
questionable utility.  At least it's possible to easily locate such
absurdities (via the name "franz.+") and replace them by whatever
the programmer really did intend.  As the translation is done via
rewrite rules, it would of course be easy to replace such conservative
translation by rules assuming a little "common sense" at the risk of
occasional blunders.

Whenever an expression translation is straightforward and the input
may clearly be recognized in the output, simple replacement is done,
rather than creating a temporary (flet) function such as "franz.+".
Thus, e.g., "(typep ...)" is simply translated to "(type-of...)".
Some expressions are simply untranslatable and a translation error
is signalled.  Examples of such functions are UNIX system calls etc..

An example of a rewrite rule is:

	(typep type-of NIL
	       ((x)
	        `(type-of  ,x)))

	The items in this list are:
	1. The FL function name					typep
	2. The corresponding CL name or "nil" if no simple 	type-of
	   correspondance holds (used in translations of
	   "quote" and "function")
	3. A flag indicating whether ("t") or not ("nil") 	nil
	   the CL calling sequence is different from the FL
	   sequence (e.g. different argument order)
	   (used in translations of "quote" and "function")
	4. The parameter list of the FL function		(x)
	5. The translation rule proper			     `(type-of ,x)

The macros used as rewrite rules are local (similar to "macrolet"
definitions), so that there is no problem of interference with CL
names in the current environment that may be the same as Franz names
(but e.g. with different arguments).

Aside from function (macro etc.) applications, special symbols are
translated via lookup in a separate table.  Thus, e.g., "errport"
is translated to "*error-output*".

Some general translation problems include:

	* STATIC VS. DYNAMIC SCOPING: This is of course the single
	  biggest headache and FTOC makes no attempt to wrestle
	  with the problem.  It is (wisely?) ignored; i.e. it must
	  be dealt with manually.

	* TYPE PREDICATES, after translation, refer to *CL* types.
	  E.g. Franz's "(bigp...)" is translated to CL's
	  "(typep bignum...)".

	* CODE WHICH CREATES CODE ETC.: Macros in the code may
	  optionally by expanded at translation time.  Otherwise,
	  code-creating code continues to create *Franz* code at
	  execution time.

	* FUNCTION NAMES AS ARGUMENTS ETC.: Translating mapped etc.
	  named functions is straightforward as long as the function
	  name itself may be simply translated.  Thus, "typep" goes
	  over into "type-of", but "+" has no single named function
	  equivalent.  Such translation of function names is done while
	  translating "quote" and "function" expressions.  If no
	  single name applies no translation of the name occurs and
	  a warning is issued.

	* USER-DEFINED RESERVED NAMES: A Franz programmer may have
	  defined her own function or other object with a name which
	  is reserved (predefined) in CL (e.g. "write").  FTOC does
	  not currently check for such names.  Such detection could
	  easily be added, but it would surely be costly in
	  translation time.  Such a check might better be done in a
	  separate pass only when it is suspected to be necessary.

Various modes of use of FTOC are available.

FTOC is made freely available for "test purposes", which means it
can be used, isn't guaranteed and won't be maintained by us and
can't be sold, copied, distributed etc. by others.  The source is
copyrighted.

Comments on and improvements to the program are welcomed.

----------
Drew ADAMS, Laboratoires de Marcoussis, Centre de Recherche de la Compagnie
            Generale d'Electricite, Route de Nozay, 91460 MARCOUSSIS, FRANCE
            Tel. 64.49.11.54, adams@crcge1.cge.fr

From adams@crcge1.UUCP Fri Jun  2 09:13:34 1989
To: fi-comp-lang-lisp%clay@hall.cray.com
Article: 2007 of 2010 in comp.lang.lisp
Path:ucbvax!tut.cis.ohio-state.edu!cs.utexas.edu!uunet!mcvax!inria!crcge1!adams
From: adams@crcge1.UUCP (Drew Adams)
Newsgroups: comp.lang.lisp
Subject: Re: Translating Franz Lisp to Common
Keywords: lisp, franz, common
Date: 1 Jun 89 13:35:39 GMT
References: <1196@cayman.cme.nbs.gov>
Reply-To: adams@crcge1.UUCP (Drew Adams)
Organization: Laboratoires de Marcoussis (CGE) - France
Lines: 99

In article <1196@cayman.cme.nbs.gov> kramer@cme.nbs.gov (Tom Kramer) writes:
>
>Around the end of 1988 I inquired from Franz, Inc. whether they had any
>programming aids to give to users for translating Franz to Common.  They
>did not.
>I have not heard of a translator program.  To write a translator that would
>handle a moderately complex (50 twenty-line functions) software system in
>Franz with only a few errors and inefficiencies, would take several months
>solid work, I think.
---------------------------------------

In 1984 I wrote a translator program, FTOC (Franz To Common), which has been
used a bit here and elsewhere, since.  It (source) is available to anyone for
"research" (i.e. non-commercial) purposes.  It was written for an
old version of Franz (I forget which).  The basic program works fine, but
its correctness depends on the correctness of the set of rewrite rules used
to define the language-language translation.  These could be improved, and
some are even known to be incorrect.  No guarantees are made, of course.

The program works by simple macro-expansion (but not evaluation), i.e.
"reduction".  It may also be used for any other (Lisp-like) language-language
translation.  (You'll need to define the rewrite rules.  Yes, THAT is a lot
of work -- it means translating every language expression, if you want a
"complete" translator.)

No translation program is satisfactory, obviously (there are lots of
untranslatable things).  FTOC tries to be prudent, rather than clever;
whenever possible it tries to maintain the semantics of the original code,
rather than "optimizing".  Different, more liberal, rewrite rules could of
course be used.

FTOC is written in Common Lisp, and has run on VAX with VAX-VMS Common Lisp,
and on Sun with KCL and Lucid.  No claims on portability are made, but I
don't recall it using any implementation-dependent features.  FTOC does use
the Common Lisp reader, so some porting problems may arise regarding character
case, filenames etc.

FTOC may be used interactively, as well, as a sort of (slow) Franz front end
to Common.  This is sometimes useful when Franz programmers start to learn
Common -- Franz expressions may be translated on the fly and, optionally,
executed in Common.

In addition to the source, a User's Guide is available.  I will try to
respond to requests for the program promptly, but I'm a bit overloaded
with work, so ...

A few remarks:

	FTOC should be regarded as an AID to translation, rather than an
	automatic translator.

	The biggest difference between Franz and Common is that Common uses
	static scoping of variables (in general).  Franz code which depends
	on dynamic scoping cannot, generally, be translated (automatically).
	FTOC makes no attempt to wrestle with this problem; it is ignored.

	Type predicates, after translation, refer to COMMON Lisp types.
	For example, the Franz predication (BIGP ...) is translated to
	the Common predication (TYPEP BIGNUM ...)

	Franz code which manipulates or produces CODE which is SPECIFICALLY
	Franz will normally NOT work, of course, after translation to COMMON.
	However, FTOC users may optionally choose to have macro definitions
	expanded during translation.  This may help in some cases.

	Whenever an expression translation is not straightforward (the
	result isn't immediately recognizable as a translation of the input
	by the programmer), the result code is enveloped and labelled for
	recognition, with an FLET.  That is, temporary named functions are
	created, whose names correspond to the source code names (prefixed
	by "FRANZ").  Further info on the correspondance is available using
	the Common Lisp function DOCUMENTATION.

Finally to show one of the worst kinds of thing that can happen, because
of the desire not to modify the original semantics, here is the Common Lisp
code resulting from the Franz expression (+ 2 (+ 3 (+ 4 1))):
[Things aren't normally this bad!]

   (flet ((franz.+ (&optional (n1 0) &rest n2etc)
          "equivalent to Franz Lisp '+'."
	  (check-type n1 fixnum)
	  (mapc #'(lambda (n) (check-type n fixnum))
	        n2etc)
          (if (endp n2etc)
	  n1
	  (+ n1 (reduce #'+ n2etc)))))
      (franz.+
         2
	 (flet [.... AS ABOVE ...]

	    (franz.+
	       3
	       (flet [.... AS ABOVE ...]

	          (franz.+ 4 1))))))
--
Drew ADAMS, Laboratoires de Marcoussis, Centre de Recherche de la Compagnie
            Generale d'Electricite, Route de Nozay, 91460 MARCOUSSIS, FRANCE
            Tel. 64.49.11.54, adams@crcge1.cge.fr


From kend@tekchips.LABS.TEK.COM Fri Jun  2 09:15:09 1989
To: fi-comp-lang-lisp%clay@hall.cray.com
Article: 2010 of 2010 in comp.lang.lisp
Path: ucbvax!tut.cis.ohio-state.edu!cs.utexas.edu!uunet!zephyr!tektronix!tekcrl!tekchips!kend
From: kend@tekchips.LABS.TEK.COM (Ken Dickey)
Newsgroups: comp.lang.lisp
Subject: Re: Translating Franz Lisp to Common
Keywords: lisp, franz, common
Date: 1 Jun 89 19:32:53 GMT
References: <1196@cayman.cme.nbs.gov>
Sender: ftp@tekcrl.LABS.TEK.COM
Reply-To: kend@tekchips.LA.TEK.COM (Ken Dickey)
Organization: Tektronix, Inc., Beaverton,  OR.
Lines: 13

In article <1196@cayman.cme.nbs.gov> kramer@cme.nbs.gov (Tom Kramer) writes:
>
>I have translated a few hundred lines of Franz Lisp code into Common Lisp.
...

You might be interested in "Porting Pan I to Allegro COMMON Lisp",
Darrin Lane, Report # UCB/CSD 88/453, September, 1988 {U of Calif.,
Berkeley}.  It describes a port of an 18000 line program from Franz
to Allegro and covers file & buffer i/o, keystroke handling, etc. and
has a set of example macros in the appendix.  Not a panacea, but seems
a reasonable description of the issues.

-Ken Dickey


From kramer@cme.nbs.gov Fri Jun  9 10:03:53 1989
To: fi-comp-lang-lisp@franz.uucp
Article: 2030 of 2032 in comp.lang.lisp
Path: ucbvax!tut.cis.ohio-state.edu!cs.utexas.edu!uunet!cme!kramer
From: kramer@cme.nbs.gov (Tom Kramer)
Newsgroups: comp.lang.lisp
Subject: Translating Franz to Common
Keywords: lisp, franz, common, translate
Date: 8 Jun 89 21:29:54 GMT
Organization: National Institute of Standards & Technology, Gaithersburg, MD
Lines: 281

I have been trying to send the following to many requestors, but my mailer
keeps returning it.  Oddly, mail to Hawaii, Canada, and Denmark has been
delivered, but nothing to the continental US seems to go through.

I hope those who have asked for this will be able to pick it up from this
message.

         COMPARISON OF FRANZ LISP WITH COMMON LISP
                      T. Kramer 5/25/89


This is a comparison of Franz and Common LISP functions.  It is intended
to be useful to programmers who want to rewrite existing Franz LISP code
in Common LISP (and vice versa, if there are any such people).

It is divided into four sections:
1. Franz Functions Not in Common
2. Franz Functions that Work (Almost) the Same in Common
3. Franz Functions that Work Differently in Common
4. Common Functions Not in Franz

This comparison includes about 200 functions but is not complete.
Section 4, in particular, contains only a small fraction of the entries
it could have.

Each entry has been kept to one line for the sake of brevity.  A full
understanding of differences might require up to a page for some entries,
so do not take this material as gospel.  The comparison is most useful
as a pointer to what to read about in the Franz and Common Manuals.

Franz Allegro, release 3, Common LISP was used for preparing this
comparison.  I suppose it will be almost completely valid for other
Common LISPS but have not checked.

Corrections, additions, and comments are welcome.  There are no known
errors in this comparison, but there are bound to be some.

T. Kramer
NIST
Rm. A-127, Building 220
Gaithersburg, MD 20899
E-mail to: kramer@cme.nbs.gov


1. Franz Functions Not in Common
--------------------------------

add1 (use 1+)
array (use make-array)
arrayref (use aref)
ascii (use char-code)
concat (write your own using read-from-string)
copy (called copy-tree in common, also see copy-alist, copy-list)
def (use defun)
diff (use -)
drain (use finish-output or force-output)
explode
explodec
exploden
fact (no equivalent)
fake (no equivalent)
fix (use truncate or round)
fixp (use integerp or typep)
getd (use symbol-function)
get-pname (use symbol-name)
implode
implodes
infile (use open or with-something)
lessp (use <)
maknum
minus (use -)
msg (use format)
neq (use not with eq)
nequal (use not with equal)
new-vectori-... (no equivalent)
nthchar (use elt with index decreased by 1)
nthelem (use nth or elt with index decreased by 1)
numbp (use numberp)
outfile (use open or with-...)
patom (use princ)
pp-form (use pprint)
probef (use probe-file)
ptr (no equivalent)
putprop (use setf and symbol-plist)
readc (use read-char)
readline (use read-line)
readlist (no equivalent)a
resetio
setplist (use setf and symbol-plist)
sortcar (use sort with :key set to car)
strcat (No equivalent. Write your own using concatenate and princ-to-string)
string-length (use length or array-total-size)
substring (use subseq)
sub1 (use 1-)
tab (try format with a "~numberT" control string. Does not work for me.)
terpr (use terpri)
tyipeek (use peek-char)
vectori-... (no equivalent)
vref (use aref)
vrefi-... (no equivalent)
vseti-... (no equivalent)



2. Franz Functions that Work (Almost) the Same in Common
--------------------------------------------------------

abs (common but not Franz handles complex arguments)
acos (common but not Franz handles complex arguments)
and
append
apply
asin (common but not Franz handles complex arguments)
atan (common has more options)
atom
butlast (exists in Franz but is not documented)
car
case
cdr
c...r (in common, up to four a's and d's work, in Franz, any number)
chdir
cond
cons
cos (common but not Franz handles complex arguments)
defmacro (common has more options)
defsetf
defun (common has more options)
do (common allows declarations and use of tags, like prog)
do* (same exceptions as do)
eighth (exists in Franz but is not documented)
eq
equal (common handles more types of data)
error
evenp
exp (common handles any number)
expt (common handles any number)
fifth (exists in Franz but is not documented)
first (exists in Franz but is not documented)
float
fourth (exists in Franz but is not documented)
funcall
gensym
go (common can use it in more situations)
identity (exists in Franz but is not documented)
if (common has fewer options)
intersection (exists in Franz but is not documented)
last
ldiff
length
let
let*
list
listp
log (common has an optional base argument)
makunbound
mapc
mapcan
mapcar (in common the arguments do not have to be the same length)
mapcon
max
merge
min
minusp
mod (common handles any number types, Franz only integers)
nbutlast (exists in Franz but is not documented)
nconc
nintersection (exists in Franz but is not documented)
ninth (exists in Franz but is not documented)
not
nreconc
nreverse
nth
nthcdr
null
numberp
oddp
or (in common multiple values may be returned from last argument)
plusp
pop
pp (exists in common but is not documented)
princ
prog (in common prog variables may be initialized)
progn
push
quote
read (options differ in common)
remprop (except first argument must not be a list - see remf)
rest (exists in Franz but is not documented)
return
reverse
rplaca
rplacd
second (exists in Franz but is not documented)
set
setf (common handles many more situations)
setq
seventh (exists in Franz but is not documented)
sin (common but not Franz handles complex arguments)
sixth (exists in Franz but is not documented)
sort (common has more options)
sqrt (common handles any number, Franz only non-negative reals)
string-capitalize
string-downcase
string-upcase
subst (common has more options)
symbol-function
symbol-name
tailp
tenth (exists in Franz but is not documented)
terpri
third (exists in Franz but is not documented)
union (exists in Franz but is not documented)
y-or-n-p
zerop (except argument must be a number in common)
1+
+ (common handles all types of numbers)
- (common handles all types of numbers)
* (common handles all types of numbers)
> (common handles more number types)
>= (common handles more number types)
= (common handles more number types)
< (common handles more number types)
<= (common handles more number types)
' (the quote function)



3. Franz Functions that Work Differently in Common
--------------------------------------------------

boundp (returned value differs if bound)
break (fairly similar to Franz)
close (common returns nil, Franz t)
delete (common has many options)
eval (Same at top level. In functions Franz uses local values, common global)
get (common does not handle gets from disembodied plists)
load (common looks for different suffixes)
loop (Franz version is fancy, common is simple)
map
member (common has more options)
nunion (not documented in Franz, but results differ from common sometimes)
print (prints newline and space as well as argument)
remove (common does much more)
throw (argument order reversed)
vector (the data type differs between Franz and common)



4. Common Functions Not in Franz (a small fraction of such functions)
--------------------------------

acosh (no equivalent)
aref (use arrayref)
atanh (no equivalent)
cosh (no equivalent)
denominator (no equivalent)
elt (use nth or nthchar with arguments reversed)
getf (use get after consing a dummy on the front of the list)
get-setf-method (use (get function_name 'setf-expand))
isqrt (no equivalent)
lcm (no equivalent)
make-array (use array or marray)
make-list (no equivalent)
make-string (no equivalent)
notevery (no equivalent)
numerator (no equivalent)
pathname (no equivalent)
pathname-... (no equivalent)
peek-char (use tyipeek)
phase (no equivalent)
position (no equivalent)
pprint (use pp or pp-form)
print-to-string
prog* (no equivalent, use prog)
read-char (use readc)
read-line (use readline)
sinh (no equivalent)
some (no equivalent)
tan (no equivalent)
tanh (no equivalent)
write (use print, princ, etc.)


From jeff@aiai.ed.ac.uk Mon Aug 20 10:35:28 1990
From: jeff@aiai.ed.ac.uk (Jeff Dalton)
Newsgroups: comp.lang.lisp,comp.lang.lisp.franz
Subject: Re: Trying to convert from Franz to Common lisp
Keywords: fexpr, lexpr needed
Date: 17 Aug 90 16:46:02 GMT
Reply-To: jeff@aiai.UUCP (Jeff Dalton)
Organization: AIAI, University of Edinburgh, Scotland

In article <13416@sun.udel.edu> vandyke@sun.udel.edu (Julie A Vandyke) writes:
>I am needing a common lisp implementation of fexpr and lexpr.
>Does anyone have or know of one before I work on the
>problem myself? I'd love to save myself some effort.
>
>Thanx in advance for any help-
>
>Email please, as I do not usually read this newsgroup.

I also e-mailed this (plus some other Franz hacks) but thoght
this might be of general interest.  I wrote this code long
ago so I can no longer remember for sure whether it all works.

------------------------------

;;;; def
;;;
;;; This is one way to let people define nlambdas (fexprs), lexprs, and
;;; vanilla (non-defmacro) Franz macros.  'Apply' will work with lexprs
;;; but not with fexprs or macros
;;;

(defmacro def (name (type formals &body body))
  (case type
    (lambda
     `(defun ,name ,formals ,@body))
    (nlambda
     (if (/= (length formals) 1)
	 (error "Def: fexpr ~S must have exactly one formal parameter." name))
     (let ((real-name
	    (intern (concatenate 'string "REAL-" (symbol-name name)))))
       `(progn
	 (defun ,real-name ,formals ,@body)
	 (defmacro ,name (&rest .fexpr-args.)
	   `(funcall #' ,',real-name ', .fexpr-args.)))))
    (lexpr
     (if (/= (length formals) 1)
	 (error "Def: lexpr ~S must have exactly one formal parameter." name)
	 `(defun ,name (&rest .lexpr-args.)
	    (let* ((.lexpr-nargs. (length .lexpr-args.))
		   (,(first formals) .lexpr-nargs.))
	      ,@body))))
    (macro
     (if (/= (length formals) 1)
	 (error "Def: macro ~S must have exactly one formal parameter." name)
	 `(defmacro ,name (&rest ,(first formals))
	    (setq ,(first formals)		;/\/ hack for Kyoto
		  (cons ',name ,(first formals)))
	    ,@body)))
    (t (error "Def: ~S is not a valid function type for function ~S."
	      type name))))

;;;; lexpr extras
;;;
;;; These are macros so they can reference '.lexpr-args.' despite
;;; lexical scoping (hee hee).
;;;

(defmacro arg (&optional (n nil n-p))
  (if n-p
      `(elt .lexpr-args. ,n)	;? might want to do our own length check?
      `(progn .lexpr-nargs.)))	;not just a variable so can't be set

------------------------------

Jeff Dalton,                      JANET: J.Dalton@uk.ac.ed
AI Applications Institute,        ARPA:  J.Dalton%uk.ac.ed@nsfnet-relay.ac.uk
Edinburgh University.             UUCP:  ...!ukc!ed.ac.uk!J.Dalton


----------------------------------------------------------------------


Section 4. ADD-ON PRODUCTS/FEATURES
===================================

4.1: Emacs-Lisp interface
-------------------------

----------------------------------------------------------------------
Q) I can't seem to type lines with more than 256 characters at Lisp
running within the Emacs interface.  Why not?

A) This limitation has been corrected starting with version 2.0.16 of
the emacs-lisp interface.  Lisp interaction buffers by default now use
a socket rather than a pseudo tty to communicate to the ACL process.
This eliminated any remaining bad behavior with very long input lines
as well as problems with special tty-control characters in the input.

The problem you discovered with emacs echoing `^G's (bells) after 256
characters on a single line to a shell process is actually neither a
lisp problem nor an emacs problem, but rather a shell input problem.

You can reproduce this exact same behavior outside of both emacs and lisp
by just typing the following at the shell:

 % cat > /tmp/foo

and then start typing any characters (*except* delimiters such as
newline or return).  You'll start hearing the bell after 256
characters and there won't be any way to clear it other than to hit
your interrupt key.

Since emacs uses the shell to run subprocesses such as lisp, it is
subject to this same limitation--you can't directly stuff to a shell
subprocess character streams of more than 256 characters without a
line break.

Fortunately, if you are using fi:common-lisp from our emacs/lisp
interface, you can stuff arbitrarily long expressions by using
`fi:lisp-eval-or-compile-defun' which is normally bound to the key
`ESC C-x'.  The reason this works while doing direct "stuffs" doesn't
is that `ESC C-x' writes the input to a temporary file and then tells
lisp to compile and load that file, thereby achieving the same result.

For example, if I have the following in a common-lisp-mode buffer:

(setq xxx '(THE TERM "Products" SHALL MEAN ONLY THOSE ITEMS THAT ARE IDENTIFIED IN "Appendices A" :COMMA B OR "C. Buye" R AGREES TO ACCEPT THIS AUTHORIZATION SUBJECT TO THE TERMS AND CONDITIONS OF THIS "Agreement" :COMMA INCLUDING THOSE TERMS AND CONDITIONS SET OUT ))

I can put the cursor anywhere inside that expression, type `ESC C-x',
the form is compiled (a *background-interaction* buffer shows a
warning about symbol XXX being declared special) and then my lisp
buffer will show:

<cl> xxx

(THE TERM "Products" SHALL MEAN ONLY THOSE ITEMS THAT ARE ...)
<cl>

Note also that the pty limitation itself will go away for
*common-lisp* buffers with Emacs-Lisp interface release 2.0.12.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q)  Why do I get the "A background eval/compile request is
    pending, please wait..." message when doing an eval/compile in
    a Lisp buffer?

A) There are two reasons why the "please wait..." message is printed in
the minibuffer and eval/compile commands are deferred:  1) either
there is an error in a *background-interaction* buffer, or 2) you've
run into a bug in the emacs-lisp interface (fixed by a patch included
below).

1. When an error occurs on a background stream (the stream in the
"background" that reads and evals evaluation and compilation
requestions from GNU Emacs), the *background-interaction* buffer is
pop'd up with a lisp listener containing the error.  While this
process is active and exists, more evaluation requests cannot be
processed.  Typing ``:reset'' or ``:cont ...'' in this buffer will end
the process by throwing out of it or continuing the computation and
will allow further evaluation requests to be processed.

  NOTE: strange behaviour is known to occur if you merely just kill
	the *background-interaction* without typing :reset or :cont.

2. Replace the definition of fi::eval-region-internal in lisp/fi/lze.el
with the one below.  Don't forget to M-x byte-recompile-directory,
too.

(defun fi::eval-region-internal (start end compilep &optional ignore-package)
  (fi::error-if-request-in-progress)
  (fi::note-background-request compilep)
  (let ((buffer (current-buffer)))
    (fi::make-request
	(lep::evaluation-request
	 :text (buffer-substring start end)
	 :echo fi:echo-evals-from-buffer-in-listener-p
	 :partialp (not (and (eq (max start end) (point-max))
			     (eq (min start end) (point-min))))
	 :pathname (buffer-file-name)
	 :compilep (if compilep t nil))
      ((buffer compilep) (results)
	(save-excursion
	  (set-buffer buffer)
	  (fi::note-background-reply (list compilep))
	  (when results
	    (fi:show-some-text nil results))))
      ((buffer compilep) (error)
	(save-excursion
	  (set-buffer buffer)
	  (fi::note-background-reply (list compilep))
	  (message "Error during %s: %s"
		   (if compilep "compile" "eval")
		   error)))
      ignore-package)))

The patch in (2) is only needed if the elisp variable
fi:emacs-lisp-interface-version is "2.0" (this bug will be fixed in
version 2.0.1).
----------------------------------------------------------------------


----------------------------------------------------------------------
Q)  How can I get the ACL 4.1 emacs-lisp interface to
    work with epoch 4.0 and 4.1?

A) ACL 4.1 was released before Epoch 4.0 existed, and the emacs-lisp
interface with ACL 4.1 will not work "as is" with Epoch 4.0.  However,
a replacement for lisp/fi/leep.el will enable the interface to work.

How to install the patch: move the original lisp/fi/leep.el to a safe
place (leep.el-orig) and install the file below in its place.  Then,
in the lisp/fi directory, type "make".  This should recompile leep.el
into leep.elc.

;; Copyright (c) 1987-1991 Franz Inc, Berkeley, Ca.
;;
;; Permission is granted to any individual or institution to use, copy,
;; modify, and distribute this software, provided that this complete
;; copyright and permission notice is maintained, intact, in all copies and
;; supporting documentation.
;;
;; Franz Incorporated provides this software "as is" without
;; express or implied warranty.

;; $Header: faq,v 1.71 1995/10/03 17:12:16 handler Exp $

;; The epoch side of presentations in a lisp-listener window.

(defvar fi::epoch-has-zones nil)

(if (and (boundp 'epoch::version)
	 (string-match "Epoch 4.0" epoch::version))
    (setq fi::epoch-has-zones t)
  (setq fi::epoch-has-zones nil))

(defvar fi::highlighted-zone-style nil)
(defvar fi::highlighted-style nil)

(defvar fi::highlighted-zone-color "slategray")

(unless fi::epoch-has-zones
  (defun make-style ()
    (epoch::make-style))

  (defun epoch::move-zone (a b c)
    (epoch::move-button a b c))

  (defun epoch::make-zone ()
    (epoch::make-button))

  (defun epoch::set-zone-read-only (a b)
    (epoch::set-button-read-only a b))

  (defun epoch::set-zone-style (a b)
    (set-button-attribute a b))
  )

(defun fi::initialize-for-presenting-listeners ()
  (setq fi::highlighted-style (make-style))
  (if (and fi::highlighted-zone-color
	   fi::epoch-has-zones
	   (fboundp 'epoch::number-of-colors)
	   (> (epoch::number-of-colors) 2))
      (epoch::set-style-background fi::highlighted-style
				   fi::highlighted-zone-color)
    (epoch::set-style-background fi::highlighted-style (epoch::background)))

  (unless fi::epoch-has-zones
    (when fi::highlighted-zone-style
      (release-attribute fi::highlighted-zone-style))
    (setq fi::highlighted-zone-style (reserve-attribute)))

  (epoch::set-style-foreground fi::highlighted-style (epoch::foreground))

  (epoch::set-style-underline fi::highlighted-style
			      (if (and fi::highlighted-zone-color
				       fi::epoch-has-zones
				       (fboundp 'epoch::number-of-colors)
				       (> (epoch::number-of-colors) 2))
				  nil
				(epoch::foreground)))
  (if fi::epoch-has-zones
      (progn
	(setq fi::normal-style (make-style))
	(epoch::set-style-foreground fi::normal-style (epoch::foreground))
	(epoch::set-style-background fi::normal-style (epoch::background))

	(setq fi::highlighted-zone-style fi::highlighted-style))
    (epoch::set-attribute-style fi::highlighted-zone-style
				fi::highlighted-style)))

(when (boundp 'epoch::version)
  (fi::initialize-for-presenting-listeners))

(defun composer::setup-buffer-for-presentations (buffer)
  (set-buffer buffer)
  (make-local-variable 'highlighted-presentation)
  (setq-default highlighted-presentation 'no-value) ;default value for
						    ;non-lisp buffers

  (make-local-variable 'window-stream-presentation)
  (setq window-stream-presentation (make-presentation :start 0 :end 8388607))

  (make-local-variable 'presentation-stack)
  (setq presentation-stack (list window-stream-presentation))

  (make-local-variable 'incomplete-input)
  (setq incomplete-input nil)

  (make-local-variable 'highlighted-zone)
  (setq highlighted-zone (epoch::make-zone))

  (make-local-variable 'read-only-zone)
  (setq read-only-zone (epoch::make-zone))

  (epoch::move-zone read-only-zone 1 (point-max))
  (epoch::set-zone-read-only read-only-zone t)
  (epoch::set-zone-style highlighted-zone fi::highlighted-zone-style)
  (fi:setup-epoch-gesture-bindings))

(defvar fi:default-epoch-gesture-binding-list
    (and (boundp 'epoch::version)
	 (list
	    (list 'fi:epoch-gesture-describe   mouse-left   (+ mouse-shift))
	    (list 'fi:epoch-gesture-inspect    mouse-left   (+ mouse-control))
	    (list 'fi:epoch-gesture-edit       mouse-middle 0)
	    (list 'fi:epoch-gesture-select     mouse-middle (+ mouse-shift))
	    (list 'fi:epoch-gesture-menu       mouse-right  0)))
  "*The mapping of mouse clicks onto logical gestures.
Each entry is a list of length 3: The command to send the gesture,
the numeric epoch mouse code, and the epoch numeric shifts.
The function should be defined in this way:
  (defun fi:epoch-gesture-select (x)
    (fi::interrupt-process-for-gesture ':select))")

(defun fi:setup-epoch-gesture-bindings ()
  (dolist (e fi:default-epoch-gesture-binding-list)
    (local-set-mouse (second e) (third e) (first e))))

(defun fi:epoch-gesture-select (x)
  (fi::interrupt-process-for-gesture ':select))

(defun fi:epoch-gesture-inspect (x)
  (fi::interrupt-process-for-gesture ':inspect))

(defun fi:epoch-gesture-edit (x)
  (fi::interrupt-process-for-gesture ':edit))

(defun fi:epoch-gesture-menu (x)
  (fi::interrupt-process-for-gesture ':menu))

(defun fi:epoch-gesture-describe (x)
  (fi::interrupt-process-for-gesture ':describe))

(defvar composer::init-presentations
    "(progn
      (princ \";; Converting *terminal-io* for presentations...\n\")
      (force-output)
      (setq excl::*command-table*
	    (excl::find-command-table 'lep::listener-command-table))
      (lep::mogrify-terminal-io)
      (force-output)
      (values))\n")

(defun composer::make-presenting-listener (new-screen-p)
  (when (and new-screen-p (fboundp 'create-screen))
    (let ((screen (create-screen "*listener*" epoch::screen-properties)))
      (epoch::map-screen screen)
      (epoch::select-screen screen)
      screen))
  (let* ((proc (fi:open-lisp-listener
		-1
		nil
		(function
		 (lambda (proc)
		   (concat
		    composer::init-presentations
		    (fi::setup-tcp-connection proc))))))
	 (buffer (process-buffer proc)))
    (composer::setup-buffer-for-presentations buffer)
    (set-process-filter proc 'fi::leep-subprocess-filter)
    proc))

;; The presentation-stack local variable is a stack of presentations opened
;; but not yet closed.

;; This defstruct is moved to file leep0.el because the cruftly compiler
;; doesn't understand a defstruct in the same file.

;(defstruct presentation
;  start
;  end
;  data
;  subpresentation-vector)

(defun fi::insert-string (string start end)
  (do ((p start (1+ p)))
      ((eq p end))
    (insert-char (aref string p) 1)))

(defun fi::leep-subprocess-filter (process output &optional stay cruft)
  "Filter output to buffer including presentations."
  ;;(set-buffer (process-buffer process))
  (let ((inhibit-quit t))
    (if cruft
	(setq output (fi::substitute-chars-in-string '((?\r)) output)))
    (when incomplete-input
      (setq output (concat incomplete-input output))
      (setq incomplete-input nil))
    (let* ((old-buffer (current-buffer))
	   (buffer (process-buffer process))
	   (in-buffer (eq buffer old-buffer))
	   (window-of-buffer (get-buffer-window buffer))
	   (no-window (or (null window-of-buffer)
			  (not (windowp window-of-buffer))))
	   (xmarker (process-mark process))
	   (marker (if (marker-position xmarker)
		       xmarker
		     (set-marker (make-marker) 0 buffer)))
	   (marker-point (marker-position marker))
	   (output-length (length output))
	   old-point
	   point-not-before-marker
	   new-point)
      ;; The three symbols below are not bound above because `(window-point)'
      ;;   for the selected window does not always return the same thing as the
      ;;   function `(point)' in that window!  [Version 18 is supposed to fix
      ;;   this bug.]
      ;; Note that there is no function that returns all of the windows that
      ;;   are currently displaying a buffer.  Because of this, not all windows
      ;;   will be updated properly by this filter function.  What should be
      ;;   done is to loop through all windows displaying the buffer and do
      ;;   `(set-window-point)' in each.
      (if (not in-buffer)
	  (progn
	    (set-buffer buffer)
	    (setq old-point
	      (if no-window
		  (point)
		(window-point window-of-buffer))))
	(setq old-point (point)))
      (setq point-not-before-marker (>= old-point marker-point))
      (setq new-point (if point-not-before-marker
			  (+ old-point output-length)
			old-point))
      (save-excursion
	;; Go to point of last output by fi::make-process and insert new
	;;   output there, preserving position of the marker.
	(goto-char marker-point)
	;; The code below works around what appears to be a display bug
	;;   in GNU Emacs 17.  If `(insert-before-markers)' is used when
	;;   the process marker (process-mark), window-start point
	;;   (window-start), and window point (point) are all coincident,
	;;   the window display `sticks' on the topmost line.  We use
	;;   `(insert-string)' followed by `(set-marker)' to avoid this
	;;   problem.  This also happens to be the way
	;;   `handle_process_output()' deals with this in `process.c'.

	;; Presentation escape sequences are:
	;;  &&		- escape a single &
	;;  &<		- start a presentation
	;;  &ddd>	- end presentation number ddd (arbitrary decimal int)

	(do ((pnt 0)
	     (len (length output))
	     index)
	    ((or (eq pnt len)
		 (null (setq index (string-match "&" output pnt))))
	     (when (< pnt len)
	       (fi::insert-string output pnt len)
	       (set-marker marker (point))))
	  (unless (eq pnt index)
	    (fi::insert-string output pnt index)
	    (set-marker marker (point))
	    (setq pnt index))
	  (setq index (+ index 1))
	  (cond ((eq index len)
		 (setq incomplete-input "&"
		       pnt len))
		((eq (aref output index) ?&)
		 (insert-char ?& 1)
		 (set-marker marker (point))
		 (setq pnt (+ index 1)))
		((eq (aref output index) ?<)
		 (let* ((pres (make-presentation :start (point)
						 :end 0 :data 0))
			(parent (car presentation-stack))
			(subs (presentation-subpresentation-vector parent))
			(window-stream-presentation nil)) ;flag stream busy
		   (if subs
		       (let ((len (length subs))
			     (next (aref subs 0)))
			 (when (= next len)
			   (let ((new (make-vector (+ len len) nil)))
			     (setf
				(presentation-subpresentation-vector parent)
				new)
			     (dotimes (i next)
			       (aset new i (aref subs i)))
			     (setq subs new)))
			 (aset subs next pres)
			 (aset subs 0 (+ next 1)))
		     (setf (presentation-subpresentation-vector parent)
		       (vector 2 pres nil nil)))
		   (push pres presentation-stack))
		 (setq pnt (+ index 1)))
		((eq index (string-match "\\([0-9]\\)+>" output index))
		 (setq pnt (match-end 0))
		 (let ((pres (pop presentation-stack))
		       (window-stream-presentation nil)) ;flag stream busy
		   (setf (presentation-end pres) (point))
		   (setf (presentation-data pres)
		     (car (read-from-string output (match-beginning 1)
				(match-end 1))))
		   (let ((p (point)))
		     ;;(message "point is %s" (point))(sleep-for 2)
		     (set-marker marker p)
		     (epoch::move-zone read-only-zone 1 p))))
		((> (- len pnt) 10)	;broken protocol!!!
		 (fi::insert-string output pnt len)
		 (set-marker marker (point))
		 (setq pnt len))
		(t (setq incomplete-input (substring output (- index 1) len)
			 pnt len)))))

      (if (not in-buffer)
	  (if (and fi:subprocess-continuously-show-output-in-visible-buffer
		   point-not-before-marker)
	      ;; Keep window's notion of `point' in a constant relationship to
	      ;;   the process output marker.
	      (if no-window
		  (goto-char new-point)
		(set-window-point window-of-buffer new-point))
	    (if no-window
		t ;; Still there.
	      (set-window-point window-of-buffer old-point)))
	(goto-char new-point))
      (cond
       (in-buffer nil)
       (stay old-buffer)
       (t (set-buffer old-buffer))))))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;
;;; Mouse tracking for presentation highlighting...
;;;

(defun fi::leep-mouse-tracker (type value scr)
  ;; The existence of the buffer variable serves as a flag that
  ;; mouse events are interesting.
  (when (fi::leep-mouse-p)
    (fi::leep-mouse-tracker1 type value scr))

  ;; Pass event to next handler.
  (fi::pass-event type value scr)

  ;; Keep feeding myself fresh motion events.
  (epoch::query-pointer))

(defun fi::leep-mouse-button-handler (type value scr)
  (when (fi::leep-mouse-p)
    (fi::leep-mouse-button1 type value scr))
  (fi::pass-event type value scr))

;;; Pass event to next handler...
(defun fi::pass-event (type value scr)
  (let* ((myself (pop-event type))
	 (next-handler (pop-event type)))
    (push-event type next-handler)
    (when (and next-handler (functionp next-handler))
      (funcall next-handler type value scr))
    (push-event type myself)))

;;; Button handler...
(defun fi::leep-mouse-button1 (type value scr)
  ;; Clear presentations when mouse is down.
  (when (and (boundp 'mouse::downp) mouse::downp)
    (fi::leep-mouse-tracker1 type value scr)))

;;; Predicate for determining when handler is applicable.
(defun fi::leep-mouse-p ()
  (let ((epoch::event-handler-abort nil)
	(coords (fi::coords-at-mouse)))
    (when coords
      (save-excursion
	;; Look at the value of highlighted-presentation in the buffer
	;; where the mouse is, (not the current buffer which may not be
	;; where the mouse is).  See if there is a value assigned that
	;; indicates that this is a presenting listener...
	(set-buffer (cadr coords))
	(if (and (boundp 'highlighted-presentation)
		 (not (eq highlighted-presentation 'no-value)))
	    t
	  nil)))))

;;; Tracker...
(defun fi::leep-mouse-tracker1 (type value scr)
  ;; By default, Epoch only passes motion events when a button is down
  ;; (yuch).  Modified to pass all motion events, this *actually* gives
  ;; mouse sensitive, highlighted presentation

  ;; Highlight applicable presentation.
  (let ((epoch::event-handler-abort nil)
	(coords (fi::coords-at-mouse))
	presentation)
    (when coords
      (save-excursion
	(set-buffer (cadr coords))
	(setq presentation
	  (fi::presentation-at-point (car coords) window-stream-presentation))

	(cond ((null presentation)	;outside a presentation
	       (fi::set-highlight-zone-to-presentation nil))

	      ;; Make sure dragging outside and back in again highlights
	      ;; presentation.
	      ((eq presentation highlighted-presentation)
	       (fi::set-highlight-zone-to-presentation
		    highlighted-presentation))

	      ;; New highlighted presentation.
	      (t
	       (setq highlighted-presentation presentation)
	       (fi::set-highlight-zone-to-presentation
		highlighted-presentation)))))))

(defun fi::add-leep-mouse-tracker ()
  (push-event 'motion 'fi::leep-mouse-tracker)
  (push-event 'button 'fi::leep-mouse-button-handler))

;;; this is dangerous.
(defun fi::remove-leep-mouse-tracker ()
  (pop-event 'motion)
  (pop-event 'button))

;;; Install.
(when (boundp 'epoch::version)
  (fi::add-leep-mouse-tracker))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(defun fi::coords-at-mouse ()
  (let* (x y pos
	 (w (selected-window))
	 (w-edges
	  (if fi::epoch-has-zones
	      (window-pixedges w)
	    (window-edges w)))
	 (left (car w-edges))
	 (top (elt w-edges 1)))
    (setq pos
      (if fi::epoch-has-zones
	  (query-pointer)
	(query-mouse)))
    ;;convert to window relative co-ordinates
    (setq x (- (car pos) left))
    (setq y (- (elt pos 1) top))
    (epoch::coords-to-point (+ x left) (+ y top))))

;; This assumes that the presentations in the subpresentation-vector
;; do not have overlapping extents.

(defun fi::presentation-at-point (point p)
  (when (and point			;sometimes is nil
	     p)				;nil flags that window is being written
    (do ((winner nil)
	 subs)
	((or (null p)
	     (null (setq subs (presentation-subpresentation-vector p))))
	 winner)
      (setq p nil)
      (let* ((low 1)
	     (hih (aref subs 0)))
	(do (pres n nn)
	    ((or p
		 (eq n (setq nn (/ (+ low hih) 2)))))
	  (setq n nn)
	  (setq pres (aref subs n))
	  (cond ((<  point (presentation-start pres)) (setq hih n))
		((>= point (presentation-end   pres)) (setq low n))
		(t (setq p pres)
		   (setq winner pres))))))))

(defun fi::set-highlight-zone-to-presentation (presentation)
  (when highlighted-zone
    (if presentation
	(epoch::move-zone highlighted-zone
			  (presentation-start presentation)
			  (presentation-end   presentation))
      (epoch::move-zone highlighted-zone 1 1))))

(defun fi::interrupt-process-for-gesture (gesture)
  (let ((coords (fi::coords-at-mouse)))
    (when coords
      (save-excursion
	(set-buffer (cadr coords))
	(fi:eval-in-lisp
	 (format
	  "(mp:process-interrupt
		(mp::process-name-to-process \"%s\")
		#'composer::epoch-gesture %s %s)\n"
	  (buffer-name (current-buffer))
	  (let ((pres
		   (fi::presentation-at-point (car coords)
					      window-stream-presentation)))
	    (when pres (presentation-data pres)))
	  gesture))))))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Is there a version of the Emacs-Lisp interface that works with
Emacs version 19?

A) Version 2.0.16 of Franz Inc's GNU Emacs-Allegro CL interface is now
available.  This is the first general release since 2.0.11, which was
(and is still) the version shipped with Allegro CL version 4.2.

2.0.16 is both a bugfix and new-feature release, and the significant
changes are listed below.  This version is installed, loaded, and used
the same way as versions since 2.0.9, but instructions are included at
the end of this file along with ftp address.

Those who use the Emacs-Lisp interface heavily are encouraged to try
the new version.

------------------------------
Supported versions.

Version 2.0.16 has been tested with current versions of Emacs.

  Xemacs 19.11
  Lemacs 19.10
  FSF Emacs 19.28
  Mule 2.1
  FSF Emacs 18.59

The interface should also work with recent earlier versions from these
same Emacs.  Obviously, there will from time to time be new releases
of these various development lines.  We expect the interface will work
with new releases, but there is no way to test in advance.

We also believe the interface continues to work with Epoch 3.2 and
4.2, but this is little tested.

In order to track current name conventions, "xemacs" is now used
consistently to refer to both xemacs and lemacs in the names of files
and in the source code itself.

------------------------------
New features.

`Run Bars' -- Users can now have `Run Bars' in the mode line for lisp
source and listener buffers.  One of the words "Run", "Idle", or "GC
appears in the buffer mode line depending on the instantaneous state
of the ACL image.  Run bar support will be built in to future versions
of ACL, but 4.2 users will need to load both a .o and .fasl file into
their images.  This can conveniently be done at build time.  See the
instructions in the file gc-mode-line.cl included with the Emacs-Lisp
interface sources.

FSF Emacs19 menubars -- Menubar support has been added for FSF Emacs
similar to the existing support for Lemacs.  The organization of the
menubar has been cleaned up for both families.

Fontification -- Common Lisp buffers now have a reasonable default
font-lock-keywords specification to support font-lock mode.  This may
be better customized specifically for Common Lisp in some future
release.

------------------------------
Notable bugfixes.

Indentation -- Some longstanding bugs in automatic indentation of
lisp-forms were found and fixed in this release.

Clman now works correctly on byte-order-reversed hosts.

Fontification -- Most problems sending font-lock mode buffer regions
from FSF Emacs to ACL have been fixed.

Xemacs/Lemacs hanging problems -- There is a serious problem between
minibuffer completion and mouse handling under Lemacs 19.8 and later.
If a minibuffer completion function blocks asynchronously (as do many
such Emacs-Lisp functions), any mouse motion will recurse on each
mouse update.  This deep recursion makes Lemacs appear to wedge
(although a _large_ number of keyboard ^G chars will eventually pop
out).  The ACL code now protects against this recursion.

Composer Podium behavior -- Since almost all Composer Podium functions
are available from the Emacs menubar, it is common now to start
Composer without the Podium.  This option has been fixed so that
invoking the two remaining features that unavoidably use CLM (the
"Profiler Options" and the "Composer Options" dialogs) will silently
try to start the CLM server rather than fail in obscure ways.

Lisp interaction buffers by default now use a socket rather than a
pseudo tty to communicate to the ACL process.  This eliminated any
remaining bad behavior with very long input lines and with special
tty-control characters in the input.

There were also numerous minor bugfixes.

------------------------------
Support for Mule.

Version 2.0.16 works with Mule 2.1 and the Japanese-capable version of
"International" ACL, with these exceptions:

   WNN keyboard translation in a lisp listener buffer is incompatible
   with the little-used fi:raw-mode.  Therefore, fi:raw-mode is disabled
   under Mule.

   The emacs lisp-form indenter does not correctly understand non-ASCII
   characters and incorrectly indents lisp forms in both Common Lisp
   source and listener buffers.  This appears to be a problem with
   syntax-table changes that these modes make, and we hope to fix this in
   a future release.

In order to use the Emacs-Lisp interface with Mule, it is necessary to
setup the appropriate coding systems.  The Emacs-Lisp interface
creates new processes dynamically in response to background tasks, so
it is necessary globally to set the default coding system.  This can
best be done by placing the following form in a user's ~/.emacs
initialization file:

   (when (boundp 'mule-version)
     (set-default-process-coding-system *euc-japan* *euc-japan*))

Mule users also need to instruct Emacs the NAME of the host on which
to contact the WNN server.  This can be done with the following form
also in the ~/.emacs file:

   (when (boundp 'mule-version)
     (set-jserver-host-name "NAME"))

Otherwise, remarks concerning FSF Emacs 19 pertain also to Mule.

------------------------------
Known Bugs in 2.0.16.

FSF Emacs 19 redisplay strategies work badly with the way the
Emacs-Lisp interface can asynchronously pop up a
"*background-interaction*" buffer.  There is a tendency the first time
such a buffer is popped up after its creation to be scrolled past the
end of the buffer.  This can appear as though the buffer is still
empty while in fact the contents are scrolled off screen.  (The Lisp
process may even be waiting for input.)  The problem is minor once one
is aware of it, as manual scrolling or even executing a "C-l recenter"
command will make the buffer display appropriately.  We will attempt
to solve this in a future release.

*******************************************************************************
Obtaining the interface:

The sources are available by ftp from ftp.uu.net as the
following files:

   /vendor/franz/emacs/eli-2.0.16.tar.gz (280 Kb)
   /vendor/franz/emacs/clman-4.1-v2.tar.gz (950 Kb)
   /vendor/franz/emacs/clman-4.1-v2-clim2.tar.gz (1306 Kb)

Grab the first file and either the second or third files, as
appropriate.  (Sites updating from 2.0.9 or later need only the eli
file -- the clman files are unchanged.)  The uncompressed
clman-4.1-v2.tar.gz is 4280 Kb and clman-4.1-v2-clim2.tar.gz is 6110
Kb.

Note: the .gz means you need gzip (GNU zip) to uncompress these files.
You can get gzip from prep.ai.mit.edu (/pub/gnu/gzip-1.2.3.tar, 778240
bytes).  We use gzip because it produces much better compression.

*******************************************************************************
INSTALLATION

[These instructions last changed significantly with release 2.0.9.]

Unlike versions of the emacs-lisp interface prior to 2.0.9, current
versions of the Emacs-Lisp interface do not require installation in
the lisp/ subdirectory in the emacs library.  The directory created
from unpacking the file eli-2.0.16.tar.gz can be placed anywhere.  (A
subdirectory of the lisp/ directory is an appropriate place, but this
location is not required.)  The following will assume the directory
/usr/local/lib/fi-2.0.16 is chosen as the place you will install this
version of the emacs-lisp interface.  Then you'd do this:

	% cd /usr/local/lib
	% gzip -d < eli-2.0.16.tar.gz | tar xf -

This will extract the files from the .tar.gz file into the directory
/usr/local/lib/fi-2.0.16.  Next, if you want to install the on-line
manual pages then do this:

	% cd fi-2.0.16
	% gzip -d < clman-4.1-v2-clim2.tar.gz | tar xf -

This will extract a few more files.  Next, to build the `clman'
program, type:

	% make clman

This will ensure that everything is up-to-date.  If you don't have gcc
installed, then you'll have to type

	% make CC=cc clman

where `cc' is the name of the C compiler on your system.

Lastly, put the following into your ~/.emacs file:

	(setq load-path (cons "/usr/local/lib/fi-2.0.16" load-path))
	(load "fi-site-init")

This will probably replace the following form in your ~/.emacs if you
were using a version prior to 2.0.9:

	(load "fi/site-init")

----------------------------------------------------------------------


----------------------------------------------------------------------
Q) From where can I get FSF Emacs and Xemacs?

A) The following is from the Xemacs distribution. It covers getting both
   FSF emacs and Xemacs.

	   XEmacs availability information.  Last Modified: 8-sep-94.

XEmacs is available via anonymous FTP from cs.uiuc.edu (128.174.252.1)
in the directory /pub/xemacs/.

cs.uiuc.edu is the primary distribution point, but you may find copies
of it at other sites as well.  Some sites to try include:

	ftp.ai.mit.edu:/pub/xemacs/
	ftp.center.osaka-u.ac.jp:/xemacs/
	ftp.uu.net:/systems/gnu/xemacs/
	audrey.levels.unisa.edu.au:/xemacs/
	liasun3.epfl.ch:/pub/gnu/xemacs/
	ftp.cenatls.cena.dgac.fr:/pub/Emacs/xemacs/
	ftp.germany.eu.net:/pub/X11/misc/xemacs
	ftp.th-darmstadt.de:/pub/editors/xemacs/
	self.stanford.edu:/pub/xemacs/
	ftp.technion.ac.il:/pub/unsupported/gnu/xemacs/

The most up-to-date list of distribution sites can always be found on
the XEmacs WWW page, http://xemacs.cs.uiuc.edu/.  Try to pick a site
that is networkologically close to you.  If you know of other mirrors
of the XEmacs archives, please send us mail and we will list them here
as well.

There are mailing lists and newsgroups specifically for discussing and
reporting bugs in XEmacs; see the file MAILINGLISTS in this directory.

The FTP and ordering information in the remainder of this file applies
to the versions of GNU Emacs distributed by the Free Software
Foundation, not to XEmacs.

-----------------------------------------------------------------------

For an order form for all Emacs and FSF distributions deliverable from
the USA, see the file `ORDERS' in this directory (etc/ in the GNU
Emacs distribution or /pub/gnu/GNUinfo on prep.ai.mit.edu).  For a
European order form, see `ORDERS.EUROPE'.

	   GNU Emacs availability information, January 1993
Copyright (C) 1986, 1987, 1988, 1989, 1990, 1991, 1992, 1993 Free Software Foundation, Inc.

	Permission is granted to anyone to make or distribute
	verbatim copies of this document provided that the
	copyright notice and this permission notice are preserved.

GNU Emacs is legally owned by the Free Software Foundation, but we
regard the foundation more as its custodian on behalf of the public.

In the GNU project, when we speak of "free software", this refers to
liberty, not price.  Specifically, it refers to the users' freedom to
study, copy, change and improve the software.  Sometimes users pay
money for copies of GNU software, and sometimes they get copies at no
charge.  But regardless of how they got the software, or whether it
was modified by anyone else along the way, they have the freedom to
copy and change it--those freedoms are what "free software" means.

The precise conditions for copying and modification are stated in the
document "GNU General Public License," a copy of which is required to
be distributed with every copy of GNU Emacs.  It is usually in a file
named `COPYING' in the same directory as this file.  These conditions
are designed to make sure that everyone who has a copy of GNU Emacs
(including modified versions) has the freedom to redistribute and
change it.

If you do not know anyone to get a copy of GNU Emacs from, you can
order a tape, cd-rom, or floppy diskette from the Free Software
Foundation.  We distribute Emacs version 18 and 19 in different
formats for many machines.  We also distribute nicely typeset copies
of the Emacs user manual, Emacs Lisp Reference Manual, the Emacs
reference card, etc.  See file `ORDERS'.

If you have Internet access, you can copy the latest Emacs
distribution from hosts, such as prep.ai.mit.edu.  There are several
ways to do this; see the file `FTP' for more information.  Even
better, get the latest version of the file from `/pub/gnu/GNUinfo/FTP'
on prep.ai.mit.edu for the most current arrangements.  It may also be
possible to copy Emacs via uucp; the file `FTP' contains information
on that too.

Emacs has been run on both Berkeley Unix and System V Unix, on a
variety of types of cpu.  It also works on VMS and on Apollo
computers, though with some deficiencies that reflect problems in
these operating systems.  See the file `MACHINES' in this directory
(see above) for a full list of machines that GNU Emacs has been tested
on, with machine-specific installation notes and warnings.  There is
also Demacs that works on newer MS-DOS machines (see file `ORDERS').

Note that there is significant variation between Unix systems
supposedly running the same version of Unix; it is possible that what
works in GNU Emacs for me does not work on your system due to such an
incompatibility.  Since I must avoid reading Unix source code, I
cannot even guess what such problems may exist.

GNU Emacs is distributed with no warranty (see the General Public
License for full details, in the file `COPYING' in this directory (see
above)), and neither I nor the Free Software Foundation promises any
kind of support or assistance to users.  The foundation keeps a list
of people who are willing to offer support and assistance for hire.
See the file `SERVICE'.  You can get the latest version from
prep.ai.mit.edu in file `/pub/gnu/GNUinfo/SERVICE'.

However, we plan to continue to improve GNU Emacs and keep it
reliable, so please send me any complaints and suggestions you have.
I will probably fix anything that I consider a malfunction.  I may
make improvements that are suggested, but I may choose not to.
Improving Emacs is not my highest priority now.

If you are on the Internet, report bugs to
bug-gnu-emacs@prep.ai.mit.edu; on UUCP, use the address
...!uunet!prep.ai.mit.edu!bug-gnu-emacs.  Otherwise, phone or write the
foundation at:
	Free Software Foundation
	675 Massachusetts Avenue
	Cambridge, MA  02139
	+1-617-876-3296
General questions about the GNU Project can be asked of
gnu@prep.ai.mit.edu.

If you are a computer manufacturer, I encourage you to ship a copy of
GNU Emacs with every computer you deliver.  The same copying
permission terms apply to computer manufacturers as to everyone else.
You should consider making a donation to help support the GNU project;
if you estimate what it would cost to distribute some commercial
product and divide it by five, that is a good amount.

If you like GNU Emacs, please express your satisfaction with a
donation: send me or the Foundation what you feel Emacs has been worth
to you.  If you are glad that I developed GNU Emacs and distribute it
as freeware, rather than following the obstructive and antisocial
practices typical of software developers, reward me.  If you would
like the Foundation to develop more free software, contribute.

Your donations will help to support the development of more useful
software to be distributed on the same basis as GNU Emacs.  Eventually
we will have a complete imitation of the Unix operating system, called
GNU (Gnu's Not Unix), which will run Unix user programs.  For more
information on GNU, see the file `GNU' in this directory (see above).

			Richard M Stallman
			Chief GNUisance,
			President of the Free Software Foundation
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How do I get the Emacs-Lisp Interface working with Xemacs 19.12?

A) Xemacs 19.12 has at least one serious bug that breaks the
emacs-lisp interface startup.  read-from-string returns as its
"second" value the number of characters read rather than the ending
index.  The Xemacs developers intend to fix this in the 19.13 bugfix 
release.

The code botch is in Xemacs C code.  Another customer developed the
following to workaround the bug and reported that it worked.  You can
try it if you like, but we're not officially recommending use of 19.12
with the emacs-lisp interface until we've checked it out locally.
We'll probably report to allegro-cl@cs.berkeley.edu when we do.

             (read-from-string "(list 112)" 6 8)
   (11 . 2)	;; The 2 should be 8.

   (require 'advice)
   advice
   
   (defadvice read-from-string (after fix-final-string-index activate)
     (setq ad-return-value (cons (car ad-return-value)
                                 (+ (or (ad-get-arg 1) 0) (cdr ad-return-value)))))
   read-from-string
   
             ;; Read starting at the first character.
             (read-from-string "(list 112)" 0)
   ((list 112) . 10)
   
             ;; Read starting at the second character.
             (read-from-string "(list 112)" 1)
   (list . 5)
----------------------------------------------------------------------


4.2: LEP Protocol
-----------------
	      The Lisp-Editor protocol in Allegro CL 4.1

Allegro CL 4.1 has a new version of the emacs-lisp interface, which
works with a stock version of GNU Emacs 18.58.  Epoch 4.0 is not yet
supported.

This new version of the emacs-lisp interface has a lisp-editor
protocol (hereafter `LEP') which facilitates communication between
Allegro CL and GNU Emacs/Epoch.

The LEP is not documented and there is no public interface to
extending LEP or the emacs-lisp interface (other than what is in
chapter 14 of the Allegro CL User Guide).

Franz Inc. realizes that customers wish to use the LEP to extend their
environment, and this note contains all the information there is for
public consumption.  Feel free to send mail to bugs@franz.com
requesting that particular undocumented features be documented, but we
can't promise when they will be documented.


----------------------------------------------------------------------
Q)  How can I edit an s-expression, possibly having lisp
    wait for the editor to finish the edit session?

A) On the emacs side, define the following functions:

   ;;;; ED-WAIT

   (defun ed-quit ()
     (interactive)
     (fi::pop-metadot-session))

   ;;;; ED-SEXP

   (defun lep::edit-form (form)
     (switch-to-buffer (get-buffer-create "*ed*"))
     (erase-buffer)
     (insert (prin1-to-string form))
     (goto-char (point-min))
     (setq buffer-file-name "/tmp/foo.cl")
     (fi:common-lisp-mode))

   ;;;; ED-SEXP-WAIT

   (defvar lep::ed-sexp-wait-session nil)

   (defun lep::edit-string-wait (string)
     (setq lep::ed-sexp-wait-session session)
     (switch-to-buffer (get-buffer-create "*ed*"))
     (erase-buffer)
     (insert string)
     (goto-char (point-min))
     (setq buffer-file-name "/tmp/foo.cl")
     (fi:common-lisp-mode)
     (define-key (current-local-map) "\C-c\C-c" 'ed-sexp-wait-done))

   (defun ed-sexp-wait-done ()
     (interactive)
     (lep-send-reply lep::ed-sexp-wait-session (buffer-string))
     (setq lep::ed-sexp-wait-session nil)
     (bury-buffer))

   ;;; The following function should be defined in the emacs-lisp interface,
   ;;; but it didn't make it into the ACL 4.1 release.

   (defun lep-send-reply (session string)
     (let* ((connection (fi::session-connection session))
	    (process (fi::connection-process connection)))
       (send-string process
		    (prin1-to-string
		     (list (fi::session-id session) ':reply string)))
       (send-string process "\n")))

On the lisp side define the following functions:

   (in-package :lep)

   ;;;; ED-WAIT

   (defun ed-wait (symbol)
     (let ((process (make-session nil 'metadot-session
				  :fspec symbol
				  :lisp-initiated-p t)))
       (mp:process-wait "for ED-WAIT to complete"
			#'(lambda (process)
			    (null (mp:process-stack-group process)))
			process)))

   ;;;; ED-SEXP

   (define-query ed-sexp-query (form) (simple-query)
     (:replyp t)
     ("lep::edit-form" form))

   (defun ed-sexp (form)
     (ed-sexp-query :form form))

   ;;;; ED-SEXP-WAIT

   (defun ed-sexp-wait (form)
     (let* ((string (with-output-to-string (s)
		      (write form :stream s :pretty t)))
	    (new-string
	     (wait-for-reply (ed-sexp-wait-1 :string string))))
       (values (read-from-string new-string))))

   (define-query ed-sexp-wait-1 (string) (simple-query)
     (:oncep nil)
     ("lep::edit-string-wait" string))

Here is a sample usage:

user(14): (lep::ed-sexp-wait '(foo bar))
 >>> right here, the *ed* buffer popped up and I added `baz' to the
 >>> end of the list, then typed C-cC-c.  Then, lep::ed-sexp-wait returned:
(foo bar baz)

user(15):

sexps containing objects that print as #<...> cannot be edited, since
their printed representation doesn't usually mean anything (and can't
be passed to emacs via the LEP).
----------------------------------------------------------------------


----------------------------------------------------------------------
Q)  How can I open a stream to an emacs buffer?

A) USER(25): (with-open-stream (*query-io*
			        (lep:make-editor-listener-stream))
	       (y-or-n-p "Is today Wednesday?? "))
   T
   USER(26):

When this was evaluated, a *background-interaction* Emacs buffer
popped up.  I answered the question `y', so the form returned T.  You
may have to bind more or different stream variables to the stream
object, of course, depending on what you actually do with the popup
buffer.

If you want to name the buffer, then you will need to change the
definiton of lep::create-listener-stream in stream.el in the emacs
library (lisp/fi/stream.el) to this:

(defun lep::create-listener-stream (&optional args)
  (fi:lisp-push-window-configuration)
  (fi::with-keywords (parent x y width height splitp name) args;;;new
    (let* ((fi::listener-protocol ':stream)
	   (proc
	    (save-window-excursion
	      (fi:open-lisp-listener
	       -1
	       (if name name "background-interaction");;;new
	       (function
		(lambda (proc)
		  (format "%d\n%d\n"
			  (fi::session-id session)
			  (fi::tcp-listener-generation proc))))))))
      (cond ((or parent x y width height)
	     (fi::create-new-mapped-screen-for-stream parent x y width
						      height))
	    ((get-buffer-window (process-buffer proc))
	     (select-window (get-buffer-window (process-buffer proc))))
	    (splitp (split-window-vertically)))
      (switch-to-buffer (process-buffer proc)))))

(the lines marked with ";;;new" are changed) and redefine the
create-listener-stream LEP query in Allegro CL:

(in-package :lep)

(define-query create-listener-stream () (simple-query)
  (:oncep nil)
  ("lep::create-listener-stream"
   (with-keywords (new-args args '(:parent :x :y :width :height :splitp :name))
     new-args)))

which will allow you do do this:

	(setq s (lep:make-editor-listener-stream :name "foo"))

The above elisp and lisp changes are part of ACL 4.2.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q)  How can another stream be used for background output
    instead of creating the *background-interaction* buffer?

A) You can give the variable

	lep::*stream-for-background-output*

a value which is the stream to which the output should go,
excl:*initial-terminal-io*, for example.  Doing so may also affect
various emacs-lisp interface commands, of course.

In ACL 4.1 patch0101 must be installed before this will work.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q)  How can arbitrary elisp code be run from lisp?

A) The ACL function lep::eval-in-emacs takes a single string argument
which is read and evaluated by the emacs elisp interpreter.  For
example,

	(lep::eval-in-emacs "(message \"foo!\")")

prints ``foo!'' in the minibuffer.  lep::eval-in-emacs is synchronous
and reads/evals only one form from the string.  In other words,

	(lep::eval-in-emacs "(foo)(bar)")

will not evaluate both forms, but just the first (foo).
lep::eval-in-emacs returns one value, the value returned by the elisp
form.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q)  Is the presentation system (mouse sensitive Allegro CL
    objects in emacs buffers) extensible?

Currently, the answer is `no'.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q)  Is there a way to programmatically determine if the emacs-lisp
    interface connect has been established?

A) Yes, the function lep:lep-is-running returns a non-nil value if the
connection has been established.  If you want to make sure lep is
running, call (lep:ensure-lep).
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I tell if lep had a problem?

A) There are several lep conditions defined:

   lep:lep-error inherits from simple-error and the root of the next two
   errors. If you just want to establish a handler for any lep problem,
   this is the thing to handle.

   More specifically:

   lep:no-lep-connection is signalled when (and only when) code calls
   (lep:ensure-lep), and there is no connection with an emacs/epoch.

   lep:lep-operation-aborted is signalled whenever lisp expects lep to
   return information from emacs and is disappointed.

   Most unfortunately, several internal errors do not obey the condition
   protocol, and none of the above conditions have useful slots.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Lemacs 19.10 and (setq fi::initialization-forms):
     Quite possibly you've fixed this already, but I should mention
     that when upgrading to lemacs 19.10 (SPARC version) I had to
     change the last line below in fi-site-init.el to
             (setq fi::initialization-forms nil)))
     in order to get the Franz emacs interface to load.

A) We have fixed this in 2.0.16, but thanks for mentioning it!  The
byte compilers in older Emacs silently accepted this, which is why it
was never noticed.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Lemacs (or ACL, or Composer, or my xterm) freezes when running some
command that asks for a name in the minibuffer.

A) This is a recently-discovered problem in the interaction between
Version 2.0.11 the Emacs-Allegro interface and recent versions of
Lemacs (e.g. 19.10).  The problem happens whenever the mouse is moved
over a Common Lisp buffer during minibuffer completing-read for any
common lisp symbol, but is not a Composer problem or a problem with
some specific Emacs command.  The freeze is much more likely to happen
when invoking commands from a menu than from the keyboard because the
mouse almost necessarily moves right after clicking on a menu command.

Lemacs faces architectural difficulties in trying to work
automatically in a mouse-cognizant way with all sorts of extension
code that was not written with a mouse in mind.  Therefore, whenever
elisp code calls completing-read, it enables mouse-tracking and tries
to do the "right thing": It parses words from the buffer as the mouse
cursor moves, presents them to the minibuffer completion predicate
given in the call to completing-read, highlights them if the predicate
returns true, and accepts mouse clicks on them.  This is reasonable if
the predicate is something that completes immediately, but loses badly
if the completion predicate is something that suspends, say, to do
some interprocess communication.  This allows recursive calls to the
completion predicate.  The fi emacs-lisp code that handles these
completions is not set up to track recursive completions -- it is
difficult because Emacs is not multi-threaded.  Consequently, the
completion protocol blocks, and lemacs seemingly freezes completely.

(The lemacs implementors seem to have been aware of this problem.  The
low-level mouse tracking code knows the names of certain completion
functions -- such as the one for the ange-ftp mode that would invoke
ftp commands and introduce severe latencies -- and doesn't use them
for completions.  This non-modular special-casing prevents lossage for
extension modes known in advance to the mouse tracking code, but there
is apparently no general architectural solution if lemacs is to
working with arbitrary extensions.)

When lemacs freezes this way, you can recover by entering C-g
"keyboard-quit" while being careful _not_ to move the mouse.  You will
need to enter some number of times dependent on the number of
recursions, possible a large number of times, but eventually lemacs
will beep and unfreeze.

There is a simple fix that will prevent mouse motion from invoking
recursive completions.  The fix has been implemented in version 2.0.16
of the emacs-lisp interface, but the change is sketched below.  If you
choose to make this change to 2.0.11, remember to recompile the
emacs-lisp directory by issuing the Unix command "make" in the
directory, and then restart your lemacs.

==================== ../fi-lep.el
! (defvar fi::inside-lisp-complete-1 nil)
!
  (defun fi::lisp-complete-1 (pattern xpackage functions-only
                              &optional ignore-keywords)
!   (unless fi::inside-lisp-complete-1	;return nil on recursion
!     (let ((fi::inside-lisp-complete-1 t))
        (condition-case nil
         ...
! 	 (lep::kill-list-all-completions-session))")))))

----------------------------------------------------------------------


4.3: CLIM
---------

----------------------------------------------------------------------
Q) The CLIM 2.0 demos don't seem to work.  What should I do?

A) Maybe you are calling the function do-demo - this was mistakenly
included in the demo-driver file. You should use the function
start-demo instead.

The best way to load the demos is to load the file cload-demos.cl in
the demo directory and then call compile-and-load-demos. This should
load all the demos. The demos can then be started with:

(clim-demo:start-demo (clim:open-root-window :clx))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) My ACL4.2.beta2.0 build on the HP fails if CLIM2.0beta is to be
included in the image.  If CLIM2.0beta is not included, the build
succeeds.  What do I do to build with CLIM?

A) We believe that we have determined the reason that you are unable to
build an Allegro CL 4.2.beta2.0 image with CLIM2 on your HP.

Please try the build again after making the following changes:

1. change your LPATH environment variable:

   a. if your shell is sh:

	LPATH=/lib/pa1.1:/lib:/usr/lib:/usr/lib/Motif1.2:/usr/lib/X11R5

	export LPATH

   b. if your shell is csh:

	setenv LPATH /lib/pa1.1:/lib:/usr/lib:/usr/lib/Motif1.2:/usr/lib/X11R5

2. When building Allegro CL 4.2.beta2.0, in addition to any other
   arguments you would otherwise specify, be sure to specify

	whichclim2=motif

   for example:

	sh config whichclim2=motif

Please note that these changes are needed only when building an
Allegro CL 4.2.beta2.0 with CLIM2 in the image on the HP.  Note also
that this problem doesn't exist with ACL4.2 (final) on the HP, so you
consider contacting your Franz salesperson to upgrade to ACL4.2.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Why do I get strange behavior when I try to run accepting-values 
in a separate process?

A) accepting-values dialogs are designed to be modal ie the user interacts
with the dialog and then presses "Ok" or "Cancel" prior to continuing with
application. Because of this design there are several features which
potentially can cause problems. 

The kind of strange behavior you might experience are errors on hitting "Ok" 
or "Cancel", alternate keystrokes going to different panes, being unable to 
interact with any other application-frames. 

    1. The frame top level of an :own-window t dialogs is assumed to be
    running in the same thread as that on which the frame top level of the 
    calling frame is running.

    2. In order for repaint events in the calling frame to work correctly
    the accepting-values frame shares the same input buffer as its calling 
    frame. This is so that it's frame-top-level can deal with repaint
    events for the parent frame correctly. It's necessary because the
    parent is no longer running a frame top level - it's in the call to
    accepting-values waiting for it to return. This is a direct result of 1.

    3. Hitting cancel in the dialog invokes the abort restart. The default 
    frame top level (see demo/default-frame-top-level.lisp) for the parent
    typically establishes an abort restart. This relies on 1.

    4. Various window manager hints are set indicating the accepting-values
    frame is a dialog associated with its calling frame. Certain window
    managers do things like iconizing the child and parent together, not
    allowing the parent to obscure the child, preventing the parent from
    getting the keyboard input focus.

Now, if you want to run the dialog in a separate process so that the
user can continue working with the application frame. You are
violating the assumption in 1. This means that if the parent and child 
share the same event queue as described in 2, you'll have two
frame-top-level's reading from the same event queue. This means that
each event only has a 50-50 chance of being handled by the correct
frame. This can cause strange behavior like alternate characters going to
different windows. It also causes random failure of the OK button when the
com-exit-avv command is executed in the parent's frame-top-level rather
than in the accepting-values dialog's frame-top-level. The parent
application frame is typically missing a stream slot and this results in an 
unbound slot error.

To avoid sharing an input buffer you can specify a null stream as the
associated stream in the accepting-values call. 

Running in a separate process means you probably also need to
establish an abort restart if you want the "Cancel" button not to give 
an error. In your particular example I notice that you don't have a
cancel button so this shouldn't be a problem.

Finally an accepting-values frame is created with a :calling-frame
argument which basically defaults to pane-frame of stream if stream is 
part of an application-frame otherwise *application-frame*. This is
what implements 4. If you want the user to still be able interact with 
the parent window while the dialog is up you need to prevent this
association from taking place. 

You can do this by providing a null stream and binding *application-frame*
to nil.

The following pops up an accepting-values dialog in a separate process:

(defun popup-dialog ()
  (flet ((dialog (stream)
	   (catch-abort-gestures ("Abort the dialog")
	     (let ((*application-frame* nil))
	       (accepting-values (stream :own-window t)
		 (accept 'string :stream stream))))))
    (mp:process-run-function "dialog" #'dialog nil)))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q. How do I provide scrollable popup menus in Allegro CLIM 2.x?

A. Motif doesn't support scrollable pop menus. menu-choose in Allegro CLIM 2.0
ignore the :scroll-bars argument. CLIM 2.1 supports :scroll-bars t but by
using an old CLIM 1 presentation style menu rather than a native Motif
widget based menu. This fix is available for CLIM 2.0 as patch3331.4

However, a better solution may be to use a a popup dialog with a scrollable 
list-pane. This can be done with the following code. In a real application
you might want to avoid recreating a new application frame for each
popup. However, this code is presented here to be as simple as possible.

(in-package :clim-user)

(define-application-frame selection-frame ()
  ((items :initarg :items)
   (select-callback :initarg :select-callback))
  (:panes
   (menu 
    (with-slots (items select-callback) *application-frame*
	(make-pane 'list-pane
		   :items items
		   :visible-items (min 10 (length items))
		   :value-changed-callback select-callback))))
  (:layouts
   (default
       (scrolling (:scroll-bars :dynamic)
	 menu)))
  (:menu-bar nil))

(defun popup-selection-frame (items)
  (flet ((select-callback (gadget value)
	   (declare (ignore gadget))
	   (return-from popup-selection-frame value)))
    (run-frame-top-level
     (make-application-frame 'selection-frame
			     :items items
			     :select-callback #'select-callback))))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Why do I need an XNLSPATH environment variable?

A) In order for CLIM to work (especially when patched with ACL 4.2
patch3344, but that simply brought an existing problem to the fore),
it must be able to find the xnls directory and it tries to do so via
the XNLSPATH environment variable.  See 3 paragraphs below for the
standard location.

You need to supply an nls directory for Motif 1.2 to work properly.
The problem often first shows up after loading ACL 4.2
patch3344.  However, the problem is not with the patch because even
without that patch there are potential problems - for example doing a
cut-and-paste between Motif text-fields will cause a segmentation
violation.

The error mode is unfortunate since the toolkit calls exit() directly 
rather than signaling an Xlib error.  In post-CLIM2.0 versions CLIM
will test for the Locale Database directly and will give a Lisp (hence 
recoverable) error message prior to startup.

If you have a standard X11R5 distribution you should find the nls
directory in /usr/lib/X11 and you should set XNLSPATH to point to it.
If you don't have a standard X11R5 distribution we can mail you a
tar file of the directory which you should install and set XNLSPATH to
point to.  You can distribute the directory freely as it's part of the
standard X11R5 distribution.  Let us know if you would like us to send
you this tar file.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What should I do to avoid getting palette-full error messages?

A) CLIM's palettes are associated with X colormaps. When the associated
colormap overflows the PALETTE-FULL condition is signaled. The default
palette (ie the palette returned by PORT-DEFAULT-PALETTE) is
associated with the screen's default colormap - This is usually shared
with other applications. CLIM allows you to create a new palette
associated with a new colormap so that your application gets exclusive
use of that colormap. The downside of this is that because typical
display servers only have one hardware colormap, all windows of other
applications will appear in "technicolor" while your CLIM app has the
focus. 

In order to determine if you need a new palette you should try and
allocate all of your colors in the default palette prior to creating
any frames. You can do this with...

(apply #'add-colors-to-palette
 (port-default-palette (find-port)) list-of-colors)

This will either successfully allocate all the colors in the
associated colormap or fail (with a palette-full condition) and not
allocate any colors. In the latter case you should create a
frame-manager with a new palette and use this to create any frames eg.

(let ((port (find-port)))
  (make-application-frame
   'clim-demo::puzzle
   :frame-manager (find-frame-manager :palette (make-palette port)
				      :port port)))

In the next release of ACL CLIM the default behavior will be to use the
closest available color when the palette fills up. Alternatively an
application can choose to have an error signaled and then via a handler
programmatically invoke a restart to use a particular alternative color.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Why can't get the :scroll-bar option to the list-pane gadget to work?

A) The documentation is in error. The list-pane gadget class doesn't take
a :scroll-bars initarg. (On the other hand the list-pane-view class
does take a :scroll-bar initarg)

If you want your list-pane to have scroll-bars you should wrap it in a
scroller pane. You can do this either in the panes specification or in
the layout specification. eg using

	(scrolling ()
	  (make-pane 'list-pane ...)

Moreover there is a bug in Motif 1.2.2 involving scroll-bars. Also
CLIM 2.0 final doesn't handle the :vertical case properly - it
produces both horizontal and vertical scroll-bars.

You shouldn't use :dynamic or :horizontal as this exposes the toolkit
bug.

The toolkit bug appears to be fixed in Motif 1.2.4. Along with changes
to the CLIM backend this is now fixed so that all cases work except
for the :horizontal case which behaves as :both. This appears to be an
unavoidable consequence of the Motif XmList widget interface.

In the meantime you should use either :both, :vertical or t - all of
which will have the effect of always adding both scroll-bars.
----------------------------------------------------------------------


4.4. Runtime
------------

----------------------------------------------------------------------
Q) When I run ACL 4.2 without the development and without the
compiler, and with EXCL::*COMPILER-NOT-AVAILABLE-WARNING* = T, I get
warnings in two unexpected kinds of places, detailed below.  What is
going to run slower, and how much slower?

The kinds of places are:
  1.  defforeigns
  2.  something about clos and windows

A) For foreign functions, the problem is that defforeigns create a
function (at load time) that cannot be compiled in a runtime delivery
system because there is no compiler available.  To avoid this problem,
you can do the following: wrap defforeigns in an (eval-when (compile
eval) ..) form and specify ":call-direct t", so that all calls to the
foreign functions will be compiled in-line.  This will avoid the need
for the compiler in the runtime delivery system.

For CLOS and CLIM, we advise training your application (see Tech. Memo
19, Section 5) so that you speed up the parts of your application that
are commonly used.  If this doesn't yield adequate performance with
Allegro Runtime, then you need the compiler at runtime, in which case
you do indeed need Allegro Runtime+.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I'm running into errors during CLOS training.  What do I do?

| I am trying to do CLOS training as described in Technical Memorandum
| #19 to improve the performance of my runtime executable.  I have
| loaded and exercised my application, and, as instructed, was trying to
| compile my file containing the following statements:
|
| (in-package :clos)
| (preload-forms)
| (preload-constructors '(:user :lisp :grasper-cl :ecocyc :gfp :clim))
| (precache-generic-functions '(:user :lisp :grasper-cl :ecocyc :gfp :clim))

A) There should be no quotes before the arguments to either
preload-constructors or precache-generic-functions.  This is a
documentation bug, that we will fix with our next release.  Sorry
about the mis-information.
----------------------------------------------------------------------


4.5. SQL DB Interface
---------------------

----------------------------------------------------------------------
Q) Is there an Allegro SQL interface for relational databases?  Where
can I get it?

A) Franz has developed an SQL interface for RDBMS's on Unix.
Currently, only Oracle databases are supported, but this will be
extended to other RDBMS, with customer demand and usage.  The SQL
interface works as is with Oracle 6.0.36.6, and, after slight
modification, with Oracle 7.0. The interface is currently available
for Sun and HP, but can be extended to other platforms easily (ask, if
you need it!).

The SQL interface (for Sun and HP) is available via anonymous ftp from

ftp.uu.net: /vendor/franz/misc/sql-dbi-4.2.tar.Z

Retrieve this file, uncompress and untar it.  There are two
directories, one for HP and one for Sun.  Each directory contains the
following files:

(1) README: 			Installation notes
(2) sql-top.fasl: 		SQL interface (RDBMS-independent)
(3) oracle/sql-oracle.fasl:	Oracle-specific Lisp code
(4) oracle/oracle-lib.o:	Oracle-specific C code

Currently, documentation for this interface is available only in
hard-copy form.  Please contact your Franz sales representative for
this.
----------------------------------------------------------------------


4.6. Common Windows
-------------------

----------------------------------------------------------------------
Q) When I call cw::initialize-common-windows with DISPLAY =
   192.5.238.11:0, I get the error: Unknown host "192.5.238.11".  What
   is going wrong?

A) The X authorization code in common windows, which had been our own
hack, was recently replaced by code that was written by Texas
Instruments as an official enhancement to CLX.  This new version
apparently doesn't work with numeric address strings such as
"192.5.238.11" and expects a descriptive name as you would have in
your /etc/hosts file.

Here is a patch to the clx function xlib::host-address function to
handle the numeric address strings.  We just added the "when" clause at
the top of it.

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Enhancement for xcw/code/xinit.cl-->xlib::host-address

(in-package :xlib)

(defun host-address (host &optional (family :internet))
  (when (every #'(lambda (char)
                   (or (digit-char-p char)
                       (eql char #\.)))
           host)
    ;; Handle numeric strings such as "192.132.95.31"
    (let ((s (substitute #\space #\. host))
	  (list (list :internet))
	  (start 0)
	  num)
      (dotimes (j 4)
	(multiple-value-setq (num start)
	  (read-from-string s nil 0 :start start))
	(push num list))
      (return-from host-address
	(reverse list))))
  (labels ((no-host-error ()
	     (error "Unknown host ~S" host))
	   (no-address-error ()
	     (error "Host ~S has no ~S address" host family)))
    (let ((hostent (ipc::gethostbyname host)))
      (unwind-protect
	   (progn
	     (when (zerop hostent)
	       (no-host-error))
	     (ecase family
	       ((:internet)
		(unless (= (ipc::hostent-addrtype hostent) 2)
		  (no-address-error))
		(assert (= (ipc::hostent-length hostent) 4))
		(let ((addr (ipc::hostent-addr hostent)))
		   (when (or (member comp::.target.
				     '(:hp :sgi4d :sony :dec3100)
				     :test #'eq)
			     (probe-file "/lib/ld.so"))
		     ;; BSD 4.3 based systems require an extra indirection
		     (setq addr (si:memref-int addr 0 0 :unsigned-long)))
		  (list :internet
			(si:memref-int addr 0 0 :unsigned-byte)
			(si:memref-int addr 1 0 :unsigned-byte)
			(si:memref-int addr 2 0 :unsigned-byte)
			(si:memref-int addr 3 0 :unsigned-byte))))))
	;; removed this upon handling [spr6864]
	;; (ff:free-cstruct hostent)
	))))
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
----------------------------------------------------------------------
