	Allegro CL (Windows) Frequently Asked Questions (FAQ) & Answers

Last-modified: $Date: 1995/08/30 20:25:10 $
Version: $Revision: 1.17 $
Location: ftp.uu.net:~ftp/vendor/franz/acl4w-faq

  This is a list of frequently asked questions on Allegro Common Lisp
  (ACL) for Windows (ACL (Unix) issues are currently dealt with
  in the file faq found in this directory).  Please read this document
  before sending mail to pc-support@franz.com or
  allegro-cl@cs.berkeley.edu.  We (Franz Inc.) will mail the changes
  in the list approximately monthly to allegro-cl@cs.berkeley.edu.
  Periodically, also, items from this list will be incorporated into
  our documentation. 

  Your comments, additions and fixes to this list are welcome: please
  send them to pc-support@franz.com.

  
Subject: Table of Contents
From: Preface

Legend: + new, - deleted, ! changed

1. Administrative Issues:
------------------------
  1.1.  Version info for ACL
	* What is the current version of ACL for Windows?
  1.2.  ACL-related communication
	* How should I report bugs?
	* Is there a mailing list for Allegro CL?  How do I sign up?
  1.3.  Patches
	* Is there a public patch directory you maintain for incremental
	  patches to the ACL image? If so, how do I get to it?
	* What is the ftp.uu.net, or what is the internet number so I
	  can get to all of your patches?
	* Can I load patches explicitly once lisp is already running?
	* When I redefine a "protected function" in a patch and load
	  it in, I get a break about redefining a protected function
	  even if I have bound top::*warn-on-redefinition* to NIL.
	  What do I do?  
  1.4.  ACL Documentation 
	* What is the relationship between this FAQ and ACL
	  documentation?
	* Is the ACL documentation available on-line?
  1.5.  Windows configuration
	* How can I tell if my problems are due to running out of
	  either virtual memory or Windows resources?
	* How can I set up a permanent swap file in Windows?
	* What to do about Windows sometimes hanging randomly or even
	  dropping back to DOS?
	* How can I determine if Windows NT is being run?
	* How can I determine if Windows For Workgroups is being run?
	* Does Allegro CL for Windows run under Windows 95?


2. Using Allegro CL:
-------------------
  2.1. Base Lisp
	* I'm having trouble saving a file after editing it.  I get a 
	  dialog box that says "SHARING VIOLATION ON DRIVE C".
	* What things can make aclwin 2.0 crash with a General
	  Protection Fault?
	* When an error occurs while loading a file, how can I tell at
	  what point in the file the error occurred?
	* How can I have the inspector not use special functionality
	  for displaying certain types of objects, when I would just
	  like to see all the slots as usual?
	* How can I catch when lisp is being exited and conditionally
	  abort from exiting?
	* How can I turn off the super-paren feature, where a closing
	  bracket closes all open parentheses?
	* Why is set-scroll-range unreliable for scroll ranges greater
	  than 32,000?
	* The function count-icons-in-file doesn't work.  What do I
	  do? 
	* Why can't I load a fasl file with an extension other than
	  ".fsl"?
	* How can I suppress compiler warnings when loading a source
	  code file?
	* How can I get rid of the vertical scrollbar on the main lisp 
	  window?
	* What do I do about "error: expression too large to compile
	  in COMPILE.  Split it and try again."?
	* When I try to start up Allegro, the screen flashes dark 
	  for a moment, and then returns to the Program Manager.
	  What's wrong?
	* Do you have any information on the floating-point arithmetic
	  bug in Intel's pentium chip?
	* Read-char is rather slow, apparently due to it not
	  bufferring input.  Can I speed it up some way?
	* When I ask for help about a windows function I obtain the
	  following message: Can't find the Windows help file
	  "c:\\api32wh.hlp" for the on-line manual.  How can I obtain
	  this file?
	* When I compile a file or files using the compile dialog
	  from the File menu, the directory for the fasl file to be
	  created is always the lisp startup directory, instead of
	  the directory of the source code files that I selected.
	  Do you have a fix for this?
	* Sometimes I put print statements in my code (especially
	  interface code) to debug it, and notice that the code
	  behaves differently when the print statements are in there.
	  How can I use print statements for debugging without
	  changing other behavior?

  2.2. Windows/DOS interface
	* How can I get the current Windows/DOS directory?
	* How can I change the current Windows/DOS directory?
	* How can I get the "Windows directory" and the "Windows
	  system directory"?
	* How can I get the directory where the running lisp.exe
	  lives?
	* How can I get the name of the lisp image file that is being
	  run?
	* How can I determine whether a particular directory exists?
	* How can I get a list of all files in a directory?
	* How can I get a list of all subdirectories of a directory?
	* How can I create a directory from lisp?
	* How can I execute a Windows program from lisp?
	* How can I execute a Windows program from lisp SYNCHRONOUSLY?
	* How can I execute DOS commands (not Windows programs) from
	  lisp?
	* How can I execute DOS commands from lisp SYNCHRONOUSLY?
	* How can I create an icon programmatically from a pixmap
	  array?
	* How can I invoke Windows help files (extension .hlp) in
	  aclpc?
	* How can I add a standard Windows caret (for a text cursor,
	  for example) to my window?
	* How can I make one file load other files from the same
	  directory, without knowing what directory it and the
	  other files are in?
	* What are "Windows resources" and why do they run out?
	* When I start up lisp, I get an error box that mentions a
	  GROWSTUB error in pointer.dll.  When I exit the error box,
	  lisp proceeds to run OK, but how can I avoid this error
	  notification?
	* When I try to exit Windows while lisp is running, and I
	  tell lisp when it prompts that it's OK, lisp will then
	  exit but not Windows.
	* I recently upgraded from NT 3.1 to NT 3.5, and am 
	  having a problem with strange lisp crashes when bringing up
	  particular dialog windows.  In particular, the interface
	  builder's menu dialog crashes lisp when invoked under
	  NT 3.5.  Do you know what the problem is here?
	* I've been getting some strange crashes when running
	  aclwin 2.0 under NT.  The aclxdump.txt file that is
	  generated shows the following sort of stack backtrace:
	  CLASS-OF
	  FIND-APPLICABLE-METHOD-INFO
	  FIND-APPLICABLE-METHOD-INFO
	  FIND-APPLICABLE-METHOD-INFO
	  EVENT
	  WINDOW-PROCEDURE
	* When trying to start aclwin, I sometimes get the error
	  "WIDGE32.DLL could not be loaded".
	* I could use aclpc 1.0 as my Windows 3.1 shell in place
	  of program manager, but this doesn't work with aclwin 2.0.
	  Why not?
	* I notice that aclwin 2.0 still requires short "8.3"
	  filenames.  Is there a patch for this?
	* I'm trying to open a file and getting "DOS Error -1".
	  What does this mean?
	* When I try to start up aclwin, I get the error "Image
	  Loading Failed".  What does this indicate?

  2.3. Garbage collector
	* What kind of garbage collection does aclwin have?
	* How can I configure the garbage collector?

  2.4. Printer issues
	* Can I draw graphics directly onto a printer?
	* Can I copy the contents of windows to the printer?
	* How can I draw text on the printer with the same font size
	  as a window?
	* How can I pop up the "printer setup" dialog?
	* Can I set the "printer setup" parameters programmatically?
	* Can I pop up the "printer dialog" for specifying which pages
	  to print, number of copies, etc.?

  2.5. Programming tools
	* When I pop up the find-in-file dialog after having added some
	  directories to choose from, saved preferences, and restarted
	  lisp with those preferences.  It gets confused about the
	  current directory in the directory browser list box or else
	  breaks.  Is this a bug?
	* What's a typical sequence of steps for doing profiling?
	* Error handling: How can I handle particular errors myself
	  rather than breaking?
	* There's no defsystem facility in aclwin.  Can I get one
	   anywhere?
	* I have written my own macros that I use to define functions,
	  classes, or variables rather than using defun, defvar,
	  and defclass.  This works fine except that find-definition
	  will not find the definitions that I define using these
	  macros.  What can I do?


3. Add-on products/features:
---------------------------
  3.1. Common Graphics
	* How come the "event" method isn't invoked for
	  widgets/dialog-items?
	* How can I send messages to the windows of other
	  applications?
	* How come widgets won't display colors that the dialog window
	  will?
	* Why can I only get 16 or 20 colors, when I'm trying to
	  display up to 256?
	* When I use copy-pixels-to-stream, the colors aren't mapped
	  correctly even though I pass the texture-info (which
	  contains the correct colormap) that was returned by
	  load-pixmap.  Why?
	* I'm confused about the difference between pixel-maps, pixmaps,
	  textures, and texture-infos.
	* When drawing using the cg:invert operation to "logxor" pixel
	  values, sometimes colors automatically invert to intuitive
	  colors, and sometimes not.  Why?
	* When another application changes the system palette, how can
	  I detect this and re-realize my own palettes?
	* I want to pop up a pop-up dialog and have the input focus be
	  initially on a particular widget in that dialog, but the
	  focus always seems to be on a particular arbitrary widget
	  rather than the one to which I set focus just before calling
	  pop-up-dialog.  What do I do?
	* How can I have one modal (pop-up) dialog invoke a second modal
	  dialog, so that the user can't mouse widgets on the first
	  while the second is on the screen?
	* How can I have one window on top of another one without the
	  window on top moving when the other window is scrolled?
	* How come no "character" events are coming into the event
	  method? 
	* What do I do if when trying to create a bitmap-window I get
	  this error?
	  ;;;; ERROR: Error creating a memory bitmap of size 632
	  by 453; likely not enough available memory.
	* How do you disable a whole pull-down menu on a menu bar, as
	  opposed to disabling a menu item?
	* When I add a menubar to a pop-up dialog, there's a gap along
	  the bottom of the title bar where a few rows of background
	  pixels show through.  Why?
	* When I have a non-delayed text widget and reject certain
	  typed characters in my set-value-fn, it moves the cursor
	  back to the start.  How can I keep the text cursor where it
	  was before the invalid character was typed?
	* I get a stack overflow when I return NIL from the
	  set-value-fn of my radio buttons.  What do I do?
	* How can I optionally prevent a user from closing a window?
	* How are the default-button and cancel-button different from
	  regular buttons?
	* I often notice that the button with the thick border is not 
	  really the "default button" that is invoked when the user
	  presses ENTER.  Also, I would like to be able to change the
	  acting default-button programmatically.
	* How come setting the background color of a widget to NIL
	  makes it draw with a light-gray background rather than the
	  system window background color?
	* The font selector Common Dialog shows only true type fonts.
	* The tabbing order of widgets differed from what I had
	  expected.
	* When an object that's shown in a list widget or combo-box
	  changes in such a way that it should print differently in
	  the widget (such as when a :key is used) even though the
	  same lisp objects are in the widget's range, how do you make
	  the widget redisplay properly?
	* When I programmatically set the value of a combo box (or
	  list widget), it doesn't display the choice, though it works
	  just fine when I set the value by choosing an option with
	  the mouse.  Why?
	* When I select all the text in a 3D text-widget and hit
	  backspace, lisp doesn't realize that the value has changed.
	* How do I use a transparent background color for the text on
	  a window?
	* How does the double click work on a single-item-list widget?
	* Save-fasl-pixmap doesn't seem to work.  What do I do?
	* Can I print help messages as the user highlights various
	  menu-items of a menu that they are perusing?
	* How can I position the text cursor at the end of a
	  text-edit-window, or otherwise ensure that output goes to
	  the end of the existing text?
	* Can I attach a comtab to a text-edit-pane and make RETURN
	  process the line that the user just typed?
	* When I move several widgets programmatically, the redisplay
	  looks ugly and is rather slow.  Can I make this neater
	  and/or speed it up?
	* How might one change the color of the dialog used by
	  pop-up-message-dialog from light-gray to white?
	* When I use the ask-user-for-font pop-up dialog, sometimes
	  it returns a font which is not quite the size that I
	  selected.  In fact, it can even return a different size
	  than I passed in when I don't change the font at all on
	  the dialog.  Do you have a fix for this?
	* Do you have a "tooltips" facility, for popping up little
	  help windows beside widgets when the mouse pauses over them?
	* I created a window subclass and added some slots to it, 
	  but when I inspect an instance of this class the inspector
	  window doesn't show my new slots.  How can I view all
	  the slots?
	* The DELETE key seems to do nothing instead of deleting a
	  single character when pressed in a single-line text widget
	  when there is no text selected.  What's the deal?
	* I'm running out of Windows resources and memory when I call
	  copy-pixels-to-stream-from-file a lot, even though I'm
	  closing the bitmap-pane that it creates each time.
	* If I call either move-window or move-window-behind on an
	  iconized window, the text below the icon stays where it was.
	  Is there a fix?

  3.2. Foreign-Function interface
	* Can you give me an example of passing a callback function to
	  Windows?
	* Is the example code in the ex/ffi32 directory generally
	  applicable?
	* Do you have a DDE interface on top of the low-level Windows
	  API for DDE?
	* How can I find the DDE commands that are available in the
	  Program Manager?
	* Do you have a high-level interface into the MCI multimedia
	  functionality?
	* I'm trying to make foreign function calls into a 16-bit
	  DLL, and get the errors "The procedure entry point
	  UTRegister could not be located in the dynamic link library
	  kernel32.dll" and "Error: Could not load module
	  ACLGUT32.DLL".  What am I doing wrong?

  3.3. Runtime
	* Do you have an example of a complete runtime application,
	  with a menu bar and a dialog window even?
	* How can I prevent the user from running multiple instances
	  of my runtime application?
	* I'm using an exported and documented function that doesn't
	  exist in the runtime image, but I need it for my runtime
	  application.  What can I do?
	* I would like to associate my own icon with the (renamed)
	  lisp.exe file that I ship with my product, and would like
	  for this icon to appear automatically.  How is this done?

  3.4. Editor
 	* Can you give me some examples of defining keystroke behavior
	  with comtabs (command tables), for use in lisp editor
	  windows?
	* When I use make-mark to add my own marks to a text-edit
	  window and later use file-position to return the cursor to
	  these marks, I find that the positions of the marks have not
	  been updated appropriately as text is inserted and deleted
	  before the marks.  Is there a fix?
	* I'm using text-edit-windows in my runtime application along
	  with the functions te:load-file and te:save-file, and notice
	  that these two functions always put a "Package FOO" string
	  in the title bar, which is not appropriate.  Can I customize
	  this some way?



Section 1: ADMINISTRATIVE ISSUES
================================

1.1:  Version info for ACL
--------------------------

----------------------------------------------------------------------
Q) What is the current version of ACL for Windows?

A) The current version is 2.0 (for Win32s and Windows NT).
----------------------------------------------------------------------


1.2: ACL-related communication
------------------------------

----------------------------------------------------------------------
Q) How should I report bugs?

A) Send small reproducible transcripts to pc-support@franz.com.  For
other alternatives, see the READ THIS FIRST document that came with
your ACL for Windows package.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Is there a mailing list for Allegro CL?  How do I sign up?

A) Yes, there is a mailing list for Allegro CL users.  It is accessed
through the address allegro-cl@cs.berkeley.edu.  To be added to or
deleted from this list, send mail to
allegro-cl-request@cs.berkeley.edu.  Franz periodically makes 
announcements on this mailing list, but its main purpose is to allow
users of Allegro CL (Unix and Windows) to communicate with each other,
sharing ideas, complaints and code.
----------------------------------------------------------------------


1.3: Patches
------------

----------------------------------------------------------------------
Q) Is there a public patch directory you maintain for incremental
patches to the ACL image? If so, how do I get to it?

A) 
Franz Inc. Patches on UUNET

  The patches are all available on uunet:~ftp/vendor/franz/patches (==
uunet!~/vendor/franz/patches).  There is a README in the toplevel
directory which explains how to find and load the patches for your
version of Allegro CL.  As patches become available, the files in this
directory will be updated, so it is a good idea to periodically check
the particular subdirectories you may be interested in for changes.

  The following is an example of how to access the README file in the
patch directory:

% ftp ftp.uu.net
Name: ftp
Password: <your login name>
ftp> cd ~ftp/vendor/franz/patches
ftp> get README

Here is the internet address for the machine where the Allegro CL
patches are kept:

192.48.96.9	ftp.uu.net
----------------------------------------------------------------------

----------------------------------------------------------------------
Q) What is the ftp.uu.net, or what is the internet number so I can get
to all of your patches?

A) Here is the internet address for the machine where the Allegro CL
patches are kept:

192.48.96.9	ftp.uu.net

  If you do not have access to the internet, you may still be able to
get access to the directory via other methods.  If you are on the
BITNET/NetNorth/EARN system, the bitftp service may be helpful in
accessing ftp files.  Your system administrators may know of other ftp
servers as well.

  If you can't get access to uunet via ftp, and you do not have a
direct connection to uunet (ie, a uunet subscription), you can use
uunet's 900 service which will show up as a charge on your telephone
bill.  Here is some information about how to use the 900 service from
uunet:

How to reach UUNET's 900 number via uucp
========================================
Here are some sample a L.sys or Systems file lines suitable for UUNET's
900 number:

#
# Simple line.
uunet Any ACU 19200 1-900-468-7727 in:--in:--in: uucp
#
# Set up for a Telebit.
uunet Any cua0 19200 cua0 "" ATX0S50=255S111=30DT19004687727\r CONNECT "" login: uucp

Modify as appropriate for your site, of course, to deal with your local
telephone system and uucp version.

Note that these modems first answer with V.32, then at 2400, 1200, and
last with PEP tones.

This "900" number charges $.40US per minute to the caller.

All modems on the 900 lines are Telebit T2500s.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Can I load patches explicitly once lisp is already running?

A) If you avoided loading patches at lisp startup time, for example by
renaming your update directory to something else, you can load them
later after lisp is already running like this: 

* rename the update directory back to "update"
* call (top::load-patches)

top::load-patches will attempt to load any patches from the "update"
subdirectory of the directory that contains the lisp.exe that you are
running.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I redefine a "protected function" in a patch and load it in,
I get a break about redefining a protected function even if I have
bound top::*warn-on-redefinition* to NIL.  What do I do?

A) top::*warn-on-redefinition* only prevents the break due to
redefining an ordinary function that had been defined in a different
file.  There is no such variable for protected functions, but here's
a workaround:

Define this functions and place a call to it just before the function
redefinition:

(defun unprotect-function-name (function-name-symbol)
  ;; clear protected bit by copying symbol function onto itself
  (set-symbol-function function-name-symbol
    (symbol-function function-name-symbol)))

Alternately, here's a macro that you could define and place
around calls to LOAD in order to avoid any protection error:

(defmacro without-protection-errors (&body body)
   ;; Turn off errors within BODY for attempts to redefine
   ;; protected functions.
   ;; If needed, could do this for acl::check-for-protected-class
   ;; also and perhaps acl::check-defgeneric-function-specifier
   (let ((old-protected-function-p (gensym)))
      `(let ((,old-protected-function-p
              (symbol-function 'acl::protected-function-p)))
          (unwind-protect
               (progn
                  (setf (symbol-function 'acl::protected-function-p)
                        #'(lambda (&rest xxx)
                            (declare (ignore xxx)) nil))
                  ,@body)
             (setf (symbol-function 'acl::protected-function-p)
                   ,old-protected-function-p)))))
----------------------------------------------------------------------


1.4: ACL Documentation
----------------------

----------------------------------------------------------------------
Q) What is the relationship between this FAQ and ACL documentation?

A) The ACL documentation and this FAQ list are designed to be mutually 
exclusive.  It is our intention to maintain this FAQ list as a
repository of current frequently-asked questions, which have arisen
since the last release of the ACL documentation (and are sometimes
pertinent only to a certain release of ACL).  Those questions which
endure across releases will be incorporated into the ACL documentation
in due course, and simultaneously removed from the FAQ list.
----------------------------------------------------------------------

----------------------------------------------------------------------
Q) Is the ACL documentation available on-line?

A) ACL for Windows documentation is available on-line at no cost only
to site licensees.  A site license gives you the right to reproduce
the documentation.  We normally arrange this by sending PostScript
files of the printed documentation, which you can print on a laser
printer (one copy can serve as a master).  Send mail to
pc-support@franz.com if you are eligible and interested in on-line
documentation.

We typically distribute the files by ftp.  We place them on an ftp
site and you pick them up from there.  The various PostScript files
are bundled with tar into tar files, which are in turn compressed
(using the UNIX compress routine).  You will need access to a UNIX
workstation to uncompress and untar the files.  Please tell us if you 
do not have access to a UNIX workstation and we will make other
arrangements.
----------------------------------------------------------------------


1.5: Windows configuration
--------------------------

----------------------------------------------------------------------
Q) How can I tell if my problems are due to running out of either
virtual memory or Windows resources?

A) When the problem happens, switch to the Program Manager, bring up
the Help menu from the menu bar, and select "About Program Manager".
The bottom of the window that pops up should list the amount of free
memory in kilobytes and the amount of free Windows resources as a
percentage.

The resource percentage is actually the lowest percentage for the four
separate 32K tables that Windows maintains to store handles to 4
categories of resources such as windows, bitmaps, and strings.  So if
more than 32,768 strings, for example, exist concurrently in all
Windows tasks taken together, you will run out of "Windows resources".

Windows95 pretty much gets rid of the resource limitation.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I set up a permanent swap file in Windows?

A) From the Program Manager, use Control Panel --> 386 Enhanced -->
Virtual Memory --> Change

You must first have a *contiguous* block of free disk of sufficient
size.  You will not be allowed to set up a permanent swap file
if the disk (or the particular partition being used) is compressed.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What to do about Windows sometimes hanging randomly or even dropping
back to DOS?

A) A user once sent the following suggestion:

Try editing the SYSTEM.INI file and adding the following line to the
[386Enh] section:

TimerCriticalSection=1000
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I determine if Windows NT is being run?

NT is being run if the variable pc::*running-nt-p* is non-NIL.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I determine if Windows For Workgroups is being run?

We don't have a simple answer for this; it seems the closest thing is
to call winver.exe.  There is probably a better way to do this, but
doing WinExec on winver with output redirected to a file, and then
parsing the file will give you the information you need.  This should
only be done after you've determined that you are not running under
NT (see above).
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Does Allegro CL for Windows run under Windows 95?

A1) The upcoming Allegro 3.0 for Windows DOES RUN under Windows 95.

A2) There is a small incompatibility that prevents Allegro CL for
Windows 2.0 from starting under Windows 95.  The rest of this answer
gives a workaround for this incompatibility.  If you have access to
Windows NT or Windows 3.1 (or Windows for Workgroups), you can apply
the workaround described in the subsection "Using Pre-Windows 95 To
Work Around The Incompatibility".  This will create an image file that
you can use under Windows 95.

If you do not have access to an earlier release of Windows, then
please follow the procedure in the subsection "Using Windows 95 To
Work Around The Incompatibility".  Note that for this case, you will
not be able to fix up Allegro Runtime.  To fix Allegro Runtime, you
need to use the "Using Pre-Windows 95 To Work Around The
Incompatibility" section.

* Using Pre-Windows 95 To Around The Incompatibility.

(1) Start up aclwin under NT or 3.1

(2) At the toploop, type in the following:

> (defun pc::running-nt-p () t)
> (save-image :image-file "win95.img")

This will create a win95.img which should work under Windows 95.  To
try it, go to Windows 95 and "run" (from, eg, the start menu) the
following (assuming C:\ALLEGRO is your aclwin directory):

  c:\allegro\lisp.exe c:\allegro\win95.img

You can follow the same procedure for runtime.img to create a
win95r.img to fix Allegro Runtime 2.0.


* Using Windows 95 To Work Around The Incompatibility.

Detailed Procedure:

--Start a "MS-DOS Prompt" and cd to your Allegro CL installation
directory.  For these notes, we are assuming the directory is called
"c:\allegro".

 > c:
 > cd \allegro
 c:\allegro> 

--If you already have a file called c:\allegro\prefs.lsp, then move it
to a different name.  Later in this procedure, we show when you can
move it back.

Example:

 c:\allegro> move prefs.lsp prefs-o.lsp

--Using any text editor, create a NEW temporary prefs.lsp file with
the following two forms:

(fmakunbound 'pc::running-nt-p)
(defun pc::running-nt-p () t)


--You should now be able to start up lisp.

 c:\allegro> .\lisp.exe .\allegro.img
 c:\allegro>                          <<< Note the DOS prompt appears before
				      <<< before the lisp starts up.  Please
				      <<< wait for the lisp toploop.

--In the toploop, save the started image to a separate Windows 95 image.

 > (save-image :image-file "win95.img" :patches-directory #p"update\\")

--The toploop will disappear, and then reappear.  When the toploop
reappears, exit the lisp.

--Using the Shell, fix up the "Allegro CL" icon to refer to the newly
created win95.img instead of allegro.img.

 right-click on the Start button,
 select Open,
 double-click on "Programs",
 double-click on "Allegro CL for Windows 2.0",
 right-click on "Allegro CL",
 click Properties,
 select Shortcut tab,
 go to "Target:" and change "ALLEGRO.IMG" to "WIN95.IMG".
 select OK.

You can now delete all the folder windows just created on the screen.

--You can now remove the temporary prefs.lsp and restore your original
if you had one.

 c:\allegro> del prefs.lsp
 c:\allegro> move prefs-o.lsp prefs.lsp

Now, you can start Allegro CL 2.0 under Windows 95.  Enjoy!
----------------------------------------------------------------------


Section 2. Using Allegro CL
===========================

2.1: Base Lisp
--------------

----------------------------------------------------------------------
Q) I'm having trouble saving a file after editing it.  I get a
dialog box that says "SHARING VIOLATION ON DRIVE C".

A) If you have a file open for reading then you can't simultaneously
write to it.  Typically this comes up when you are loading a file in
aclpc and get an error and select 'debug'.  Once you find the error
and fix it in the editor, the 'save' fails because aclpc is still
reading the file since it was interrupted in the process of loading
the file.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What things can make aclwin 2.0 crash get a General Protection Fault?

A) * Passing non-fixnums to common graphics functions.

   * Using deep recursion so that the function stack size of 128K
     is exceeded.  We are not able to determine when this is about to
     happen.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When an error occurs while loading a file, how can I tell at what
point in the file the error occurred?

A) (load "somefile.lsp" :print t)

This also works with .fsl (compiled) files.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I have the inspector not use special functionality for
displaying certain types of objects, when I would just like to see all
the slots as usual?

A) One trick for getting rid of the inspector's special handling of
certain classes is the following.  You'll want to change the list of
classes given to be those classes you care about seeing displayed:

(let ((gf (acl::generic-function-object 'insp::inspect-object)))
  (dolist (class '(class
                   slot-definition
                   standard-direct-slot-definition
		   standard-generic-function
		   standard-method))
    (remove-method gf
		   (find-method gf nil (list (find-class class)
					     (find-class t))))))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I catch when lisp is being exited and conditionally abort
from exiting?

A) You can push a function or function name onto
top::*top-may-exit-tests*.  If the function returns NIL then the exit
of lisp is aborted.  The function should take one argument, which is
always NIL.

Example code (fill in the [BRACKETTED] part with your own code):

(defun my-may-exit-test (dummy)
  (declare (ignore dummy)
  (or [THERE IS NO UNSAVED STUFF]
    (let ((choice (ask-user-for-choice "Save unsaved stuff first?"
                    :~save :~discard :~cancel)))
      (when (eq choice :~save)
        [SAVE STUFF NOW])
      (not (eq choice :~cancel))))

(pushnew 'my-may-exit-test top:*top-may-exit-tests*)
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I turn off the super-paren feature, where a closing bracket
closes all open parentheses?

A) (set-syntax #\[ 'constituent)
   (set-syntax #\] 'constituent)
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Why is set-scroll-range unreliable for scroll ranges greater than
32,000? 

A) This is due to a 16-bit limitation on scroll-position values in 
Windows.  In 32-bit Windows (which aclwin 2.0 uses), our code
could be enhanced to work around this problem for non-continuous
scrolling, but it still wouldn't work for continous scrolling
(where the window is redisplayed while the user drags the
elevator box).  The only general workaround is for you to map
larger domain ranges onto the allowed 32K pixel scroll range.

For a fuller explanation, see the GetScrollPos entry in the 32-bit
Windows API WinHelp (if you have the Windows SDK).
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) The function count-icons-in-file doesn't work.  What do I do?

A) As a workaround until this is patched, use this form:

(extract-icon-from-file some-filename #xffffffff)
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Why can't I load a fasl file with an extension other than ".fsl"?

A) The loader assumes that it's a source file to load unless the
extension is included in the list in the following method, which
normally has only "FSL" in it.  This example redefinition additionally
allows an extension of "ASL" for fasl files, so you could add your own
file types similarly.

(defmethod location-fasl-file-p ((stream pc::dos-location))
   (member (pathname-type (stream-location stream)) '("ASL" "FSL")
           :test #'equalp))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I suppress compiler warnings when loading a source code
file?

A) First of all, the *compiler-warnings* option on the preferences
dialog is not implemented.  Normally warnings are always printed
when loading a source code file.

If you really do not want warnings, you can wrap the following around
your calls to LOAD and COMPILE-FILE:

(handler-bind ((warning 'muffle-warning))
  (load XXX))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I get rid of the vertical scrollbar on the main lisp
window?  It's confusing when it lies immediately beside the scrollbar
of a maximized child window.

A) The following two forms will do the trick.  You could put them into 
your startup.lsp file to turn the scrollbar off automatically whenever 
lisp starts up.  Actually, the second form alone will turn the
scrollbar off, but without the first form the scrollbar would reappear
after resizing the main lisp window or toggling the toolbar or
status bar on or off.

(defmethod pc::update-scroll-bars-for-new-window-size
    ((window (eql *lisp-main-window*)))
  nil)
(set-scroll-range *lisp-main-window* 0 0)
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What do I do about "error: expression too large to compile in
COMPILE.  Split it and try again."?

A) This happens when the heap size is too small.  You can increase
this by editing the allegro.ini file and restarting lisp.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I try to start up Allegro, the screen flashes dark for a
moment, and then returns to the Program Manager.  What's wrong?

A) This happens when you have not installed Win32s.  Win32s is a
Microsoft product that is needed for running 32-bit Windows programs
(such as Allegro CL) on Windows 3.1 or Windows for Workgroups.  We
ship Win32s with Allegro CL, and you should install it before
installing and running Allegro.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Do you have any information on the floating-point arithmetic bug in
Intel's pentium chip?

A) This lisp expression will demonstrate the bug, by returning 256.0
rather than zero or close to it:

(- 4195835.0 (* (/ 4195835.0 3145727.0) 3145727.0))

Intel is now replacing the chips with no questions asked.
Call 1-800-628-8686.

----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Read-char is rather slow, apparently due to it not bufferring
input.  Can I speed it up some way?

A) We are aware of this situation.  For now, you can try using the the
ACL::READ-CHAR1 function.  This function is internal and undocumented,
and thus subject to change in a future release.  ACL::READ-CHAR1 is
similar to READ-CHAR except that it does do buffering.
ACL::READ-CHAR1 also has a different lambda-list: (STREAM EOF-ERROR-P
EOF-VALUE).  This is as opposed to READ-CHAR whose lambda-list is
(&OPTIONAL INPUT-STREAM (EOF-ERROR-P T) EOF-VALUE RECURSIVE-P).
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I ask for help about a windows function I obtain the following
message: Can't find the Windows help file "c:\\api32wh.hlp" for the
on-line manual.  How can I obtain this file?

A) We put a bit of a hack in the code which looks up a Windows API
function in the help file that comes with the Windows Software
Development Kit (SDK) if you have it on your machine and have pointed
the proper global variable to the directory that it is in.  The SDK
must be purchased from Microsoft and so we can't distribute it, but if
you have it and then set allegro::*win32-help-path* to be the complete
pathname string for the api32wh.hlp file, then you can use the aclwin
help command to look up Windows API symbols (anything in the "win"
package) in it.

In addition, a pending patch that we can send you on request
is needed to make our winhelp facility work with the SDK's
help file.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I compile a file or files using the compile dialog from the
File menu, the directory for the fasl file to be created is always
the lisp startup directory, instead of the directory of the
source code files that I selected.  Do you have a fix for this?

A) We have a pending patch for this that we could send on request.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Sometimes I put print statements in my code (especially interface
code) to debug it, and notice that the code behaves differently when
the print statements are in there.  How can I use print statements
for debugging without changing other behavior?

A) The problem is probably due to the fact that printing functions
will call process-pending-events, which will cause queued events
to be handled at that time rather than later, and so your event
handling code may run in a different order.  To prevent this,
you can wrap any print statements in a without-interrupts form,
which causes calls to process-pending-events to simply do nothing:

(without-interrupts (print (list "Foo" foo)))
----------------------------------------------------------------------


2.2: Windows/DOS interface
--------------------------

----------------------------------------------------------------------
Q) How can I get the current Windows/DOS directory?

A) (allegro:current-directory)
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I change the current Windows/DOS directory?

A) (allegro:set-current-directory pathname-or-string).

Example:
(set-current-directory "C:\\WINDOWS")
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I get the "Windows directory" and the "Windows system
directory"?

A) (allegro:windows-directory &optional system-directory-p)

These are the directories where Windows itself is installed, and
are typically c:\windows and c:\windows\system.  This function will
return either of these, depending on whether system-directory-p is
non-NIL.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I get the directory where the running lisp.exe lives?

A) allegro::*application-directory* 

This variable contains the pathname of the lisp.exe file that was 
executed for the lisp (or runtime application) that you are running.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I get the name of the lisp image file that is being run?

A) allegro::*command-line*

This variable contains the argument string that was passed to the
lisp.exe command; this is normally the name of the lisp image file,
and is typically entered in the command line for a Program Manager
icon.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I determine whether a particular directory exists?

A) There is no built-in way to do this, since DOS directories are
not considered to be "files" and so probe-file doesn't work on them.
You could define this function for this purpose:

(defun directory-exists-p (pname)
  (let* ((current-dir (pc::dos-current-directory *local-host*)))
    (cond ((pc::set-dos-current-directory pname)
           (pc::set-dos-current-directory current-dir)
           t)
          (t nil))))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I get a list of all files in a directory?

(directory "z:\\foo\\*.*")
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I get a list of all subdirectories of a directory?

(directory "z:\\foo\\*\\")
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I create a directory from lisp?

A) (win:mkdir "MYDIR")

OR

open a file for which the directory does not yet exist:
(open "z:\\lwolf\\foodir\\myfile" :direction :output
				  :if-exists :overwrite))
This creates both the directory foodir and the file myfile if they did
not already exist
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I execute a Windows program from lisp?

A) (win:winexec "c:\\windows\\notepad" win:sw_show)
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I execute a Windows program from lisp SYNCHRONOUSLY?
(being able to wait for the program to terminate)

A) You can't do it, unless perhaps you can make the launched program do
something like create a file at the end, and pole in lisp for the file
to exist.  If doing such polling in lisp, be sure to call
(process-pending-events) inside the loop to prevent tying up the cpu.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I execute DOS commands (not Windows programs) from lisp?

A) (win:winexec "command.com /c parser.exe filename > parout" win:sw_show)

(In DOS, COMMAND.COM deals with the "<", ">", and "|" commands.)
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I execute DOS commands from lisp SYNCHRONOUSLY?

A) Send mail to pc-support@franz.com for code (ref: pcrfe423) that can
wait and return the string that DOS would normally print, and also
avoid blanking out the screen while executing the DOS command.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I create an icon programmatically from a pixmap array?

A) Unfortunately, you can't do this currently.  We wrote code to do it
(create-icon), but couldn't figure out how to get the colormap right,
since there doesn't seem to be a provision for that in the Windows API
function CreateIcon.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I invoke Windows help files (extension .hlp) in aclpc?

A) You can use the Windows API function WinHelp for this.

Example:

(win:winhelp (pc:window-handle *lisp-main-window*)
	     "c:\\windows\\calendar.hlp"
	     win:help_index
	     null
	     :static)

In this example, help_index is the "command" argument, and zero is the
"data" argument, which is interpretted according to the particular
command argument.  help_index displays the help file's index; here are
some other command arguments and their meanings for the data argument:

command: win:help_context
data: the context number for a topic, as defined in the [MAP] section
  of the .HPJ file
action: displays help on a particular topic

command win:help_contextpopup
data: the context number for a topic
action: displays a particular topic in a pop-up window

command: win:help_contents (same as win:help_index)
data: null (this symbol is bound to a cpointer of zero)
action: displays the contents topic as defined in the [OPTIONS]
  section of the .HPJ file

command: win:help_key
data: a string indicating a keyword for a desired topic
action: displays the topic found in the keyword list for that keyword

command: win:help_quit
data: null
action: Informs the help application that lisp no longer needs help.
  If no other applications are using that help window, it is closed.

There are several other less commonly used commands also.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I add a standard Windows caret (for a text cursor, for
example) to my window?

A) We have a potential patch to implement this Windows feature.  Send
mail to pc-support@franz.com if interested.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I make one file load other files from the same directory,
without knowing what directory it and the other files are in?

While the first file is being loaded, the variable
allegro:*file-being-loaded* is bound to the pathname of that file.
So to load other files in the same directory, you could use a
form like the following:

(dolist (filename '(foo.lsp bar.lsp baz.lsp))
  (load (namestring (merge-pathnames filename *file-being-loaded*))))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What are "Windows resources" and why do they run out?

A) Basically, Windows 3.1 and Windows for Workgroups (but not NT)
contain four heaps for storing various graphical "resources".  These
heaps are limited to 64K in size so that they can be indexed with
short integers.  "Resources" include fonts, bitmaps, windows, menus,
strings, and other stuff.  A "handle" in Windows is actually an index
into one of these heaps.  The heaps are shared by all of the Windows
programs that you have running, which is why you can often run only a
few Windows programs simultaneously before you run out of resources,
no matter how much real and virtual memory your machine has.  The
number reported by Program Manager is the percentage of resources left
in whichever of the four heaps is most nearly depleted, but funny
things often start happening when the number is well above zero, where
apparently Windows is trying to make do with inadequate room to store
all the resources it needs in the heap at once.  Some applications do
not properly "destroy" all of the resources that they have allocated
when they exit, in which case you need to restart Windows in order to
recover all available resources.

The good news is that after much fear and loathing when this situation
wasn't remedied in the first Windows 95 beta, the limitation is now
reported to be (pretty much) fixed, as the three heaps used by the
USER library have been gotten rid of and their objects moved into the
normal 32-bit address space, and only the fourth 16-bit heap, used by
the GDI library for some portion of the low-level graphics needs,
remains.  Windows magazine reports that they can run twice as many
simultaneous Windows apps in Window 95 Beta 2 as they could before and
yet have more reported resources remaining.  Microsoft claims a
similar win.

In the meantime, and perhaps still in Windows 95 to a lesser degree,
you need to watch the number of resources that you have open
simultaneously.  In aclwin, this means that you should call CLOSE on
any windows, menus, and pixmap-handles (as returned by open-texture)
that you are no longer using.  Note that closing a menu does not close
its submenus (since those submenus could be used by other menus as
well), and closing a window does not close its menubar.  Closing a
window DOES cloes it subwindows automatically.  Any other resources
that you create via the Windows API directly should be destroyed via
the usual Windows API conventions before lisp is exited.

Another "resource" that can run out is conventional memory (the first
640K of RAM).  Windows 3.1 itself uses the majority of the available
conventional memory, and each 16-bit windows program uses a small
amount also (in addition to any DOS TSR's that are running).  Many
applications will report that they cannot start up due to
"insufficient memory" when there is not enough conventional memory, no
matter how much physical and virtual memory you have.  Windows 95 will
remedy this situation since Windows itself will no longer use any
conventional memory, and neither will 32-bit applications running in
it.

To find apps that may be using conventional memory, be sure to check
not only your c:\autoexec.bat and c:\config.sys files, but also the
LOAD= and RUN= lines of your c:\windows\win.ini file.  One Franz
hacker had this conventional memory problem on his home machine until
finally removing various things from these files that were loaded up
by Norton Desktop for Windows.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I start up lisp, I get an error box that mentions a GROWSTUB
error in pointer.dll.  When I exit the error box, lisp proceeds to run
OK, but how can I avoid this error notification?

A) This is a bug in version 9 of the driver for the Microsoft mouse,
and occurs with other 32-bit applications as well (which use Win32s).
If you remove the reference to POINTER.EXE from the RUN= or LOAD=
entry in your WIN.INI file (or possibly in your autoexec.bat file),
then the problem will not occur.  You will still be able to use the
mouse, but not have certain extra features provided by this mouse
program, such as mouse trails (often used with laptops to make the
mouse more noticable) and alternate mouse sizes.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I try to exit Windows while lisp is running, and I tell lisp
when it prompts that it's OK, lisp will then exit but not Windows.

A) We have a pending patch for this that we can send on request.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I recently upgraded from NT 3.1 to NT 3.5, and am having a problem
with strange lisp crashes when bringing up particular dialog windows.
In particular, the interface builder's menu dialog crashes lisp when
invoked under NT 3.5.  Do you know what the problem is here?

A) It seems that this is due to an incompatibility between the
third-party set of widgets that we use in order to get 3D border
effects and the new 3.5 version of NT.

For the near future, you may need to use the standard 2D widgets that
are built into Windows (and NT).  The simplest and safest way to do
this is to put the form (setq cg:*use-winwidgets* nil) in your
startup.lsp file or early in the loading of your application.
Unfortunately, this will make all widgets in the system lose their 3D
appearance.  Alternately, if you find that only particular widgets (or
dialogs) cause a problem, you can use the built-in Windows 2D widgets
selectively by specifying ":3d-border-p NIL" when calling
make-dialog-item for the particular problematic widgets.  This
approach may be riskier though.  Another possibility is that we
get an updated version of the third-party widget set that may
fix this.  We will post any change of status regarding this.

It is our understanding that when Windows 95 becomes a product that it
will include DLL's that implement 3D versions of all of the standard
widgets that are in aclwin thus far (plus additional ones), and that
these DLL's will be redistributable with applications (such as aclwin
and your application) that run on Windows 3.1 and up.  So we should be
able to distribute a robust and Windows 3.1-capable 3D version of our
product after that (whenever we decide this is appropriate).  In the
meantime, 2D may need to suffice in NT 3.5 (and also for particular
widgets, especally combo-boxes, that may be buggy in their 3d version
even in other versions of Windows).
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I've been getting some strange crashes when running aclwin 2.0
under NT.  The aclxdump.txt file that is generated shows the
following sort of stack backtrace:

CLASS-OF
FIND-APPLICABLE-METHOD-INFO
FIND-APPLICABLE-METHOD-INFO
FIND-APPLICABLE-METHOD-INFO
EVENT
WINDOW-PROCEDURE

A) We have found a bug that caused this in a post-2.0 aclwin
image.  We haven't seen it happen in 2.0 itself, but if it
does then we can provide a patch for it.
---------------------------------------------------------------------------


----------------------------------------------------------------------
Q) When trying to start aclwin, I sometimes get the error
"WIDGE32.DLL could not be loaded".

A) This is probably due to insufficient virtual memory remaining, and
could be remedied either by closing some other Windows application or
by making a larger permanent swap file.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I could use aclpc 1.0 as my Windows 3.1 shell in place of program
manager, but this doesn't work with aclwin 2.0.  Why not?

A) It appears that only 16-bit applications can be used as the Windows
3.1 shell, since we notice that the 16-bit game "Minesweeper" works
but the 32-bit game "FreeCell" (which comes with Win32s) does not.
Perhaps win32s is not yet initialized as needed when Windows starts
up, or is otherwise incompatible.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I notice that aclwin 2.0 still requires short "8.3" filenames.
Is there a patch for this?

A) We have an experimental patch to allow long filenames for aclwin
2.0 that we can provide on request via anonymous ftp
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I'm trying to open a file and getting "DOS Error -1".  What does
this mean?

A) This can happen if you try to open a read-only file for writing, or
if you try to open a file for writing when that file is already open.
A file can be left open, for example, if a break occurs while loading
the file, and the associated debugger window is left open, since the
stack has not yet unwound to close the file).
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I try to start up aclwin, I get the error "Image Loading 
Failed".  What does this indicate?

A) This can happen if you do not have enough swap space on your PC.
You should use the Control Panel to set up a permanent swap file
of sufficient size.
----------------------------------------------------------------------


2.3: Garbage collector
----------------------

----------------------------------------------------------------------
Q) What kind of garbage collection does aclwin have?

A) Generation scavenging
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I configure the garbage collector?

A) You can configure the garbage collector by modifying variables in the
allegro.ini file.  Typically, the default values are satisfactory,
though a large application may need to increase the heap size.

Here are the meanings of the variables:

HeapSize             the requested size of the Lisp process

GC_Space             the portion of memory that must be free in 
                     the newest generation after a gc

No_of_Generations    the number of generations 

Promote_After_GCs    the number of gc's experienced by an object
                     at a generation level before the object
                     is promoted to the next level

GCs_Per_Generation
Dynamic_GC
Explicit_GC          the factors which control the circumstances
                     under which the garbage collector runs over
                     objects in the various levels of the
                     garbage collection scheme
----------------------------------------------------------------------


2.4: Printer issues
------------------

----------------------------------------------------------------------
Q) Can I draw graphics directly onto a printer?

A) You can open a printer stream just as you would a window:

(setq my-printer-stream (open-stream 'printer 'null-location :output))

You can then draw lines and strings, etc on this stream just as you
would on a window.

A couple of special considerations for a printer stream:
Call (new-page my-printer-stream) to advance to the next page.
Call (close my-printer-stream) to make the job actually print.

A remaining problem is that copy-stream-area and copy-pixels-to-stream
don't work to transfer bitmaps to the printer; nothing appears in this
case.  We've looked into that bug briefly and have no idea at this
point what the bug is.
UPDATE: Actually copy-pixels-to-stream does work if you first pass
your pixmap and texture-info to open-texture and then pass the
returned bitmap handle to copy-pixels-to-stream.  Be sure to call
close-texture on the bitmap handle when you are done with it (though
this would otherwise be done at lisp exit).  We will add a method to
copy-pixels-to-stream so that this exception is handled automatically.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Can I copy the contents of windows to the printer?

A) To copy the contents of a text-edit-pane or text-edit-window to the 
printer, just use (:print window) or the Print item from the File
menu.

To programmatically copy the contents of a bitmap-pane or window to
the printer, we don't have a direct way of doing this in aclpc.  You
can use standard Windows functionality to copy the screen bitmap to
the Windows clipboard by pressing the PrintScrn key, or copy the
contents of the selected top-level window only by pressing
Alt-PrintScrn.  You can then use another application such as
Paintbrush to grab the bitmap from the clipboard and print it.

You can use new 2.0 functions to copy the contents of a graphics
window into a lisp pixmap array (look up get-pixels), and then save
the lisp pixmap to a .bmp file (look up save-pixmap) for importing
into other applications.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I draw text on the printer with the same font size as a
window?

A) Here's an example showing how the function stream-units-per-inch
can be used to print a string in various sizes on both a bitmap-window
and the printer, drawing a box around each string.

(defun foo ()
   (let* ((printer (open-stream 'printer *screen* :output))
          (window (open-stream 'bitmap-window *lisp-main-window* :io
                     :window-interior (make-box 50 50 600 400)))
          top bottom box
          (string "abcdefhijklmnop")
          pixels-per-inch size-in-pixels)
      (dolist (stream (list printer window))
         (setq pixels-per-inch (stream-units-per-inch stream))
         (setq top (floor pixels-per-inch 2))
         (dolist (size-in-inches '(.1666 .3333 .5 1))
            (setq size-in-pixels (round (* size-in-inches
                                           pixels-per-inch)))
            (set-font stream (make-font nil :arial size-in-pixels))
            (setq bottom (+ top size-in-pixels))
            (setq box (make-box pixels-per-inch top
                         (* pixels-per-inch 4) bottom))
            (draw-string-in-box stream string 0 (length string)
               box :center :center nil)
            (draw-box stream box)
            (setq top bottom)))
      (close printer))) ;; Force printer output
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I pop up the "printer setup" dialog?

A) (:page-setup *screen*)
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Can I set the "printer setup" parameters programmatically?

A) You can't do this currently.  We have an RFE for this.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Can I pop up the "printer dialog" for specifying which pages to
print, number of copies, etc.?

A) This is not implemented in aclpc, but could be using the
3.1 common dialog that you get by calling PrintDLG.
----------------------------------------------------------------------


2.5: Programming Tools
----------------------

----------------------------------------------------------------------
Q) When I pop up the find-in-file dialog after having added some
directories to choose from, saved preferences, and restarted lisp with 
those preferences.  It gets confused about the current directory in
the directory browser list box or else breaks.  Is this a bug?

A) Yes, this is a bug in aclwin 2.0.  We have a potential patch for it
that you can ask for.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What's a typical sequence of steps for doing profiling?

A) Typical interactive sequence:

(profile top::top-read-eval-print) ;; To include total cpu time
(profile foo)
(profile bar)
*** run test code here ;; collect time for foo and bar
(profile-results)      ;; show the results
(profile-reset)        ;; set times back to zero
*** run test code here ;; test again
(profile-results)
(unprofile)            ;; stop profiling after all tests
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Error handling: How can I handle particular errors myself rather
than breaking?

A) Bind allegro:*error-hook* to call a different error handler.

Example of an ignore-errors macro:

(defun ignoring-error-handler 
       (continue-format error-format args)
    (unwind-stack nil 'error nil))

(defmacro ignore-errors (&body forms)
	; Returns nil if an error occurs.
	; Unlike cltl2 version of "ignore-errors", 
        ;does not return any info
	; about the type of error that occurred.
	`(let ((*error-hook* #'ignoring-error-handler))
	    (errorset
	       (progn ,@forms))))

OR ask pc-support@franz.com about the common lisp condition system,
which we now have in aclwin 2.0 but have not documented.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) There's no defsystem facility in aclwin.  Can I get one anywhere?

A) Aclwin 2.0 does not include a defsystem package.  There are,
however, public domain (or at least freely available) versions of
these packages available in the AI repository.  We have reports that
several people have succeeded in getting these packages to run.  We
hope to be able to include such packages in the future.

The /user/ai/new/ directory also contains contributed code called
"Define-System".  The description of this is that it is a simple
portable system definition facility for Common Lisp.  This software
comes from Francis Leboutte (leboutte@mail.interpac.be), an
independant developer working at Tractebel Energy Engineering.

  Here is some info on the AI repository:

   The Common Lisp Repository is accessible by anonymous ftp to
      ftp.cs.cmu.edu:/user/ai/lang/lisp/ [128.2.206.173]
   or through the AFS directory
      /afs/cs.cmu.edu/project/ai-repository/ai/lang/lisp/
   and includes more than 250 megabytes of sources, including all
   freely distributable implementations and many programs. This
   repository supersedes the Lisp Utilities collection.

   Programs in the repository include XREF (portable cross referencing
   tool for Lisp, similar to the Symbolics Who-Calls and the Xerox
   MasterScope programs), Brad Miller's initializations package for
   Allegro CL 4.0, DEFSYSTEM (portable system definition facility, a
   "Make" for Lisp), a portable implementation of the X3J13 June 1989
   specification for logical pathnames, METERING (a portable code
   time/space profiling tool), SOURCE-COMPARE (a portable "diff"
   utility [...]
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I have written my own macros that I use to define functions,
classes, or variables rather than using defun, defvar, and defclass.
This works fine except that find-definition will not find the
definitions that I define using these macros.  What can I do?

A) There is a "defdefiner" facility that allows you to tell
find-definition about custom definer macros such as yours.
Defdefiner is itself a macro that does not evalutate its arguments.

(top:defdefiner definer-symbol type &optional full-name-extractor)   [macro]

definer-symbol   this unevaluated argument is the name of your
definer, such as my-defclass

type   the type of thing that your definer defines.  May be
one of (function variable class).

full-name-extractor   a function that specifies how to derive
the name of the thing being defined from its defining form.  It
defaults to SECOND, since for example "foo" is returned by calling
SECOND on the form (defclass foo ...).  This default will probably
suffice in most cases.

Example:
To have find-definition locate source code for classes that were
defined with a macro call my-defclass (which you have written),
use this form:

(top:defdefiner my-defclass class)
----------------------------------------------------------------------


Section 3. ADD-ON PRODUCTS/FEATURES
===================================

3.1: Common Graphics
--------------------

----------------------------------------------------------------------
Q) How come the "event" method isn't invoked for widgets/dialog-items? 

A) The Windows operating system sends messages when various window
events occur, and aclwin invokes the EVENT generic function for some
of these events (basically for mouse and keyboard input), and other
generic functions for other messages.  We don't get these messages for
the built-in widgets, though, and so can't invoke the corresponding
common graphics generic function for them.  Here's why: Windows sends
these event messages to the "window procedure" that is set up for each
class of window that is registered in Windows.  Most windows in aclwin
are registered by aclwin, which sets up the generic function
PC::WINDOW-PROCEDURE to receive the messages.  The built-in widgets
(aka dialog-items and controls), on the other hand, are predefined in
the Windows operating system, and so the event messages are handled
inside the window procedure that Windows itself uses for these
windows, and so aclwin does not get the standard low-level event
messages at all.  What does happen is that the particular widgets
process these low-level event messages and then send a smaller set of
higher-level messages to the dialog window in which the widget lives.
The dialog window is defined by aclwin and so aclwin receives these
messages and uses them to call corresponding widget functions like
dialog-item-set-value-fn and set-item-kill-focus-fn.  So that's why
there's a different system of event handling functionality for widgets
as opposed to regular windows in aclwin.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I send messages to the windows of other applications?

A) For toplevel windows, you can get the handle easily from the title
of the window (or just the first part of the title, I think) using the
Windows API function win:FindWindow.  Then you can use other Windows
API functions (including SendMessage) to send messages to that handle.
This simple example will expose the program manager:

(win:SetActiveWindow (win:FindWindow ct:null "Program Manager" :static)

Ask about [pcspr258] for ideas on finding launched applications
without using window titles, and on finding non-toplevel windows of
other applications.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How come widgets won't display colors that the dialog window will?

A) The dialog background is able to dither pixels drawn in the 20
system colors to appear to produce other colors.  While certain areas
such as window backgrounds can do such dithering, other areas such as
certain parts of widgets aren't able to.  To avoid dithering
altogether, use the procedure for getting 256 pure colors rather than
just the 20 system colors (see below).
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Why can I only get 16 or 20 colors, when I'm trying to display up
to 256?

A) There are two requirements to keep in mind:

(1) To get more than the standard 16 VGA colors, you must run Windows
in 256-color mode by doing this:

Run the "Windows Setup" application.
Select the "Options" menu
Select the "Change System Settings" menu item
Change the "Display" item to a driver with 256 colors

(2) To get more than the 20 Windows "system colors", you must set up a
palette in aclpc and use color indeces into the palette rather than
using RGB color structures directly.  This is a design feature of
Windows.  Look up "palettes" in the common graphics reference.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I use copy-pixels-to-stream, the colors aren't mapped
correctly even though I pass the texture-info (which contains the
correct colormap) that was returned by load-pixmap.  Why?

A) When using copy-pixels-to-stream you need to first copy the palette 
(if one is used) from the texture-info to the destination window, as
in the following code:

(multiple-value-setq (pixmap texture-info)
  (load-pixmap "c:\\foo.bmp"))
(setq box (make-box 0 0 (texture-info-width texture-info)
                        (texture-info-height texture-info)))
(set-palette my-window
  (open-palette *screen* (texture-info-colors texture-info) nil))
(copy-pixels-to-stream my-window pixmap texture-info box box replace)

This is a difference from copy-pixels-to-stream-FROM-FILE, since that
function DOES copy the palette from the pixmap file to the destination
window --- that's necessary, though, since there's no intermediate
step where the user could copy the palette over explicitly.
Copy-pixels-to-stream doesn't likewise copy the palette over
automatically in case the user knows that they are using a single
master palette with multiple copy-pixels-to-stream calls, in which
case it is more efficient to not reset the palette for each call to
copy-pixels-to-stream.  (Open-palette in particular would be expensive
to call multiple times unnecessarily.)
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I'm confused about the difference between pixel-maps, pixmaps,
textures, and texture-infos.  How do I construct these for
passing to copy-pixels-to-stream or for setting the picture
of a picture-button widget without using a filename?

A) Actually, the terms "texture", "pixel-map", and "pixmap" all refer
to the same thing, which is simply a 2D array (with the proper byte 
element type) used to denote the individual pixels of a pixel-map,
while a texture-INFO is a structure providing auxilliary information
about the pixmap such as the width, height, bits-per-pixel, and
colormap to use.

Typically you can get both a pixmap and a texture-info that works with
it as the multiple values returned by such functions as load-pixmap
and get-pixels, and so you don't have to construct the pixel array or
the components of the texture-info yourself.  If you do create your
own texture-info, be sure to supply the colormap, which is a vector of
rgb's that must be at least as long as the highest pixel value in the
pixmap.  A pixmap can be created from scratch with make-pixel-map.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When drawing using the cg:invert operation to "logxor" pixel values,
sometimes colors automatically invert to intuitive colors, and
sometimes not.  Why?

A) Basically the 16 standard VGA colors will xor (reverse) intuitively
due to their special positions in the system colormap; Windows places
half of these colors in the bottom 8 slots of the system colormap, and 
the other 8 to which these intuitively invert to in the top 8 slots.
Other colors will xor arbitrarily according to whatever color is at the
colormap index that results from the xor operation; this is how
xoring works in most any other graphics system.  If you want to control
what each color xor's to, you need to control the positions of the
various colors in your user-defined palette.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When another application changes the system palette, how can I
detect this and re-realize my own palettes? 

A) Aclwin currently doesn't process the WM_PaletteChanged and
WM_QueryNewPalette messages that tell us when the system palette has
changed.  We have a potential patch to implement this, which you could
ask for.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I want to pop up a pop-up dialog and have the input focus be
initially on a particular widget in that dialog, but the focus always
seems to be on a particular arbitrary widget rather than the one to
which I set focus just before calling pop-up-dialog.  What do I do?

A) The problem here is that you can't actually focus on a window while 
its parent is not activated, and once a pop-up dialog is activated by
popping it up, you no longer have programmatic control in order to do
something like focussing on a widget.  Here's a workaround that you
can use:

(select-window dialog)
(set-focus (dialog-item-window widget))
(pop-up-dialog dialog)
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I have one modal (pop-up) dialog invoke a second modal
dialog, so that the user can't mouse widgets on the first while the
second is on the screen?

A) You can get a second modal dialog just by passing the first dialog
as the optional second arg to pop-up-dialog when popping up the second
dialog.  Seems the first dialog needs to be the parent of the second
also, in order for the first to not disappear when popping up the
second.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I have one window on top of another one without the window
on top moving when the other window is scrolled?

A) Define the bring-window-to-front method of the scrolling pane to do
nothing.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How come no "character" events are coming into the event method?

A) If you have defined an event method that receives the
virtual-key-down event, then you must (call-next-method) when the
virtual-key-down event is handled, or else aclpc will not do the
TranslateMessage call that generates a "character" event from the
virutal-key-down event.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) What do I do if when trying to create a bitmap-window I get this
error? 

;;;; ERROR: Error creating a memory bitmap of size 632
by 453; likely not enough available memory.

A) This error occurs when there is not enough available memory to
create the backing-store bitmap for a bitmap-window or -pane.  The
default size of the backing-store bitmap is the page size of the
window, which defaults to the page size of the parent window.  One
probably undesirable feature new to aclwin 2.0 is that if you put a 
bitmap-window on *lisp-main-window*, the backing-store bitmap by
default will be the screen width by something like two and a half
screen heights tall, now that we added the vertical scrollbar to
*lisp-main-window* and hence its page size is much taller.

You can specify the :page-width and :page-height initargs to
open-stream when creating the bitmap-window to make the 
backing-store bitmap be a smaller size.  It is also important to
call CLOSE on any no-longer-used bitmap-windows or -panes so
that aclwin will free up their backing-store bitmaps.

Perhaps you already knew all that and there's still a problem.  One
other user said that he could create a bitmap-window just after
getting this error, even without doing a gc or closing anything.  This 
was puzzling, since that error occurs only when the Windows API
function CreateCompatibleBitmap returns NIL.  We have a potential
patch that simply returns NIL instead of breaking when this happens,
and also calls (process-pending-events) just before creating the
backing-store bitmap, in case pending messages would result in
destroying other bitmaps or other objects to make room.  If you get
this patch from us, it should either solve the problem, or at worst
you could just try calling open-stream a second time in your code
when it returns NIL to make sure that you can create a bitmap-window
whenever there is sufficient memeory, as in:

(setq win (open-stream 'bitmap-window ...))
(unless win
  (without-interrupts (print "open-stream returned NIL!"))
  (setq win (open-stream 'bitmap-window ...))
  (when win (without-interrupts (print "but worked the next time!"))
  ))

If this results in open-stream ever failing the first time and
working the second, we would definitely like to hear about it.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How do you disable a whole pull-down menu on a menu bar, as opposed
to disabling a menu item?
     
A) Each of the pull-down menus is actually a menu-item of the menu bar
itself.  So to disable the second pull-down menu of the menu-bar of
foo-window, you could say:

(set-menu-item-available-p
  (second (menu-items (window-menu foo-window))) nil)

That will gray out the menu title and make it disabled.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I add a menubar to a pop-up dialog, there's a gap along the
bottom of the title bar where a few rows of background pixels show
through.  Why?

A) This happens when there's a menubar and the :window-border arg to
open-stream is :dialog-box, which is the default for pop-up dialogs.
Try adding ":window-border :frame" to your call to open-dialog.

Our only guess as to why this happens is that when you specify the
:dialog-box border style, which asks windows to use a thick border
even though it's not for resizing, that Windows still draws the menu
bar where it would if the border were not thick.  Perhaps Microsoft
hasn't caught this since pop-up dialogs don't usually have menubars.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I have a non-delayed text widget and reject certain typed
characters in my set-value-fn, it moves the cursor back to the start.
How can I keep the text cursor where it was before the invalid
character was typed?

A) This is more complex than it sounds.  Ask us about [pcspr948] if
this is a problem for you.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I get a stack overflow when I return NIL from the set-value-fn of
my radio buttons.  What do I do?

You should avoid doing this, though we apologize that lisp can
crash if you inadvertently do it anyway.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I optionally prevent a user from closing a window?

A) Write a user-close method for your class (or perhaps an :around for
an existing class), which for example asks the user if it's ok to
close the window; if so, then (call-next-method), otherwise just exit
from the user-close so that the default one doesn't get called to
actually close the window.

If you want to hide the window without closing (destroying) it, so
that you can simply re-show it later rather than (more slowly)
recreating it, then you can just call (shrink-window window t) 
in your user-close method to make the window invisible.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How are the default-button and cancel-button different from regular
buttons?

A) The thing that distinguishes these buttons is that pressing ENTER
while the input focus is in a dialog will invoke the default-button's
set-value-fn, while pressing ESC invokes the cancel-button's
set-value-fn.  Other than that they work just like other buttons; if
it's on a pop-up dialog and you want a button to exit the dialog, have
its set-value-fn return a second value of T (as with any widget).  The
default set-value-fns work a bit differently in that they do a throw
in order to enable the default-button to return t and the cancel
button to return NIL from pop-up-dialog, so that you don't have to
check the value of some widget on the dialog in order to determine
what the user has chosen in simple cases such as OK / cancel.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I often notice that the button with the thick border is not really
the "default button" that is invoked when the user presses ENTER.
Also, I would like to be able to change the acting default-button
programmatically.

A) We have a patch for this, for which we can send you source code.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How come setting the background color of a widget to NIL makes it
draw with a light-gray background rather than the system window
background color?

A) The emerging de facto 3D-border standard requires that the
background of a widget be light-gray in order for 3D effect to work.
Perhaps a patch could be made so that widgets that don't use a 3D
border could still use the system background color.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) The font selector Common Dialog shows only true type fonts.

A) This happens when controlpanel-->fonts-->truetype has the
checkbox selected to "use only TrueType fonts in applications".
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) The tabbing order of widgets differed from what I had expected.
What can I do about this?

A) Both the tab order and the occlussion order (which widget appears in
front of which when they overlap) are determined by the order of the
widgets in the list that you pass to open-dilaog.

Builder:tab-position and builder:set-tab-position can be used to see
and change the tab position of a particular widget.  Perhaps those
should be cg functions; right now they're exported from builder,
assuming that users would not want to be switching tab order around at
runtime.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When an object that's shown in a list widget or combo-box changes
in such a way that it should print differently in the widget (such as
when a :key is used) even though the same lisp objects are in the
widget's range, how do you make the widget redisplay properly?

A) The problem is that the displayed string is cached over in the
Windows world, and lisp doesn't know to remap its value to a new
displayed string.  To make this happen, you can call:

(pc::update-dialog-item-key widget)

We should export this function name from the CG package in the future.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I programmatically set the value of a combo box (or list
widget), it doesn't display the choice, though it works just fine when
I set the value by choosing an option with the mouse.  Why?

A) Typically the problem here is that the range of the combo-box
contains values such as strings or lists, for which the default 
value-equality-test of EQL fails.  The value-equality-test of a widget
is EQL by default, and when you set the value of a list or combo
widget, it uses that test function to find the value in the range to
highlight (or display in the text area of a combo-box).  To fix this,
you can either (setf (value-equality-test widget) #'equal) or put
atoms into the range and use a :key function to display the atoms as
appropriate strings.  You can also establish the value-equality-test
with the :value-equality-test initarg.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I select all the text in a 3D text-widget and hit backspace,
lisp doesn't realize that the value has changed.

A) This is a bug in the third party widgets (WinWidgets) that we use
in order to get 3D borders, and we aren't able to fix it.  You would
need to turn off the 3D border in order to avoid the bug, as this will
use the regular Windows 3.1 edit control instead of WinWidget's
version.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How do I use a transparent background color for the text on a
window? 

A) Common graphics in 2.0 doesn't have a hook into this particular
Windows functionality, but we have patch to provide this that we can
send.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How does the double click work on a single-item-list widget?

A) It appears that dialog-item-double-click-fn isn't in the 2.0
manual.

List widgets can have a double click attribute similar to the
set-value-fn attribute.  It can be set by passing the :double-click-fn
initarg to make-dialog-item, or by using the setf of
dialog-item-double-click-fn.  The value should be a function (or the
name of a function) that takes two arguments: the dialog window that
the list widget is on, and the list widget itself.

Note that the set-value-fn will still run for the first click of
the double click.  This is a Windows feature, and tends to work
out OK as long as the first click is used for selection, since
you normally want to do that anyway even when double-clicking.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Save-fasl-pixmap doesn't seem to work.  What do I do?

Yes, this new function was broken in the 2.0 release.  We have a
potential patch for it that you can ask for.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Can I print help messages as the user highlights various menu-items 
of a menu that they are perusing?

A) The Windows message (WM_MENUSELECT) that is passed to us at this
time is not yet handled in aclwin 2.0, but we have a potential patch
for this that you can ask for.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I position the text cursor at the end of a
text-edit-window, or otherwise ensure that output goes to the end of
the existing text? 

A) (file-position my-window :end) should do it.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Can I attach a comtab to a text-edit-pane and make RETURN process
the line that the user just typed?

A) Here's some example code to demonstrate how you might do this:

(defclass moo-pane (comtab:comtab-mixin text-edit-pane)())
(defclass moo-frame (text-edit-window) ())
(defmethod default-pane-class ((it moo-frame))
     'moo-pane)

(defparameter moo-comtab (comtab:make-comtab))

(defun moo-return (pane)
   (format t "~%You just typed ~s"
      (text-line pane (current-line-number pane)))
   (te:newline pane)
   (format pane "Insert this line of text~%")
   )

(comtab:set-event-function moo-comtab pc::vk-return
  'moo-return)

;; Try it out

(defparameter frame (open-stream 'moo-frame *lisp-main-window* :io))
(defparameter pane (frame-child frame))
(setf (comtab:comtab pane) moo-comtab)
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I move several widgets programmatically, the redisplay looks
ugly and is rather slow.  Can I make this neater and/or speed it up?

A) Here's a code snippet illustrating a technique for more neatly and
somewhat more speedily moving a set of widgets in the list MY-WIDGETS
that lie on some dialog MY-DIALOG.

      (with-delayed-redraw (my-dialog)
         (dolist (widget my-widgets)
            (setf (dialog-item-box widget) <some-new-box>)))
      (invalidate-window my-dialog)
      (dolist (widget my-widgets)
         (invalidate-window (dialog-item-window widget)))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How might one change the color of the dialog used by
pop-up-message-dialog from light-gray to white?
    
A) It isn't actually supported to change colors on these built-in
dialogs, but here is a hack that will do it.  The first setf changes
the background color of the dialog, and the second setf removes the 3D
border from the error icon static-picture widget, since the 3D effect
doesn't look right with the white background since the upper-left
white edge is not seen.  Actually you need to do the setf calls only
one time at the beginning of your application run.

(let ((msg-dialog (pc::msg-dialog *screen*)))
   (setf (background-color msg-dialog) white)
   (setf (slot-value (fifth (dialog-items msg-dialog)) 'cg::3d-border) nil)
   (pop-up-message-dialog *screen* "Test"
      "SIGNAL Versicherungen"   warning-icon  "OK"))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I use the ask-user-for-font pop-up dialog, sometimes it
returns a font which is not quite the size that I selected.  In fact,
it can even return a different size than I passed in when I don't
change the font at all on the dialog.  Do you have a fix for this?

A) We have a pending patch for this that we could send on request.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Do you have a "tooltips" facility, for popping up little help
windows beside widgets when the mouse pauses over them?

A) Yes, we do have such a facility now that we could send you
source code for.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I created a window subclass and added some slots to it, but when
I inspect an instance of this class the inspector window doesn't show
my new slots.  How can I view all the slots?

A) While there is an inspect-object method for standard-object to show
all the slots of a clos object, this method is overridden for some
classes such as windows.  If you would like to see all of the slots
for any clos class, you could define the following method for that
class in order to give it the default inspector behavior for clos
instances:

(defmethod insp:inspect-object ((object any-class) windup-fn)
  (insp:inspect-clos-object object windup-fn #'true
    (class-slots (class-of object)) nil))

Alternately, you could use the method browser to view all of the
insp:inspect-object methods and remove the methods for clos classes
for which you would like to see all slots.  (You would need to remove
methods for their superclasses also.)
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) The DELETE key seems to do nothing instead of deleting a single
character when pressed in a single-line text widget when there is
no text selected.  What's the deal?

A) This was an embarrassingly obvious bug, fixable with this small
patch:

(in-package :pc)
(defun text-widget-delete-selection (widget-window)
   (SendMessage (window-handle widget-window)
    WM_KEYDOWN vk-delete 0 :static))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I'm running out of Windows resources and memory when I call
copy-pixels-to-stream-from-file a lot, even though I'm closing the
bitmap-pane that it creates each time.

A) The problem is likely that palettes are getting created and not
destroyed.  When you call copy-pixels-to-stream-from-file and don't
pass in a bitmap-pane, it creates a palette for the colors of the
loaded pixmap and assigns it to the bitmap-pane.  In general in Common
Graphics, when you close a window it doesn't close the palette
assigned to the window, since that palette may be used elsewhere (or
you may intend to use it elsewhere even if it's not currently assigned
to any window).  So you have to close the palette yourself.

One small consideration is that you probably shouldn't call
close-palette on a palette that is still assigned to a window.  (This
is according to Windows API documentation, though I tried and didn't
notice a problem.)  But to be safe, if you're closing a window and
know that you don't need its palette any longer, you should first
get its palette by calling (palette my-window), then close the
window (which removes its palette but doesn't close it), then
call close-palette on the palette.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) If I call either move-window or move-window-behind on an iconized
window, the text below the icon stays where it was.  Is there a fix?

A) We have a patch for this available on request.
----------------------------------------------------------------------


3.2: Foreign-function interface
-------------------------------

----------------------------------------------------------------------
Q) Can you give me an example of passing a callback function to
Windows?

A) Here's an example of writing code at the Windows API level and
passing a callback function to Windows.  Windows calls the callback
once for each window of a set of windows that comprise the answer, and
we push each one onto a list.

;; Retrieves a list of window handles for some Windows task.

(defvar *task-windows* nil)

(ct:defun-callback collect-them
 ((window-handle ct:shandle)
  (user-data ct:long))
 (push window-handle *task-windows*)
 t) ; return TRUE to continue?

(defun task-windows (task-handle)
   (setq *task-windows* nil)
   (win:EnumTaskWindows task-handle
    (ct:get-callback-procinst 'collect-them)
    0)
   *task-windows*)

;; Test it
(task-windows (win:GetCurrentTask))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Is the example code in the ex/ffi32 directory generally applicable?

A) The declaration of a callback function on the C side needs to
specify that the function is a WINAPI type function.

The ex/ffi32 code only works because of a coincidence.  If the c
function as written made more than one call to the callback before
returning, then the test would fail, probably by crashing the lisp.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Do you have a DDE interface on top of the low-level Windows API for
DDE?

A) We have a general clossified DDE facility that was completed
shortly after the release of aclwin 2.0, and which we are currently
packaging up to post for any 2.0 users.  In the meantime, we can send
the source by email if you ask us for it.  We have also added support
for DDE "Poke" messages in January 1995 for those who received this
earlier.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I find the DDE commands that are available in the Program
Manager?

A) I noticed that the Win32 API WinHelp file has this under
contents-->application notes-->shell dde interface (in case you have
the Windows Software Development Kit).
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) Do you have a high-level interface into the MCI multimedia
functionality?

A) We have a preliminary CLOSsified MCI interface that currently
allows you to play .WAV sound files, audio CD, MIDI files, and .AVI
animation files (assuming that you have an .AVI driver), and to record
.WAV files, with various options such as playing from and to specified
points and querrying the capabilities and current status of multimedia
objects.

Here's a simple example that plays a .WAV file:

(setq wav (make-instance 'mci-wave-audio))
(mci-open wav :element-filename "c:\\windows\\tada.wav")
(mci-play wav :wait-p t)
(mci-close wav)

We plan to post this facility, but in the meantime we can send
the source by email if you ask us for it.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I'm trying to make foreign function calls into a 16-bit DLL, and
get the errors "The procedure entry point UTRegister could not be
located in the dynamic link library kernel32.dll" and "Error: Could
not load module ACLGUT32.DLL".  What am I doing wrong?

A) In aclwin 2.0 the foreign function interface default has changed
to 32-bit from 16-bit, so to call functions in a 16-bit DLL you now
need to pass ":16-bit t" and ":call-mode :pascal" to defun-dll.
----------------------------------------------------------------------


3.3. Runtime
------------

----------------------------------------------------------------------
Q) Do you have an example of a complete runtime application, with
a menu bar and a dialog window even?

A) The three files EX\RUNTIME\COLORxxx.LSP (in the ACL for Windows
package example directory) comprise such an example.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) How can I prevent the user from running multiple instances of my
runtime application?

A) Here's a sample runtime entry function that does this (this 
example was fixed June 1995):

(defun enter-here ()
   (let ((previous-instance (win:FindWindow ct:null "My Application"
                             :static)))
      (if (ct:null-handle-p :long-handle previous-instance)
         ;; No other application with a top-level window having
         ;; the name that we use for our application
         ;; is running, so do the usual top-level runtime stuff
         (let ((main-window (open-stream 'frame-window *screen* :io
                               :title "My Application")))
            (do ()
                ((closed-stream-p main-window))
               ;; Our application runs here
               (process-pending-events)))
         ;; An instance of our application is already running, so
         ;; expose the running instance and exit
         (unless (ct:null-handle-p :long-handle previous-instance)
            (win:SetActiveWindow previous-instance)))))
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I'm using an exported and documented function that doesn't exist
in the runtime image, but I need it for my runtime application.
What can I do?

A) Some users have noted that the following functions do not
exist in runtime:  pop-up-find-dialog pop-up-string-dialog
ask-user-for-string pop-up-color-dialog choose-default-printer
ask-user-for-choice-from-list files-to-list-box and :page-setup.
The files that implement these functions were inadvertantly
excluded from runtime in the interest of keeping it small,
but we can send patches for these or other documented functions
if you need to use them in a runtime application.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I would like to associate my own icon with the (renamed) lisp.exe
file that I ship with my product, and would like this icon to be used
automatically when the user makes a program manager item from the
lisp.exe file, rather than forcing the end user to tell the program
manager to associate an arbitrary icon with my program.

A) We now have a reasonable piece of code that we can send that lets
you copy the lisp.exe file, embedding any .ico icon file of your
choice into it so that program manager will display it by default.
----------------------------------------------------------------------


3.4 Editor
----------
----------------------------------------------------------------------
Q) Can you give me some examples of defining keystroke behavior with
comtabs (command tables), for use in lisp editor windows?

A) Simple example:
-----------------
(comtab::set-event-function top::*toploop-comtab*
 '((control-key #\J))
 #'(lambda (stream)(clear-page stream)))

A multi-keystroke binding:
(comtab::set-event-function te::*host-comtab*
 '((control-key #\X)(control-key #\A))
 #'(lambda (stream)(print :foo stream)))

The 2.0 documentation says that the character names must be uppercase,
but due to this being a common user oversight we removed this
restriction at the last minute, and so the character name is
case-insensitive.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) When I use make-mark to add my own marks to a text-edit window
and later use file-position to return the cursor to these marks,
I find that the positions of the marks have not been updated
appropriately as text is inserted and deleted before the marks.

A) We have a pending patch for this that we can send on request.
----------------------------------------------------------------------


----------------------------------------------------------------------
Q) I'm using text-edit-windows in my runtime application along with
the functions te:load-file and te:save-file, and notice that these
two functions always put a "Package FOO" string in the title bar,
which is not appropriate.  Can I customize this some way?

A) We have a pending patch that we can send on request.  It leaves
the package reference in lisp-edit-windows but not
text-edit-windows, and also defines the new generic function
te:editor-window-title which you can use to customize the title
strings in your application's editor windows.
----------------------------------------------------------------------


